"use strict";const s=require("../common/vendor.js"),e=require("../utils/request.js");s.defineStore("chat",{state:()=>({sessions:[],activeSessionId:"default",messageMap:{}}),getters:{activeSession:s=>s.sessions.find((e=>e.id===s.activeSessionId))||null,messages:s=>s.messageMap[s.activeSessionId]||[]},actions:{ensureSession(s=this.activeSessionId){this.sessions.find((e=>e.id===s))||(this.sessions=[...this.sessions,{id:s,title:"粤风AI助手"}]),this.messageMap[s]||(this.messageMap[s]=[])},setSessions(s){this.sessions=s},setActiveSession(s){this.activeSessionId=s},upsertMessages(s,e){this.messageMap[s]=e},async sendMessage({content:s}){const t=this.activeSessionId||"default";this.ensureSession(t);const i={role:"user",content:s,timestamp:Date.now()},a=[...this.messageMap[t]||[]];a.push(i),this.messageMap[t]=a;const n={role:"assistant",content:"",timestamp:Date.now()},o=[...this.messageMap[t]],m=o.length;o.push(n),this.messageMap[t]=o;const c=e.chatStream({url:"/chat/send",method:"POST",body:{model:"qwen3-max",modelName:"qwen3-max",messages:this.messageMap[t].map((s=>({role:s.role,content:s.content}))),stream:!0}},(s=>{n.content+=s;const e=[...this.messageMap[t]];e[m]={...n},this.messageMap[t]=e}),(s=>{n.content+="\n[错误] "+((null==s?void 0:s.message)||s);const e=[...this.messageMap[t]];e[m]={...n},this.messageMap[t]=e}),(()=>{}));this._cancel=c}}});
