"use strict";const t=require("../common/vendor.js"),e=require("./config.js");const r=function(r={}){return function(o){const{url:n,method:s="GET",data:c={},header:a={}}=o;return new Promise(((o,i)=>{t.index.request({url:n.startsWith("http")?n:e.BASE_URL+n,method:s,data:c,header:{"Content-Type":"application/json",...r.header,...a},success:t=>{console.log("请求成功:",t.data),o(t.data)},fail:t=>{console.error("请求失败:",t),i(t)}})}))}}();exports.chatStream=function(r,o=(()=>{}),n=(()=>{}),s=(()=>{})){let c=!1;try{try{"string"==typeof e.WS_URL&&/^ws:\/\//i.test(e.WS_URL)&&console.warn("当前为 ws://，小程序需使用 wss:// 且配置合法域名:",e.WS_URL)}catch(a){}const i=t.index.connectSocket({url:e.WS_URL,protocols:[],tcpNoDelay:!0});let l=!1;return i.onOpen((()=>{l=!0;try{i.send({data:JSON.stringify(r)})}catch(a){s&&s(a)}})),i.onMessage((t=>{if(!c)try{const e=(null==t?void 0:t.data)??"";if(!e)return;if("[DONE]"===e)return void(n&&n());o&&o(String(e))}catch(e){s&&s(e)}})),i.onError((t=>{c||s&&s(t)})),i.onClose((()=>{c||n&&n()})),()=>{var t;c=!0;try{null==(t=null==i?void 0:i.close)||t.call(i)}catch(a){}}}catch(i){s&&s(i)}return console.error("当前平台不支持流式请求（仅 H5 / 小程序）"),s(new Error("当前平台不支持流式请求（仅 H5 / 小程序）")),()=>{c=!0}},exports.request=r;
