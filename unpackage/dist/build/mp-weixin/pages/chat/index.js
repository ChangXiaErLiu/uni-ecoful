"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/request.js"),n=require("../../utils/platform.js"),a=require("../../utils/safe-area.js"),o=require("../../stores/navTitle.js");if(!Array){e.resolveComponent("uni-popup")()}Math||(u+c+s+i+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+l)();const l=()=>"../../components/layout/AppLayout.js",u=()=>"../../components/chat/ChatSidebar.js",c=()=>"../../components/chat/ChatHeader.js",s=()=>"../../components/chat/ChatMessage.js",i=()=>"../../components/chat/ChatInput.js",r={__name:"index",setup(l){const u=o.navTitleStore();e.onShow((()=>u.setTitle("环保通用AI问答")));const{isDesktop:c}=n.usePlatformInfo(),{statusBarHeightPx:s,navBarHeightPx:i,totalNavHeightPx:r}=a.useSafeArea(),v=e.ref([]),f=e.ref(""),d=e.ref(!1),m=e.ref(!1),p=e.ref(!1),h=e.ref(null),g=e.ref(null),y=e.ref(null),w=e.computed((()=>v.value.find((e=>e.id===f.value))||{id:"",title:"新对话",messages:[]})),x=e.computed((()=>w.value.messages||[]));e.ref(null);const b=e.ref(""),k=e.ref(0),T=e.ref(0),j=e.ref(!0),I=e.ref({});function _(){try{b.value="",e.nextTick$1((()=>{b.value="chat-bottom-anchor"}))}catch(t){}}function S(e){var t;try{const n=Number((null==(t=null==e?void 0:e.detail)?void 0:t.scrollTop)||0);n+30<T.value&&(j.value=!1),T.value=n,f.value&&(I.value[f.value]={top:n})}catch(n){}}function D(){j.value=!0}e.watch(c,(e=>{var t,n;if(e){p.value=!1;try{null==(n=null==(t=h.value)?void 0:t.close)||n.call(t)}catch(a){}}})),e.watch(f,((t,n)=>{try{n&&function(e){try{const t=e||f.value;if(!t)return;I.value[t]={top:Number(T.value||0)}}catch(t){}}(n)}catch(a){}e.nextTick$1((()=>function(e){try{const t=e||f.value,n=t&&I.value[t]?Number(I.value[t].top||0):null;null!=n&&n>0?(b.value="",k.value=n):j.value&&_()}catch(a){}}(t)))}));const $=()=>{var e,t,n,a;if(p.value)try{null==(t=null==(e=h.value)?void 0:e.close)||t.call(e)}catch(o){}else try{null==(a=null==(n=h.value)?void 0:n.open)||a.call(n,"left")}catch(o){}},q=()=>{var e,t;try{null==(t=null==(e=h.value)?void 0:e.close)||t.call(e)}catch(n){}},N=e=>{e&&"boolean"==typeof e.show&&(p.value=!!e.show)},A=()=>{},P=e.computed((()=>{try{return`padding-top: ${Number((null==r?void 0:r.value)||0)}px;`}catch(e){return""}}));function C(){try{v.value=[...v.value],e.index.setStorageSync("chat_conversations",JSON.stringify(v.value))}catch(t){console.error("保存对话失败:",t)}}function H(){const e=v.value.find((e=>!e.title||"新对话"===e.title||0===e.messages.length));if(e)return console.log("已有空对话，切换到:",e.id),void(f.value=e.id);const t={id:"conv_"+Date.now(),title:"新对话",createdAt:Date.now(),messages:[]};v.value.unshift(t),f.value=t.id,C(),console.log("创建新对话:",t.id)}function M(e){f.value=e}function B(){H(),q()}function J(e){M(e),q()}function O(e,t){const n=v.value.find((t=>t.id===e));n&&(n.title=t,C())}function L(e){var t;const n=v.value.findIndex((t=>t.id===e));-1!==n&&(v.value.splice(n,1),f.value===e&&(f.value=(null==(t=v.value[0])?void 0:t.id)||""),C())}async function R(n){const a=v.value.find((e=>e.id===f.value));if(!a)return;const o="string"==typeof n?n:n.content||"",l=n.attachments||[],u={id:"msg_"+Date.now(),role:"user",content:o,attachments:l,timestamp:Date.now()};a.messages.push(u),d.value=!0,a.title&&"新对话"!==a.title||(a.title=function(e=""){let t=(e||"").trim().replace(/\s/g," ");const n=t.search(/[。！？!?\.]/);n>0&&(t=t.slice(0,n));t=t.replace(/^[~#\-\s、，,。!?！?【】\[\]\(\)（）]|[~#\-\s、，,。!?！?【】\[\]\(\)（）]$/g,"");const a=10;t.length>a&&(t=t.slice(0,a)+"…");return t||"新对话"}(u.content)),C(),await e.nextTick$1(),await async function(n,a){const o={id:"msg_"+Date.now(),role:"assistant",content:"",timestamp:Date.now()};function l(e){return e.map((e=>{if("string"==typeof e.content)return{role:e.role,content:e.content.trim()};const{content:t="",attachments:n=[]}=e.content||{},a=n.length?n.map((e=>`\n[附件：${e.name||e.url}]`)).join(""):"";return{role:e.role,content:(t+a).trim()}})).filter((e=>e.content&&e.content.length>0)).slice(-30)}n.messages.push(o),C(),await e.nextTick$1();const u={model:"qwen3-max",modelName:"qwen3-max",messages:l(n.messages),stream:!0};try{let e=function(){const e=n.messages.findIndex((e=>e.id===o.id));if(-1!==e){const t=[...n.messages];t[e]={...o},n.messages=t}a=null;const t=Date.now();t-l>500&&(l=t,C())},a=null,l=0;g.value=t.chatStream(u,(t=>{o.content+=t,a||(a=setTimeout(e,80))}),(()=>{try{a&&(clearTimeout(a),a=null),e()}catch(t){}d.value=!1,g.value=null,C()}),(t=>{console.error("AI回复错误:",t),o.content+=`\n[错误] ${(null==t?void 0:t.message)||t}`;try{a&&(clearTimeout(a),a=null),e()}catch(n){}d.value=!1,g.value=null,C()}))}catch(c){console.error("生成AI回复时发生异常:",c),d.value=!1,g.value=null}}(a)}function z(){if(d.value=!1,g.value){try{g.value()}catch(e){}g.value=null}}function E(){const e=v.value.find((e=>e.id===f.value));e&&(e.messages=[],C())}function F(e,t){const n=v.value.find((e=>e.id===f.value));if(!n)return;const a=n.messages.findIndex((t=>t.id===e));-1!==a&&(n.messages[a].feedback=t,C())}function G(e,t){const n=v.value.find((e=>e.id===f.value));if(!n)return;const a=n.messages.findIndex((t=>t.id===e));-1!==a&&(n.messages[a].content=t,C())}function K(e){var t;try{null==(t=y.value)||t.setDraft((null==e?void 0:e.content)||"",(null==e?void 0:e.attachments)||[])}catch(n){console.error("回填草稿失败:",n)}}function Q(e){}return e.onMounted((()=>{!function(){var t;try{const n=e.index.getStorageSync("chat_conversations");n&&(v.value=JSON.parse(n),v.value.length>0&&(f.value=(null==(t=v.value[0])?void 0:t.id)||""))}catch(n){console.error(n)}}(),0===v.value.length?H():console.log("初始化：使用已有对话，数量:",v.value.length)})),e.watch(d,(e=>{})),e.watch(x,(()=>{e.nextTick$1((()=>{j.value&&_()}))}),{deep:!0}),e.onMounted((()=>{e.nextTick$1((()=>{j.value=!0,_()}))})),e.onUnmounted((()=>{})),(t,n)=>e.e({a:e.unref(c)},e.unref(c)?{b:e.o(H),c:e.o(M),d:e.o(O),e:e.o(L),f:e.o((e=>m.value=!m.value)),g:e.p({conversations:v.value,"current-conversation-id":f.value,collapsed:m.value}),h:e.o(A),i:e.p({conversation:w.value,"show-toggle":!1}),j:e.f(x.value,((t,n,a)=>({a:t.id||n,b:e.o(F,t.id||n),c:e.o(G,t.id||n),d:e.o(K,t.id||n),e:"992afeca-3-"+a+",992afeca-0",f:e.p({message:t})}))),k:"chat-bottom-anchor",l:e.sr(y,"992afeca-4,992afeca-0",{k:"chatInputRef"}),m:e.o(R),n:e.o(z),o:e.o(E),p:e.o(Q),q:e.p({"is-generating":d.value})}:{r:e.o($),s:e.p({conversation:w.value,"show-toggle":!0}),t:e.o(B),v:e.o(J),w:e.o(O),x:e.o(L),y:e.o(q),z:e.p({conversations:v.value,"current-conversation-id":f.value,collapsed:!1}),A:e.s(P.value),B:e.sr(h,"992afeca-6,992afeca-0",{k:"sidebarPopup"}),C:e.o(N),D:e.p({type:"left","is-mask-click":!1}),E:e.f(x.value,((t,n,a)=>({a:t.id||n,b:e.o(F,t.id||n),c:e.o(G,t.id||n),d:e.o(K,t.id||n),e:"992afeca-8-"+a+",992afeca-0",f:e.p({message:t})}))),F:"chat-bottom-anchor",G:b.value,H:k.value,I:e.o(S),J:e.o(D),K:e.sr(y,"992afeca-9,992afeca-0",{k:"chatInputRef"}),L:e.o(R),M:e.o(z),N:e.o(E),O:e.o(Q),P:e.p({"is-generating":d.value})},{Q:e.n(e.unref(c)?"layout-desktop":"layout-mobile")},{},{T:e.p({current:"pages/chat/index","content-scroll":!1})})}},v=e._export_sfc(r,[["__scopeId","data-v-992afeca"]]);wx.createPage(v);
