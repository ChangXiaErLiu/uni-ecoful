"use strict";const e=require("../../common/vendor.js"),n=require("../../stores/navTitle.js"),o=require("../../utils/request.js"),t=require("../../api/user.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-easyinput"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+l)();const l=()=>"../../components/layout/AppLayout.js",a={__name:"changePhone",setup(l){var a,i;const s=n.navTitleStore();e.onShow((()=>s.setTitle("更换手机号")));const u=(null==(a=t.useUserStore)?void 0:a.call(t))||{profile:null},c=e.ref((null==(i=null==u?void 0:u.profile)?void 0:i.phone)||""),r=e.computed((()=>{const e=c.value;return e?String(e).replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"未绑定"})),d=e.ref({phone:"",code:""}),p=e.ref(0),v=e.ref(!1),h=e.ref(!1);let f=null;function m(e){return/^1\d{10}$/.test(String(e||"").trim())}async function y(){if(m(d.value.phone)){if(!(p.value>0||v.value)){v.value=!0;try{await o.request({url:"/user/phone/sendCode",method:"POST",data:{phone:d.value.phone}}),e.index.showToast({title:"验证码已发送",icon:"success"}),function(e=60){p.value=e,f&&clearInterval(f),f=setInterval((()=>{p.value<=1?(clearInterval(f),p.value=0):p.value-=1}),1e3)}(60)}catch(n){e.index.showToast({title:"发送失败，请稍后重试",icon:"none"})}finally{v.value=!1}}}else e.index.showToast({title:"请输入正确的手机号",icon:"none"})}function T(n){var t;const l=null==(t=null==n?void 0:n.detail)?void 0:t.code;l?(e.index.showLoading({title:"获取中"}),o.request({url:"/user/phone/weapp",method:"POST",data:{code:l}}).then((n=>{const o=null==n?void 0:n.phone;m(o)?(d.value.phone=o,e.index.showToast({title:"已获取手机号",icon:"success"})):e.index.showToast({title:"获取失败，请手动输入",icon:"none"})})).catch((()=>{e.index.showToast({title:"获取失败，请手动输入",icon:"none"})})).finally((()=>{e.index.hideLoading()}))):e.index.showToast({title:"获取失败，请手动输入",icon:"none"})}async function w(){if(m(d.value.phone))if(/^\d{4,8}$/.test(String(d.value.code))){h.value=!0;try{await o.request({url:"/user/phone/bind",method:"POST",data:{phone:d.value.phone,code:d.value.code}}),e.index.showToast({title:"绑定成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack({delta:1})}),600)}catch(n){e.index.showToast({title:"绑定失败，请稍后重试",icon:"none"})}finally{h.value=!1}}else e.index.showToast({title:"请输入正确的验证码",icon:"none"});else e.index.showToast({title:"请输入正确的手机号",icon:"none"})}return e.onUnmounted((()=>{f&&clearInterval(f)})),(n,o)=>({a:e.p({type:"phone",size:"20",color:"#276019"}),b:e.t(r.value),c:e.p({type:"compose",size:"20",color:"#276019"}),d:e.o((e=>d.value.phone=e)),e:e.p({type:"number",placeholder:"请输入新手机号",clearable:!0,modelValue:d.value.phone}),f:e.o(T),g:e.o((e=>d.value.code=e)),h:e.p({type:"number",placeholder:"请输入验证码",modelValue:d.value.code}),i:e.t(p.value>0?`${p.value}s`:v.value?"发送中":"获取验证码"),j:p.value>0||v.value,k:e.o(y),l:e.t(h.value?"提交中...":"确认绑定"),m:h.value,n:e.o(w),o:e.p({current:"pages/profile/changePhone"})})}},i=e._export_sfc(a,[["__scopeId","data-v-e13cd208"]]);wx.createPage(i);
