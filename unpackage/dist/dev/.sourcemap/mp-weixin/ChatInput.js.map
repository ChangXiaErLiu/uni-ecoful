{"version":3,"file":"ChatInput.js","sources":["components/chat/ChatInput.vue"],"sourcesContent":["<!-- ai聊天界面的输入区域 -->\n\n<template>\n\t<view class=\"chat-input-area\">\n\t\t<!-- 附件预览 -->\n\t\t<view v-if=\"attachments.length\" class=\"attachments-preview\">\n\t\t\t<view v-for=\"(file, index) in attachments\" :key=\"index\" class=\"attachment-preview\">\n\t\t\t\t<image v-if=\"checkIsImage(file)\" :src=\"file.url\" class=\"preview-image\" mode=\"aspectFill\" />\n\t\t\t\t<view v-else class=\"preview-file\">\n\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"20\" color=\"#64748b\" />\n\t\t\t\t\t<text class=\"file-name\">{{ file.name }}</text>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"remove-btn\" @tap=\"removeAttachment(index)\" @click=\"removeAttachment(index)\">\n\t\t\t\t\t<uni-icons type=\"close\" size=\"14\" color=\"#ffffff\" />\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<!-- 输入框 -->\n\t\t<view class=\"input-container\">\n\t\t\t\n\t\t\t<textarea v-model=\"inputText\" class=\"message-input\" placeholder=\"任何环保相关的问题都可以问我哦~\" :maxlength=\"-1\"\n\t\t\t\t:adjust-position=\"false\" :show-confirm-bar=\"false\" auto-height @confirm=\"handleMainAction\" />\n\t\t\t\n\t\t\t<!-- 附件按钮（满额禁用） -->\n\t\t\t<view class=\"action-btn\" :class=\"{ disabled: !canAddMore }\" @tap=\"onAddTap\" @click=\"onAddTap\">\n\t\t\t\t<uni-icons type=\"plus\" size=\"24\" :color=\"canAddMore ? '#82AE5D' : '#cbd5e1'\" />\n\t\t\t</view>\n\t\t\t\n\t\t\t<!-- 主操作按钮：发送/停止 -->\n\t\t\t<view \n\t\t\t\tclass=\"main-action-btn\" \n\t\t\t\t:class=\"{ \n\t\t\t\t\t'stop-btn': isGenerating, \n\t\t\t\t\t'send-btn': !isGenerating,\n\t\t\t\t\t'disabled': !isGenerating && !canSend\n\t\t\t\t}\" \n\t\t\t\t@tap=\"handleMainAction\" \n\t\t\t\t@click=\"handleMainAction\"\n\t\t\t>\n\t\t\t\t<uni-icons \n\t\t\t\t\t:type=\"isGenerating ? 'circle-filled' : 'paperplane'\" \n\t\t\t\t\tsize=\"20\"\n\t\t\t\t\t:color=\"getMainButtonColor\" \n\t\t\t\t/>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<!-- 底部操作栏 + 计数 -->\n\t\t<view class=\"input-actions\">\n\t\t\t<view class=\"left\">\n\t\t\t\t<text class=\"counter\">最多上传10个附件，已上传：{{ attachments.length }}/10 个</text>\n\t\t\t</view>\n\t\t</view>\n\t</view>\n</template>\n\n<script setup>\n\timport {\n\t\tref,\n\t\tcomputed\n\t} from 'vue'\n\n\tconst props = defineProps({\n\t\tisGenerating: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false\n\t\t}\n\t})\n\tconst emit = defineEmits(['send-message', 'stop-generating', 'clear-conversation', 'add-attachment'])\n\n\tconst MAX_ATTACH = 10\n\n\tconst inputText = ref('')\n\tconst attachments = ref([])\n\n\t// 在模板中可用的函数\n\tconst checkIsImage = (file) => {\n\t\tif (file?.isImage) return true\n\t\tif (file?.type && typeof file.type === 'string' && file.type.indexOf('image/') === 0) return true\n\t\tconst name = (file?.name || '') + ' ' + (file?.url || '')\n\t\treturn /\\.(png|jpe?g|gif|bmp|webp|heic|heif)$/i.test(name)\n\t}\n\n\tconst canSend = computed(() => {\n\t  // 只有在没有生成中，并且有输入内容或附件时才能发送\n\t  return !props.isGenerating && (inputText.value.trim() || attachments.value.length > 0)\n\t})\n\t\n\tconst remainingSlots = computed(() => Math.max(0, MAX_ATTACH - attachments.value.length))\n\tconst canAddMore = computed(() => remainingSlots.value > 0)\n\t\n\t// 主按钮颜色\n\tconst getMainButtonColor = computed(() => {\n\t\tif (props.isGenerating) {\n\t\t\treturn '#ffffff' // 停止按钮文字颜色\n\t\t}\n\t\treturn canSend.value ? '#ffffff' : '#9ca3af' // 发送按钮文字颜色\n\t})\n\n\t// 主按钮点击处理\n\tconst handleMainAction = () => {\n\t\tif (props.isGenerating) {\n\t\t\t// 生成中：点击停止\n\t\t\tstopGenerating()\n\t\t} else {\n\t\t\t// 非生成中：点击发送\n\t\t\tsendMessage()\n\t\t}\n\t}\n\n\tconst sendMessage = () => {\n\t  if (!canSend.value) return\n\t  \n\t  // 确保发送正确的消息格式\n\t  const messageContent = inputText.value.trim()\n\t  \n\t  const message = {\n\t    content: messageContent, // 直接发送字符串\n\t    attachments: [...attachments.value]\n\t  }\n\t  \n\t  emit('send-message', message)\n\t  inputText.value = ''\n\t  attachments.value = []\n\t}\n\n\tconst stopGenerating = () => emit('stop-generating')\n\n\t// 点击 + 按钮\n\tfunction onAddTap() {\n\t\tif (!canAddMore.value) {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '最多只能添加 10 个附件',\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t\treturn\n\t\t}\n\t\tshowAttachmentMenu()\n\t}\n\n\tfunction showAttachmentMenu() {\n\t\tuni.showActionSheet({\n\t\t\titemList: ['选择图片', '选择文件'],\n\t\t\tsuccess: (res) => {\n\t\t\t\tif (res.tapIndex === 0) uploadImage()\n\t\t\t\telse uploadFile()\n\t\t\t}\n\t\t})\n\t}\n\n\tfunction pushFilesSafe(list) {\n\t\tfor (const f of list) {\n\t\t\tif (attachments.value.length >= MAX_ATTACH) {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '已达 10 个附件上限',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t})\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tattachments.value.push(f)\n\t\t}\n\t}\n\n\t/** 选择图片：三端多选，按剩余名额限制个数 */\n\tfunction uploadImage() {\n\t\tconst count = Math.min(9, remainingSlots.value) // uni.chooseImage 单次最多 9\n\t\tuni.chooseImage({\n\t\t\tcount,\n\t\t\tsizeType: ['compressed'],\n\t\t\tsourceType: ['album', 'camera'],\n\t\t\tsuccess: (res) => {\n\t\t\t\t// H5/小程序：tempFiles & tempFilePaths；App 结构类似\n\t\t\t\tconst list = (res.tempFiles || []).map((t, idx) => ({\n\t\t\t\t\ttype: t.type || 'image/*',\n\t\t\t\t\tisImage: true,\n\t\t\t\t\tname: t.name || `image_${Date.now()}_${idx}.jpg`,\n\t\t\t\t\turl: t.path || (res.tempFilePaths && res.tempFilePaths[idx]) || '',\n\t\t\t\t\tsize: t.size || 0\n\t\t\t\t}))\n\t\t\t\tpushFilesSafe(list)\n\t\t\t}\n\t\t})\n\t}\n\n\t/** 选择任意文件：分别实现三端多选 */\n\tfunction uploadFile() {\n\t\t// ---- H5 ----\n\t\t// #ifdef H5\n\t\tconst input = document.createElement('input')\n\t\tinput.type = 'file'\n\t\tinput.accept = '*/*'\n\t\tinput.multiple = true\n\t\tinput.onchange = (e) => {\n\t\t\tconst files = Array.from(e.target.files || [])\n\t\t\tconst allow = Math.min(files.length, remainingSlots.value)\n\t\t\tconst list = files.slice(0, allow).map((file) => ({\n\t\t\t\ttype: file.type || '',\n\t\t\t\tname: file.name,\n\t\t\t\turl: URL.createObjectURL(file),\n\t\t\t\tsize: file.size,\n\t\t\t\tisImage: checkIsImage(file) // 使用 checkIsImage 函数\n\t\t\t}))\n\t\t\tpushFilesSafe(list)\n\t\t}\n\t\tinput.click()\n\t\t// #endif\n\n\t\t// ---- App ----\n\t\t// #ifdef APP-PLUS\n\t\t// plus.gallery.pick 支持 multiple\n\t\tplus.gallery.pick(\n\t\t\t(res) => {\n\t\t\t\tconst files = res.files || []\n\t\t\t\tconst allow = Math.min(files.length, remainingSlots.value)\n\t\t\t\tconst list = files.slice(0, allow).map((f, idx) => ({\n\t\t\t\t\ttype: f.type || '',\n\t\t\t\t\tname: f.name || `file_${Date.now()}_${idx}`,\n\t\t\t\t\turl: f.path,\n\t\t\t\t\tsize: f.size || 0,\n\t\t\t\t\tisImage: checkIsImage(f) // 使用 checkIsImage 函数\n\t\t\t\t}))\n\t\t\t\tpushFilesSafe(list)\n\t\t\t},\n\t\t\t(err) => {\n\t\t\t\tconsole.error('选择文件失败:', err)\n\t\t\t}, {\n\t\t\t\tmultiple: true\n\t\t\t}\n\t\t)\n\t\t// #endif\n\n\t\t// ---- 小程序 ----\n\t\t// #ifdef MP\n\t\tuni.chooseMessageFile({\n\t\t\tcount: Math.min(remainingSlots.value, 10),\n\t\t\ttype: 'all', // image / video / file / all\n\t\t\tsuccess: (res) => {\n\t\t\t\tconst files = res.tempFiles || []\n\t\t\t\tconst allow = Math.min(files.length, remainingSlots.value)\n\t\t\t\tconst list = files.slice(0, allow).map((f, idx) => ({\n\t\t\t\t\ttype: f.type || '',\n\t\t\t\t\tname: f.name || `file_${Date.now()}_${idx}`,\n\t\t\t\t\turl: f.path,\n\t\t\t\t\tsize: f.size || 0,\n\t\t\t\t\tisImage: checkIsImage(f) // 使用 checkIsImage 函数\n\t\t\t\t}))\n\t\t\t\tpushFilesSafe(list)\n\t\t\t}\n\t\t})\n\t\t// #endif\n\t}\n\n\tconst removeAttachment = (index) => attachments.value.splice(index, 1)\n</script>\n\n<style lang=\"scss\" scoped>\n.chat-input-area {\n  background: #ffffff;\n  border-top: 1px solid #e2e8f0;\n  /* 中文注释：为底部安全区预留空间，兼容 iOS 刘海屏 */\n  padding: 24rpx;\n  padding-bottom: calc(24rpx + constant(safe-area-inset-bottom));\n  padding-bottom: calc(24rpx + env(safe-area-inset-bottom));\n}\n\n\t.attachments-preview {\n\t\tdisplay: flex;\n\t\tflex-wrap: wrap;\n\t\tgap: 16rpx;\n\t\tmargin-bottom: 24rpx;\n\t}\n\n\t.attachment-preview {\n\t\tposition: relative;\n\t\twidth: 120rpx;\n\t\theight: 120rpx;\n\t\tborder-radius: 12rpx;\n\t\toverflow: hidden;\n\t\tbackground: #f8fafc;\r\n\t\tborder: #888e8e 1rpx solid;\n\t}\n\n\t.preview-image {\n\t\twidth: 100%;\n\t\theight: 100%;\n\t}\n\n\t.preview-file {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\talign-items: center;\n\t\tjustify-content: center;\n\t\twidth: 100%;\n\t\theight: 100%;\n\n\t\t.file-name {\n\t\t\tfont-size: 20rpx;\n\t\t\tcolor: #64748b;\n\t\t\tmargin-top: 8rpx;\n\t\t\ttext-align: center;\n\t\t\toverflow: hidden;\n\t\t\ttext-overflow: ellipsis;\n\t\t\twhite-space: nowrap;\n\t\t\twidth: 100%;\n\t\t}\n\t}\n\n\t.remove-btn {\n\t\tposition: absolute;\n\t\ttop: 4rpx;\n\t\tright: 4rpx;\n\t\twidth: 32rpx;\n\t\theight: 32rpx;\n\t\tborder-radius: 50%;\n\t\tbackground: #ef4444;\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: center;\n\t}\n\n\t.input-container {\n\t\tdisplay: flex;\n\t\talign-items: flex-end;\n\t\tgap: 16rpx;\n\t\tmargin-bottom: 20rpx;\n\t}\n\n\t.action-btn {\n\t\twidth: 64rpx;\n\t\theight: 120rpx;\n\t\tborder-radius: 16rpx;\n\t\tbackground: #f8fafc;\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: center;\n\n\t\t&:active {\n\t\t\tbackground: #e2e8f0;\n\t\t}\n\n\t\t&.disabled {\n\t\t\tbackground: #f1f5f9;\n\t\t}\n\t}\n\n\t.message-input {\n\t\tflex: 1;\n\t\tmin-height: 80rpx;\n\t\tmax-height: 200rpx;\n\t\tpadding: 20rpx;\n\t\tbackground: #f8fafc;\n\t\tborder-radius: 20rpx;\n\t\tfont-size: 28rpx;\n\t\tline-height: 1.5;\n\t\tborder: 1px solid #e2e8f0;\n\t\toverflow: auto;\n\n\t\t&:focus {\n\t\t\tborder-color: #3b82f6;\n\t\t\tbackground: #ffffff;\n\t\t}\n\t}\n\n\t/* 主操作按钮基础样式 */\n\t.main-action-btn {\n\t\twidth: 64rpx;\n\t\theight: 120rpx;\n\t\tborder-radius: 16rpx;\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: center;\n\t\ttransition: .2s;\n\n\t\t&:active:not(.disabled) {\n\t\t\ttransform: scale(0.95);\n\t\t}\n\t}\n\n\t/* 发送按钮样式 */\n\t.send-btn {\n\t\tbackground: #00aa00;\n\t\t\n\t\t&.disabled {\n\t\t\tbackground: #f8fafc;\n\t\t}\n\t}\n\n\t/* 停止按钮样式 */\n\t.stop-btn {\n\t\tbackground: #ef4444; /* 红色表示停止 */\n\t}\n\n\t.input-actions {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: space-between;\n\t\tpadding-top: 20rpx;\n\t\tborder-top: 1px solid #f1f5f9;\n\t}\n\n\t.counter {\n\t\tfont-size: 24rpx;\n\t\tcolor: #94a3b8;\n\t}\n\n\t.action-item {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tgap: 8rpx;\n\t\tborder-radius: 20rpx;\n\t\ttransition: .2s;\n\t\t\n\n\t\ttext {\n\t\t\tfont-size: 28rpx;\n\t\t\tcolor: #ff0000;\n\t\t}\n\n\t\t&:active {\n\t\t\tbackground: #f8fafc;\n\t\t}\n\t}\n</style>\n"],"names":["ref","computed","uni"],"mappings":"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"}