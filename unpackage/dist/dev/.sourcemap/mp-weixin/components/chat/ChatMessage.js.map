{"version":3,"file":"ChatMessage.js","sources":["components/chat/ChatMessage.vue","../../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/QzovVXNlcnMvOTcyNDcvRGVza3RvcC91bmktZWNvZnVsL2NvbXBvbmVudHMvY2hhdC9DaGF0TWVzc2FnZS52dWU"],"sourcesContent":["<!-- ai聊天界面的消息区域 -->\n<template>\n\t<view class=\"chat-message\" :class=\"{'user-message': isUser, 'ai-message': !isUser}\">\n\t\t<!-- 头像，后续可以替换真实的 -->\n\t\t<view class=\"message-avatar\">\n\t\t\t<image v-if=\"isUser\" src=\"/static/avatars/user.jpg\" class=\"avatar-img\" mode=\"aspectFit\" />\n\n\t\t\t<!-- ai头像 -->\n\t\t\t<image v-else src=\"/static/avatars/ai.jpg\" class=\"avatar-img\" mode=\"aspectFit\" />\n\t\t</view>\n\n\t\t<!-- 消息内容 -->\n\t\t<view class=\"message-content\">\n\t\t\t<!-- 消息头 -->\n\t\t\t<view class=\"message-header\">\n\t\t\t\t<text class=\"sender-name\">{{ isUser ? '我' : 'AI助手' }}</text>\n\t\t\t\t<text class=\"message-time\">{{ formatTime(message?.timestamp) }}</text>\n\t\t\t</view>\n\n\t\t\t<!-- 消息体 -->\n\t\t\t<view class=\"message-body\">\n\t\t\t\t<!-- 用户消息 -->\n\t\t\t\t<template v-if=\"isUser\">\n\t\t\t\t\t<text class=\"message-text\">\n\t\t\t\t\t\t{{ typeof message?.content === 'string' ? message.content : (message?.content?.content || '') }}\n\t\t\t\t\t</text>\n\n\t\t\t\t\t<!-- 附件显示（用户消息） -->\n\t\t\t\t\t<view v-if=\"message?.attachments && message.attachments.length\" class=\"attachments\">\n\t\t\t\t\t\t<view v-for=\"(attachment, idx) in message.attachments\" :key=\"idx\" class=\"attachment-item\">\n\t\t\t\t\t\t\t<image\n\t\t\t\t\t\t\t\tv-if=\"/\\\\.(png|jpe?g|gif|bmp|webp|heic|heif)$/i.test(attachment?.name || attachment?.url || '')\"\n\t\t\t\t\t\t\t\t:src=\"attachment.url\" class=\"attachment-thumb\" mode=\"aspectFill\" />\n\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"14\" color=\"#64748b\" />\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<text class=\"attachment-name\">{{ attachment.name || '附件' }}</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\n\t\t\t\t\t<view class=\"message-actions\">\n\t\t\t\t\t\t<view class=\"action-btn\" @tap=\"startEdit\">\n\t\t\t\t\t\t\t<uni-icons type=\"compose\" size=\"16\" color=\"#ffffff\" />\n\t\t\t\t\t\t\t<text>编辑</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t\t<view class=\"action-btn\" @tap=\"copyMessageSafe(message?.content)\">\n\t\t\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"16\" color=\"#ffffff\" />\n\t\t\t\t\t\t\t<text>复制</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\t\t\t\t</template>\n\n\t\t\t\t<!-- AI消息 -->\n\t\t\t\t<template v-else>\n\t\t\t\t\t<text class=\"message-text\">\n\t\t\t\t\t\t{{ typeof message?.content === 'string' ? message.content : (message?.content?.content || ' ') }}\n\t\t\t\t\t</text>\n\n\t\t\t\t\t<!-- 附件显示 -->\n\t\t\t\t\t<view v-if=\"message?.attachments && message.attachments.length\" class=\"attachments\">\n\t\t\t\t\t\t<view v-for=\"(attachment, idx) in message.attachments\" :key=\"idx\" class=\"attachment-item\">\n\t\t\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"14\" color=\"#64748b\" />\n\t\t\t\t\t\t\t<text class=\"attachment-name\">{{ attachment.name }}</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\n\t\t\t\t\t<!-- AI消息操作 -->\n\t\t\t\t\t<view class=\"message-actions\">\n\t\t\t\t\t\t<view class=\"action-btn\" :class=\"{'active': message?.feedback === 'like'}\"\n\t\t\t\t\t\t\t@tap=\"handleFeedback('like')\">\n\t\t\t\t\t\t\t<uni-icons :type=\"message?.feedback === 'like' ? 'hand-up-filled' : 'hand-up'\" size=\"16\"\n\t\t\t\t\t\t\t\t:color=\"message?.feedback === 'like' ? '#ffffff' : '#64748b'\" />\n\t\t\t\t\t\t\t<text>有用</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t\t<view class=\"action-btn\" :class=\"{'active': message?.feedback === 'dislike'}\"\n\t\t\t\t\t\t\t@tap=\"handleFeedback('dislike')\">\n\t\t\t\t\t\t\t<uni-icons :type=\"message?.feedback === 'dislike' ? 'hand-down-filled' : 'hand-down'\"\n\t\t\t\t\t\t\t\tsize=\"16\" :color=\"message?.feedback === 'dislike' ? '#ef4444' : '#64748b'\" />\n\t\t\t\t\t\t\t<text>无用</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t\t<view class=\"action-btn\" @tap=\"copyMessageSafe(message?.content)\">\n\t\t\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"16\" color=\"#64748b\" />\n\t\t\t\t\t\t\t<text>复制</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\t\t\t\t</template>\n\t\t\t</view>\n\t\t</view>\n\t</view>\n</template>\n\n<script setup>\n\timport {\n\t\tref,\n\t\tcomputed,\n\t\tonMounted,\n\t\twatch,\n\t\tnextTick\n\t} from 'vue'\n\n\tconst props = defineProps({\n\t\tmessage: {\n\t\t\ttype: Object,\n\t\t\tdefault: () => ({})\n\t\t}\n\t})\n\n\tconst emit = defineEmits(['feedback', 'request-edit', 'edit'])\n\tconst isUser = computed(() => props.message?.role === 'user')\n\n\n\n\twatch(() => props.message, (newMsg) => {\n\t\t// console.log('消息更新:', newMsg)\n\t}, {\n\t\tdeep: true\n\t})\n\n\tonMounted(() => {\n\t\t// console.log('消息组件挂载，消息内容:', props.message)\n\t})\n\n\n\tconst formatTime = (timestamp) => {\n\t\tif (!timestamp) return ''\n\t\tconst date = new Date(timestamp)\n\t\treturn `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`\n\t}\n\n\tconst startEdit = () => {\n\t\t// 把整条消息抛给父组件，用于回填到输入框（文本 + 附件）\n\t\temit('request-edit', {\n\t\t\tid: props.message?.id,\n\t\t\tcontent: typeof props.message?.content === 'string' ? props.message.content : (props.message\n\t\t\t\t?.content?.content || ''),\n\t\t\tattachments: props.message?.attachments || []\n\t\t})\n\t}\n\n\n\n\tconst copyMessage = async (content) => {\n\t\tif (!content) return\n\n\t\ttry {\n\t\t\t// #ifdef H5\n\t\t\tawait navigator.clipboard.writeText(content)\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '已复制到剪贴板',\n\t\t\t\ticon: 'success'\n\t\t\t})\n\t\t\t// #endif\n\t\t\t// #ifdef APP-PLUS || MP\n\t\t\tuni.setClipboardData({\n\t\t\t\tdata: content,\n\t\t\t\tsuccess: () => {\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '已复制到剪贴板',\n\t\t\t\t\t\ticon: 'success'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t\t// #endif\n\t\t} catch (error) {\n\t\t\tconsole.error('复制失败:', error)\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '复制失败',\n\t\t\t\ticon: 'error'\n\t\t\t})\n\t\t}\n\t}\n\n\t// 跨端更稳的复制函数：兼容字符串/对象，含 H5 兜底\n\tconst copyMessageSafe = async (input) => {\n\t\tlet content = ''\n\t\tif (typeof input === 'string') content = input\n\t\telse if (input && typeof input === 'object') content = input.content || ''\n\t\tcontent = String(content || '').trim()\n\t\tif (!content) return\n\n\t\ttry {\n\t\t\tawait new Promise((resolve, reject) => {\n\t\t\t\ttry {\n\t\t\t\t\tuni.setClipboardData({ data: content, success: resolve, fail: reject })\n\t\t\t\t} catch (e) { reject(e) }\n\t\t\t})\n\t\t\tuni.showToast({ title: '已复制到剪贴板', icon: 'success' })\n\t\t\treturn\n\t\t} catch (_) {}\n\n\t\ttry {\n\t\t\tif (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {\n\t\t\t\tawait navigator.clipboard.writeText(content)\n\t\t\t\tuni.showToast({ title: '已复制到剪贴板', icon: 'success' })\n\t\t\t\treturn\n\t\t\t}\n\t\t} catch (_) {}\n\n\t\ttry {\n\t\t\tif (typeof document !== 'undefined') {\n\t\t\t\tconst ta = document.createElement('textarea')\n\t\t\t\tta.value = content\n\t\t\t\tta.style.position = 'fixed'\n\t\t\t\tta.style.opacity = '0'\n\t\t\t\tdocument.body.appendChild(ta)\n\t\t\t\tta.select()\n\t\t\t\tconst ok = document.execCommand('copy')\n\t\t\t\tdocument.body.removeChild(ta)\n\t\t\t\tif (ok) {\n\t\t\t\t\tuni.showToast({ title: '已复制到剪贴板', icon: 'success' })\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (_) {}\n\n\t\tuni.showToast({ title: '复制失败', icon: 'error' })\n\t}\n\n\tconst handleFeedback = (type) => {\n\t\tif (!props.message?.id) return\n\t\temit('feedback', props.message.id, type)\n\t}\n</script>\n\n<style lang=\"scss\" scoped>\n\t.chat-message {\n\t\tdisplay: flex;\n\t\tmargin-bottom: 32rpx;\n\t\tpadding: 0 24rpx;\n\t\t/* 移除固定高度，让内容决定高度 */\n\t\t/* height: 70vh; */\n\t\tpadding: 15rpx;\n\n\t\t&.user-message {\n\t\t\tflex-direction: row-reverse;\n\n\t\t\t.message-content {\n\t\t\t\talign-items: flex-end;\n\t\t\t}\n\n\t\t\t.message-body {\n\t\t\t\tbackground: #6FB052;\n\t\t\t\tcolor: white;\n\t\t\t\tborder-radius: 24rpx 24rpx 8rpx 24rpx;\n\t\t\t}\n\t\t}\n\n\t\t&.ai-message {\n\t\t\t.message-body {\n\t\t\t\tbackground: #ffffff;\n\t\t\t\tborder: 1px solid #e2e8f0;\n\t\t\t\tborder-radius: 24rpx 24rpx 24rpx 8rpx;\n\t\t\t}\n\t\t}\n\t}\n\n\t.message-avatar {\n\t\twidth: 64rpx;\n\t\theight: 64rpx;\n\t\tborder-radius: 16rpx;\n\t\toverflow: hidden;\n\t\tmargin: 0 16rpx;\n\n\t\t.avatar-img {\n\t\t\twidth: 100%;\n\t\t\theight: 100%;\n\t\t\tbackground: #f1f5f9;\n\t\t}\n\t}\n\n\t.message-content {\n\t\tflex: 1;\n\t\tmax-width: 80%;\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\n\t.message-header {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: space-between;\n\t\tmargin-bottom: 12rpx;\n\t\tpadding: 0 8rpx;\n\t}\n\n\t.sender-name {\n\t\tfont-size: 26rpx;\n\t\tfont-weight: 600;\n\t\tcolor: #374151;\n\t}\n\n\t.message-time {\n\t\tfont-size: 22rpx;\n\t\tcolor: #9ca3af;\n\t}\n\n\t.message-body {\n\t\tpadding: 24rpx;\n\t\tbox-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);\n\t}\n\n\t.message-text {\n\t\tfont-size: 28rpx;\n\t\tline-height: 1.6;\n\t\twhite-space: pre-wrap;\n\t\tword-break: break-word;\n\t\t/* 确保文本可见 */\n\t\tmin-height: 40rpx;\n\t}\n\n\t.attachments {\n\t\tmargin-top: 16rpx;\n\t\tpadding-top: 16rpx;\n\t\tborder-top: 1px solid #f1f5f9;\n\t\tflex-wrap: wrap;\n\t}\n\n\t.attachment-item {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tpadding: 8rpx 0;\n\n\t\t.attachment-name {\n\t\t\tfont-size: 24rpx;\n\t\t\tcolor: #64748b;\n\t\t\tmargin-left: 8rpx;\n\t\t}\n\t}\n\n\t.attachment-thumb {\n\t\twidth: 120rpx;\n\t\theight: 120rpx;\n\t\tborder-radius: 12rpx;\n\t\tmargin-right: 8rpx;\n\t\tobject-fit: cover;\n\t}\n\n\t.message-actions {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tgap: 24rpx;\n\t\tmargin-top: 16rpx;\n\t\tpadding-top: 16rpx;\n\t\tborder-top: 1px solid rgba(255, 255, 255, 0.2);\n\n\t\t.user-message & {\n\t\t\tborder-top-color: rgba(255, 255, 255, 0.2);\n\t\t}\n\n\t\t.ai-message & {\n\t\t\tborder-top-color: #f1f5f9;\n\t\t}\n\t}\n\n\t.action-btn {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tgap: 6rpx;\n\t\tpadding: 8rpx 16rpx;\n\t\tborder-radius: 20rpx;\n\t\tbackground: rgba(255, 255, 255, 0.1);\n\t\ttransition: all 0.2s ease;\n\t\tcursor: pointer;      /* H5/PC 显示为可点 */\n\t\tpointer-events: auto; \n\n\t\t.ai-message & {\n\t\t\tbackground: #f8fafc;\n\t\t}\n\n\t\t&.active {\n\t\t\tbackground: #10b981;\n\n\t\t\ttext {\n\t\t\t\tcolor: white;\n\t\t\t}\n\t\t}\n\n\t\ttext {\n\t\t\tfont-size: 22rpx;\n\t\t\tcolor: #64748b;\n\n\t\t\t.user-message & {\n\t\t\t\tcolor: rgba(255, 255, 255, 0.8);\n\t\t\t}\n\t\t}\n\n\t\t&:active {\n\t\t\ttransform: scale(0.95);\n\t\t}\n\t}\n</style>\n","import Component from 'C:/Users/97247/Desktop/uni-ecoful/components/chat/ChatMessage.vue'\nwx.createComponent(Component)"],"names":["computed","watch","onMounted","uni"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAoGC,UAAM,QAAQ;AAOd,UAAM,OAAO;AACb,UAAM,SAASA,cAAAA,SAAS,MAAA;;AAAM,0BAAM,YAAN,mBAAe,UAAS;AAAA,KAAM;AAI5DC,kBAAAA,MAAM,MAAM,MAAM,SAAS,CAAC,WAAW;AAAA,IAExC,GAAI;AAAA,MACF,MAAM;AAAA,IACR,CAAE;AAEDC,kBAAAA,UAAU,MAAM;AAAA,IAEjB,CAAE;AAGD,UAAM,aAAa,CAAC,cAAc;AACjC,UAAI,CAAC;AAAW,eAAO;AACvB,YAAM,OAAO,IAAI,KAAK,SAAS;AAC/B,aAAO,GAAG,KAAK,SAAQ,EAAG,WAAW,SAAS,GAAG,GAAG,CAAC,IAAI,KAAK,WAAU,EAAG,SAAQ,EAAG,SAAS,GAAG,GAAG,CAAC;AAAA,IACtG;AAED,UAAM,YAAY,MAAM;;AAEvB,WAAK,gBAAgB;AAAA,QACpB,KAAI,WAAM,YAAN,mBAAe;AAAA,QACnB,SAAS,SAAO,WAAM,YAAN,mBAAe,aAAY,WAAW,MAAM,QAAQ,YAAW,iBAAM,YAAN,mBAC5E,YAD4E,mBACnE,YAAW;AAAA,QACvB,eAAa,WAAM,YAAN,mBAAe,gBAAe,CAAE;AAAA,MAChD,CAAG;AAAA,IACD;AAoCD,UAAM,kBAAkB,OAAO,UAAU;;AACxC,UAAI,UAAU;AACd,UAAI,OAAO,UAAU;AAAU,kBAAU;AAAA,eAChC,SAAS,OAAO,UAAU;AAAU,kBAAU,MAAM,WAAW;AACxE,gBAAU,OAAO,WAAW,EAAE,EAAE,KAAM;AACtC,UAAI,CAAC;AAAS;AAEd,UAAI;AACH,cAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,cAAI;AACHC,gCAAI,iBAAiB,EAAE,MAAM,SAAS,SAAS,SAAS,MAAM,QAAQ;AAAA,UACtE,SAAQ,GAAG;AAAE,mBAAO,CAAC;AAAA,UAAG;AAAA,QAC7B,CAAI;AACDA,sBAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,WAAW;AACnD;AAAA,MACH,SAAW,GAAG;AAAA,MAAE;AAEd,UAAI;AACH,YAAI,OAAO,cAAc,iBAAe,eAAU,cAAV,mBAAqB,YAAW;AACvE,gBAAM,UAAU,UAAU,UAAU,OAAO;AAC3CA,wBAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,WAAW;AACnD;AAAA,QACA;AAAA,MACJ,SAAW,GAAG;AAAA,MAAE;AAEd,UAAI;AACH,YAAI,OAAO,aAAa,aAAa;AACpC,gBAAM,KAAK,SAAS,cAAc,UAAU;AAC5C,aAAG,QAAQ;AACX,aAAG,MAAM,WAAW;AACpB,aAAG,MAAM,UAAU;AACnB,mBAAS,KAAK,YAAY,EAAE;AAC5B,aAAG,OAAQ;AACX,gBAAM,KAAK,SAAS,YAAY,MAAM;AACtC,mBAAS,KAAK,YAAY,EAAE;AAC5B,cAAI,IAAI;AACPA,0BAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,WAAW;AACnD;AAAA,UACA;AAAA,QACD;AAAA,MACJ,SAAW,GAAG;AAAA,MAAE;AAEdA,oBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,SAAS;AAAA,IAC9C;AAED,UAAM,iBAAiB,CAAC,SAAS;;AAChC,UAAI,GAAC,WAAM,YAAN,mBAAe;AAAI;AACxB,WAAK,YAAY,MAAM,QAAQ,IAAI,IAAI;AAAA,IACvC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5NF,GAAG,gBAAgB,SAAS;"}