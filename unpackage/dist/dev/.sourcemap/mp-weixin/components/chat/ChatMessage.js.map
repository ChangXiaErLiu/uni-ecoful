{"version":3,"file":"ChatMessage.js","sources":["components/chat/ChatMessage.vue","../../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/QzovVXNlcnMvOTcyNDcvRGVza3RvcC91bmktZWNvZnVsL2NvbXBvbmVudHMvY2hhdC9DaGF0TWVzc2FnZS52dWU"],"sourcesContent":["<!-- ai聊天界面的消息区域 -->\r\n<template>\r\n\t<view class=\"chat-message\" :class=\"{'user-message': isUser, 'ai-message': !isUser}\">\r\n\t\t<!-- 头像，后续可以替换真实的 -->\r\n\t\t<view class=\"message-avatar\">\r\n\t\t\t<image v-if=\"isUser\" src=\"/static/avatars/user.jpg\" class=\"avatar-img\" mode=\"aspectFit\" />\r\n\r\n\t\t\t<!-- ai头像 -->\r\n\t\t\t<image v-else src=\"/static/avatars/ai.jpg\" class=\"avatar-img\" mode=\"aspectFit\" />\r\n\t\t</view>\r\n\r\n\t\t<!-- 消息内容 -->\r\n\t\t<view class=\"message-content\">\r\n\t\t\t<!-- 消息头 -->\r\n\t\t\t<view class=\"message-header\">\r\n\t\t\t\t<text class=\"sender-name\">{{ isUser ? '我' : 'AI助手' }}</text>\r\n\t\t\t\t<text class=\"message-time\">{{ formatTime(message?.timestamp) }}</text>\r\n\t\t\t</view>\r\n\r\n\t\t\t<!-- 消息体 -->\r\n\t\t\t<view class=\"message-body\">\r\n\t\t\t\t<!-- 用户消息 -->\r\n\t\t\t\t<template v-if=\"isUser\">\r\n\t\t\t\t\t<text class=\"message-text\">\r\n\t\t\t\t\t\t{{ typeof message?.content === 'string' ? message.content : (message?.content?.content || '') }}\r\n\t\t\t\t\t</text>\r\n\r\n\t\t\t\t\t<!-- 附件显示（用户消息） -->\r\n\t\t\t\t\t<view v-if=\"message?.attachments && message.attachments.length\" class=\"attachments\">\r\n\t\t\t\t\t\t<view v-for=\"(attachment, idx) in message.attachments\" :key=\"idx\" class=\"attachment-item\">\r\n\t\t\t\t\t\t\t<image\r\n\t\t\t\t\t\t\t\tv-if=\"/\\\\.(png|jpe?g|gif|bmp|webp|heic|heif)$/i.test(attachment?.name || attachment?.url || '')\"\r\n\t\t\t\t\t\t\t\t:src=\"attachment.url\" class=\"attachment-thumb\" mode=\"aspectFill\" />\r\n\t\t\t\t\t\t\t<template v-else>\r\n\t\t\t\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"14\" color=\"#64748b\" />\r\n\t\t\t\t\t\t\t</template>\r\n\t\t\t\t\t\t\t<text class=\"attachment-name\">{{ attachment.name || '附件' }}</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\r\n\t\t\t\t\t<view class=\"message-actions\">\r\n\t\t\t\t\t\t<view class=\"action-btn\" @tap=\"startEdit\">\r\n\t\t\t\t\t\t\t<uni-icons type=\"compose\" size=\"16\" color=\"#ffffff\" />\r\n\t\t\t\t\t\t\t<text>编辑</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<view class=\"action-btn\" @tap=\"copyMessageSafe(message?.content)\">\n\t\t\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"16\" color=\"#ffffff\" />\r\n\t\t\t\t\t\t\t<text>复制</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</template>\r\n\r\n\t\t\t\t<!-- AI消息 -->\r\n\t\t\t\t<template v-else>\r\n\t\t\t\t\t<text class=\"message-text\">\r\n\t\t\t\t\t\t{{ typeof message?.content === 'string' ? message.content : (message?.content?.content || ' ') }}\r\n\t\t\t\t\t</text>\r\n\r\n\t\t\t\t\t<!-- 附件显示 -->\r\n\t\t\t\t\t<view v-if=\"message?.attachments && message.attachments.length\" class=\"attachments\">\r\n\t\t\t\t\t\t<view v-for=\"(attachment, idx) in message.attachments\" :key=\"idx\" class=\"attachment-item\">\r\n\t\t\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"14\" color=\"#64748b\" />\r\n\t\t\t\t\t\t\t<text class=\"attachment-name\">{{ attachment.name }}</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\r\n\t\t\t\t\t<!-- AI消息操作 -->\r\n\t\t\t\t\t<view class=\"message-actions\">\r\n\t\t\t\t\t\t<view class=\"action-btn\" :class=\"{'active': message?.feedback === 'like'}\"\r\n\t\t\t\t\t\t\t@tap=\"handleFeedback('like')\">\r\n\t\t\t\t\t\t\t<uni-icons :type=\"message?.feedback === 'like' ? 'hand-up-filled' : 'hand-up'\" size=\"16\"\r\n\t\t\t\t\t\t\t\t:color=\"message?.feedback === 'like' ? '#ffffff' : '#64748b'\" />\r\n\t\t\t\t\t\t\t<text>有用</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<view class=\"action-btn\" :class=\"{'active': message?.feedback === 'dislike'}\"\r\n\t\t\t\t\t\t\t@tap=\"handleFeedback('dislike')\">\r\n\t\t\t\t\t\t\t<uni-icons :type=\"message?.feedback === 'dislike' ? 'hand-down-filled' : 'hand-down'\"\r\n\t\t\t\t\t\t\t\tsize=\"16\" :color=\"message?.feedback === 'dislike' ? '#ef4444' : '#64748b'\" />\r\n\t\t\t\t\t\t\t<text>无用</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<view class=\"action-btn\" @tap=\"copyMessageSafe(message?.content)\">\n\t\t\t\t\t\t\t<uni-icons type=\"paperclip\" size=\"16\" color=\"#64748b\" />\r\n\t\t\t\t\t\t\t<text>复制</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</template>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<script setup>\r\n\timport {\r\n\t\tref,\r\n\t\tcomputed,\r\n\t\tonMounted,\r\n\t\twatch,\r\n\t\tnextTick\r\n\t} from 'vue'\r\n\r\n\tconst props = defineProps({\r\n\t\tmessage: {\r\n\t\t\ttype: Object,\r\n\t\t\tdefault: () => ({})\r\n\t\t}\r\n\t})\r\n\r\n\tconst emit = defineEmits(['feedback', 'request-edit', 'edit'])\r\n\tconst isUser = computed(() => props.message?.role === 'user')\r\n\r\n\r\n\r\n\twatch(() => props.message, (newMsg) => {\r\n\t\t// console.log('消息更新:', newMsg)\r\n\t}, {\r\n\t\tdeep: true\r\n\t})\r\n\r\n\tonMounted(() => {\r\n\t\t// console.log('消息组件挂载，消息内容:', props.message)\r\n\t})\r\n\r\n\r\n\tconst formatTime = (timestamp) => {\r\n\t\tif (!timestamp) return ''\r\n\t\tconst date = new Date(timestamp)\r\n\t\treturn `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`\r\n\t}\r\n\r\n\tconst startEdit = () => {\r\n\t\t// 把整条消息抛给父组件，用于回填到输入框（文本 + 附件）\r\n\t\temit('request-edit', {\r\n\t\t\tid: props.message?.id,\r\n\t\t\tcontent: typeof props.message?.content === 'string' ? props.message.content : (props.message\r\n\t\t\t\t?.content?.content || ''),\r\n\t\t\tattachments: props.message?.attachments || []\r\n\t\t})\r\n\t}\r\n\r\n\r\n\r\n\tconst copyMessage = async (content) => {\r\n\t\tif (!content) return\r\n\r\n\t\ttry {\r\n\t\t\t// #ifdef H5\r\n\t\t\tawait navigator.clipboard.writeText(content)\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '已复制到剪贴板',\r\n\t\t\t\ticon: 'success'\r\n\t\t\t})\r\n\t\t\t// #endif\r\n\t\t\t// #ifdef APP-PLUS || MP\r\n\t\t\tuni.setClipboardData({\r\n\t\t\t\tdata: content,\r\n\t\t\t\tsuccess: () => {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '已复制到剪贴板',\r\n\t\t\t\t\t\ticon: 'success'\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t// #endif\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('复制失败:', error)\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '复制失败',\r\n\t\t\t\ticon: 'error'\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n\r\n\t// 跨端更稳的复制函数：兼容字符串/对象，含 H5 兜底\n\tconst copyMessageSafe = async (input) => {\n\t\tlet content = ''\n\t\tif (typeof input === 'string') content = input\n\t\telse if (input && typeof input === 'object') content = input.content || ''\n\t\tcontent = String(content || '').trim()\n\t\tif (!content) return\n\n\t\ttry {\n\t\t\tawait new Promise((resolve, reject) => {\n\t\t\t\ttry {\n\t\t\t\t\tuni.setClipboardData({ data: content, success: resolve, fail: reject })\n\t\t\t\t} catch (e) { reject(e) }\n\t\t\t})\n\t\t\tuni.showToast({ title: '已复制到剪贴板', icon: 'success' })\n\t\t\treturn\n\t\t} catch (_) {}\n\n\t\ttry {\n\t\t\tif (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {\n\t\t\t\tawait navigator.clipboard.writeText(content)\n\t\t\t\tuni.showToast({ title: '已复制到剪贴板', icon: 'success' })\n\t\t\t\treturn\n\t\t\t}\n\t\t} catch (_) {}\n\n\t\ttry {\n\t\t\tif (typeof document !== 'undefined') {\n\t\t\t\tconst ta = document.createElement('textarea')\n\t\t\t\tta.value = content\n\t\t\t\tta.style.position = 'fixed'\n\t\t\t\tta.style.opacity = '0'\n\t\t\t\tdocument.body.appendChild(ta)\n\t\t\t\tta.select()\n\t\t\t\tconst ok = document.execCommand('copy')\n\t\t\t\tdocument.body.removeChild(ta)\n\t\t\t\tif (ok) {\n\t\t\t\t\tuni.showToast({ title: '已复制到剪贴板', icon: 'success' })\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (_) {}\n\n\t\tuni.showToast({ title: '复制失败', icon: 'error' })\n\t}\n\n\tconst handleFeedback = (type) => {\n\t\tif (!props.message?.id) return\r\n\t\temit('feedback', props.message.id, type)\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n\t.chat-message {\r\n\t\tdisplay: flex;\r\n\t\tmargin-bottom: 32rpx;\r\n\t\tpadding: 0 24rpx;\r\n\t\t/* 移除固定高度，让内容决定高度 */\r\n\t\t/* height: 70vh; */\r\n\t\tpadding: 15rpx;\r\n\r\n\t\t&.user-message {\r\n\t\t\tflex-direction: row-reverse;\r\n\r\n\t\t\t.message-content {\r\n\t\t\t\talign-items: flex-end;\r\n\t\t\t}\r\n\r\n\t\t\t.message-body {\r\n\t\t\t\tbackground: #6FB052;\r\n\t\t\t\tcolor: white;\r\n\t\t\t\tborder-radius: 24rpx 24rpx 8rpx 24rpx;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t&.ai-message {\r\n\t\t\t.message-body {\r\n\t\t\t\tbackground: #ffffff;\r\n\t\t\t\tborder: 1px solid #e2e8f0;\r\n\t\t\t\tborder-radius: 24rpx 24rpx 24rpx 8rpx;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t.message-avatar {\r\n\t\twidth: 64rpx;\r\n\t\theight: 64rpx;\r\n\t\tborder-radius: 16rpx;\r\n\t\toverflow: hidden;\r\n\t\tmargin: 0 16rpx;\r\n\r\n\t\t.avatar-img {\r\n\t\t\twidth: 100%;\r\n\t\t\theight: 100%;\r\n\t\t\tbackground: #f1f5f9;\r\n\t\t}\r\n\t}\r\n\r\n\t.message-content {\r\n\t\tflex: 1;\r\n\t\tmax-width: 80%;\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t}\r\n\r\n\t.message-header {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tjustify-content: space-between;\r\n\t\tmargin-bottom: 12rpx;\r\n\t\tpadding: 0 8rpx;\r\n\t}\r\n\r\n\t.sender-name {\r\n\t\tfont-size: 26rpx;\r\n\t\tfont-weight: 600;\r\n\t\tcolor: #374151;\r\n\t}\r\n\r\n\t.message-time {\r\n\t\tfont-size: 22rpx;\r\n\t\tcolor: #9ca3af;\r\n\t}\r\n\r\n\t.message-body {\r\n\t\tpadding: 24rpx;\r\n\t\tbox-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);\r\n\t}\r\n\r\n\t.message-text {\r\n\t\tfont-size: 28rpx;\r\n\t\tline-height: 1.6;\r\n\t\twhite-space: pre-wrap;\r\n\t\tword-break: break-word;\r\n\t\t/* 确保文本可见 */\r\n\t\tmin-height: 40rpx;\r\n\t}\r\n\r\n\t.attachments {\r\n\t\tmargin-top: 16rpx;\r\n\t\tpadding-top: 16rpx;\r\n\t\tborder-top: 1px solid #f1f5f9;\r\n\t\tflex-wrap: wrap;\r\n\t}\r\n\r\n\t.attachment-item {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tpadding: 8rpx 0;\r\n\r\n\t\t.attachment-name {\r\n\t\t\tfont-size: 24rpx;\r\n\t\t\tcolor: #64748b;\r\n\t\t\tmargin-left: 8rpx;\r\n\t\t}\r\n\t}\r\n\r\n\t.attachment-thumb {\r\n\t\twidth: 120rpx;\r\n\t\theight: 120rpx;\r\n\t\tborder-radius: 12rpx;\r\n\t\tmargin-right: 8rpx;\r\n\t\tobject-fit: cover;\r\n\t}\r\n\r\n\t.message-actions {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: 24rpx;\r\n\t\tmargin-top: 16rpx;\r\n\t\tpadding-top: 16rpx;\r\n\t\tborder-top: 1px solid rgba(255, 255, 255, 0.2);\r\n\r\n\t\t.user-message & {\r\n\t\t\tborder-top-color: rgba(255, 255, 255, 0.2);\r\n\t\t}\r\n\r\n\t\t.ai-message & {\r\n\t\t\tborder-top-color: #f1f5f9;\r\n\t\t}\r\n\t}\r\n\r\n\t.action-btn {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: 6rpx;\r\n\t\tpadding: 8rpx 16rpx;\r\n\t\tborder-radius: 20rpx;\r\n\t\tbackground: rgba(255, 255, 255, 0.1);\r\n\t\ttransition: all 0.2s ease;\r\n\t\tcursor: pointer;      /* H5/PC 显示为可点 */\r\n\t\tpointer-events: auto; \r\n\r\n\t\t.ai-message & {\r\n\t\t\tbackground: #f8fafc;\r\n\t\t}\r\n\r\n\t\t&.active {\r\n\t\t\tbackground: #10b981;\r\n\r\n\t\t\ttext {\r\n\t\t\t\tcolor: white;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\ttext {\r\n\t\t\tfont-size: 22rpx;\r\n\t\t\tcolor: #64748b;\r\n\r\n\t\t\t.user-message & {\r\n\t\t\t\tcolor: rgba(255, 255, 255, 0.8);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t&:active {\r\n\t\t\ttransform: scale(0.95);\r\n\t\t}\r\n\t}\r\n</style>\n","import Component from 'C:/Users/97247/Desktop/uni-ecoful/components/chat/ChatMessage.vue'\nwx.createComponent(Component)"],"names":["computed","watch","onMounted","uni"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAoGC,UAAM,QAAQ;AAOd,UAAM,OAAO;AACb,UAAM,SAASA,cAAAA,SAAS,MAAA;;AAAM,0BAAM,YAAN,mBAAe,UAAS;AAAA,KAAM;AAI5DC,kBAAAA,MAAM,MAAM,MAAM,SAAS,CAAC,WAAW;AAAA,IAExC,GAAI;AAAA,MACF,MAAM;AAAA,IACR,CAAE;AAEDC,kBAAAA,UAAU,MAAM;AAAA,IAEjB,CAAE;AAGD,UAAM,aAAa,CAAC,cAAc;AACjC,UAAI,CAAC;AAAW,eAAO;AACvB,YAAM,OAAO,IAAI,KAAK,SAAS;AAC/B,aAAO,GAAG,KAAK,SAAQ,EAAG,WAAW,SAAS,GAAG,GAAG,CAAC,IAAI,KAAK,WAAU,EAAG,SAAQ,EAAG,SAAS,GAAG,GAAG,CAAC;AAAA,IACtG;AAED,UAAM,YAAY,MAAM;;AAEvB,WAAK,gBAAgB;AAAA,QACpB,KAAI,WAAM,YAAN,mBAAe;AAAA,QACnB,SAAS,SAAO,WAAM,YAAN,mBAAe,aAAY,WAAW,MAAM,QAAQ,YAAW,iBAAM,YAAN,mBAC5E,YAD4E,mBACnE,YAAW;AAAA,QACvB,eAAa,WAAM,YAAN,mBAAe,gBAAe,CAAE;AAAA,MAChD,CAAG;AAAA,IACD;AAoCD,UAAM,kBAAkB,OAAO,UAAU;;AACxC,UAAI,UAAU;AACd,UAAI,OAAO,UAAU;AAAU,kBAAU;AAAA,eAChC,SAAS,OAAO,UAAU;AAAU,kBAAU,MAAM,WAAW;AACxE,gBAAU,OAAO,WAAW,EAAE,EAAE,KAAM;AACtC,UAAI,CAAC;AAAS;AAEd,UAAI;AACH,cAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,cAAI;AACHC,gCAAI,iBAAiB,EAAE,MAAM,SAAS,SAAS,SAAS,MAAM,QAAQ;AAAA,UACtE,SAAQ,GAAG;AAAE,mBAAO,CAAC;AAAA,UAAG;AAAA,QAC7B,CAAI;AACDA,sBAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,WAAW;AACnD;AAAA,MACH,SAAW,GAAG;AAAA,MAAE;AAEd,UAAI;AACH,YAAI,OAAO,cAAc,iBAAe,eAAU,cAAV,mBAAqB,YAAW;AACvE,gBAAM,UAAU,UAAU,UAAU,OAAO;AAC3CA,wBAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,WAAW;AACnD;AAAA,QACA;AAAA,MACJ,SAAW,GAAG;AAAA,MAAE;AAEd,UAAI;AACH,YAAI,OAAO,aAAa,aAAa;AACpC,gBAAM,KAAK,SAAS,cAAc,UAAU;AAC5C,aAAG,QAAQ;AACX,aAAG,MAAM,WAAW;AACpB,aAAG,MAAM,UAAU;AACnB,mBAAS,KAAK,YAAY,EAAE;AAC5B,aAAG,OAAQ;AACX,gBAAM,KAAK,SAAS,YAAY,MAAM;AACtC,mBAAS,KAAK,YAAY,EAAE;AAC5B,cAAI,IAAI;AACPA,0BAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,WAAW;AACnD;AAAA,UACA;AAAA,QACD;AAAA,MACJ,SAAW,GAAG;AAAA,MAAE;AAEdA,oBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,SAAS;AAAA,IAC9C;AAED,UAAM,iBAAiB,CAAC,SAAS;;AAChC,UAAI,GAAC,WAAM,YAAN,mBAAe;AAAI;AACxB,WAAK,YAAY,MAAM,QAAQ,IAAI,IAAI;AAAA,IACvC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5NF,GAAG,gBAAgB,SAAS;"}