{"version":3,"file":"user.js","sources":["stores/user.js"],"sourcesContent":["/**\r\n * 用户状态管理\r\n */\r\nimport { defineStore } from 'pinia'\r\nimport { loginByPassword, loginByCode, loginByWechat, getUserInfo, logout as logoutApi } from '@/api/auth.js'\r\n\r\nexport const useUserStore = defineStore('user', {\r\n\tstate: () => ({\r\n\t\ttoken: uni.getStorageSync('token') || '',\r\n\t\tuserInfo: null\r\n\t}),\r\n\r\n\tgetters: {\r\n\t\t// 是否已登录\r\n\t\tisLoggedIn: (state) => !!state.token,\r\n\t\t\r\n\t\t// 用户名\r\n\t\tuserName: (state) => state.userInfo?.name || state.userInfo?.username || '未登录',\r\n\t\t\r\n\t\t// 企业名称\r\n\t\tcompanyName: (state) => state.userInfo?.company_name || ''\r\n\t},\r\n\r\n\tactions: {\r\n\t\t/**\r\n\t\t * 密码登录\r\n\t\t */\r\n\t\tasync loginByPassword(account, password) {\r\n\t\t\ttry {\r\n\t\t\t\tconst res = await loginByPassword(account, password)\r\n\t\t\t\t\r\n\t\t\t\t// 保存 token\r\n\t\t\t\tthis.token = res.access_token\r\n\t\t\t\tuni.setStorageSync('token', res.access_token)\r\n\t\t\t\t\r\n\t\t\t\t// 保存用户信息\r\n\t\t\t\tthis.userInfo = res.user\r\n\t\t\t\tuni.setStorageSync('userInfo', JSON.stringify(res.user))\r\n\t\t\t\t\r\n\t\t\t\treturn { success: true, data: res }\r\n\t\t\t} catch (error) {\r\n\t\t\t\treturn { success: false, error }\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * 验证码登录\r\n\t\t */\r\n\t\tasync loginByCode(phone, code) {\r\n\t\t\ttry {\r\n\t\t\t\tconst res = await loginByCode(phone, code)\r\n\t\t\t\t\r\n\t\t\t\tthis.token = res.access_token\r\n\t\t\t\tuni.setStorageSync('token', res.access_token)\r\n\t\t\t\t\r\n\t\t\t\tthis.userInfo = res.user\r\n\t\t\t\tuni.setStorageSync('userInfo', JSON.stringify(res.user))\r\n\t\t\t\t\r\n\t\t\t\treturn { success: true, data: res }\r\n\t\t\t} catch (error) {\r\n\t\t\t\treturn { success: false, error }\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * 微信登录\r\n\t\t */\r\n\t\tasync loginByWechat(code) {\r\n\t\t\ttry {\r\n\t\t\t\tconst res = await loginByWechat(code)\r\n\t\t\t\t\r\n\t\t\t\tthis.token = res.access_token\r\n\t\t\t\tuni.setStorageSync('token', res.access_token)\r\n\t\t\t\t\r\n\t\t\t\tthis.userInfo = res.user\r\n\t\t\t\tuni.setStorageSync('userInfo', JSON.stringify(res.user))\r\n\t\t\t\t\r\n\t\t\t\treturn { success: true, data: res }\r\n\t\t\t} catch (error) {\r\n\t\t\t\treturn { success: false, error }\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * 获取用户信息\r\n\t\t */\r\n\t\tasync fetchUserInfo() {\r\n\t\t\ttry {\r\n\t\t\t\tconst res = await getUserInfo()\r\n\t\t\t\tthis.userInfo = res\r\n\t\t\t\tuni.setStorageSync('userInfo', JSON.stringify(res))\r\n\t\t\t\treturn { success: true, data: res }\r\n\t\t\t} catch (error) {\r\n\t\t\t\treturn { success: false, error }\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * 登出\r\n\t\t */\r\n\t\tasync logout() {\r\n\t\t\ttry {\r\n\t\t\t\tawait logoutApi()\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.error('登出接口调用失败:', error)\r\n\t\t\t} finally {\r\n\t\t\t\t// 无论接口是否成功，都清除本地数据\r\n\t\t\t\tthis.token = ''\r\n\t\t\t\tthis.userInfo = null\r\n\t\t\t\tuni.removeStorageSync('token')\r\n\t\t\t\tuni.removeStorageSync('userInfo')\r\n\t\t\t\t\r\n\t\t\t\t// 跳转到登录页\r\n\t\t\t\tuni.reLaunch({\r\n\t\t\t\t\turl: '/pages/auth/login'\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * 初始化用户信息（从本地存储恢复）\r\n\t\t */\r\n\t\tinitUserInfo() {\r\n\t\t\ttry {\r\n\t\t\t\tconst userInfoStr = uni.getStorageSync('userInfo')\r\n\t\t\t\tif (userInfoStr) {\r\n\t\t\t\t\tthis.userInfo = JSON.parse(userInfoStr)\r\n\t\t\t\t}\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.error('初始化用户信息失败:', error)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n})\r\n"],"names":["defineStore","uni","loginByPassword","loginByCode","loginByWechat","getUserInfo","logoutApi"],"mappings":"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"}