{"version":3,"file":"index.js","sources":["pages/chat/index.vue","../../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdC9pbmRleC52dWU"],"sourcesContent":["<!-- ai问答界面 -->\r\n<template>\n  <!-- 中文注释：聊天页自行管理滚动，因此关闭 AppLayout 外层滚动（非 H5 有效） -->\n  <AppLayout current=\"pages/chat/index\" :content-scroll=\"false\">\n    <view class=\"chat-page\" :class=\"isDesktop ? 'layout-desktop' : 'layout-mobile'\">\n      <!-- 桌面端：并排布局 -->\n      <template v-if=\"isDesktop\">\n        <ChatSidebar\n          :conversations=\"conversations\"\n          :current-conversation-id=\"currentConversationId\"\n          :collapsed=\"sidebarCollapsed\"\n          @create-chat=\"createNewChat\"\n          @select-conversation=\"selectConversation\"\n          @edit-conversation=\"editConversationTitle\"\n          @delete-conversation=\"deleteConversation\"\n          @toggle-collapse=\"sidebarCollapsed = !sidebarCollapsed\"\n        />\n\n        <view class=\"chat-main\">\n          <ChatHeader\r\n            :conversation=\"currentConversation\"\n            :show-toggle=\"false\"\n            @toggle-sidebar=\"noop\"\n          />\r\n\t\t  \r\n\t\t  <!-- 添加消息列表容器，遍历每条消息 -->\n          <view class=\"message-list-container\" ref=\"h5MessageListRef\">\n\t\t\t  <!-- \r\n\t\t\t    <view class=\"debug-info\" style=\"padding: 10rpx; background: #f0f0f0; color: red; font-size: 24rpx;\">\r\n              <text>调试: 消息数量 {{ currentMessages.length }}</text>\r\n            </view>\r\n\t\t\t   \r\n\t\t\t   -->\n          <ChatMessage\n            v-for=\"(msg, index) in currentMessages\"\n            :key=\"msg.id || index\"\n            :message=\"msg\"\n            @feedback=\"handleMessageFeedback\"\n            @edit=\"handleMessageEdit\"\n            @request-edit=\"handleRequestEdit\"\n          />\n          <!-- 底部锚点：用于滚动到底（H5/MP 通用） -->\n          <view :id=\"bottomAnchorId\" style=\"height:1px;width:100%;\"></view>\n\t\t  \n\t\t  </view>\n\t\t  <!-- 遍历结束 -->\r\n\t\t  \r\n\t\t  <!-- 输入组件 -->\n          <ChatInput\n            ref=\"chatInputRef\"\n            :is-generating=\"isGenerating\"\n            @send-message=\"handleSendMessage\"\n            @stop-generating=\"stopGenerating\"\n            @clear-conversation=\"clearCurrentConversation\"\n            @add-attachment=\"handleAddAttachment\"\n          />\n        </view>\n      </template>\n\n      <!-- 移动端：顶部 Header + 抽屉 + 聊天区 -->\n      <template v-else>\n        <ChatHeader\n          :conversation=\"currentConversation\"\n          :show-toggle=\"true\"\n          @toggle-sidebar=\"toggleMobileSidebar\"\n        />\n\n        <view class=\"mobile-chat-container\">\n          <!-- 使用官方 uni-popup 统一抽屉与遮罩（跨端更稳） -->\n          <uni-popup\n            ref=\"sidebarPopup\"\n            type=\"left\"\n            :is-mask-click=\"false\"\n            @change=\"onSidebarPopupChange\"\n          >\n            <view class=\"popup-drawer\" :style=\"popupDrawerStyle\">\n              <!-- 抽屉场景不使用 collapsed -->\n              <ChatSidebar\n                :conversations=\"conversations\"\n                :current-conversation-id=\"currentConversationId\"\n                :collapsed=\"false\"\n                @create-chat=\"handleMobileCreateChat\"\n                @select-conversation=\"handleMobileSelectConversation\"\n                @edit-conversation=\"editConversationTitle\"\n                @delete-conversation=\"deleteConversation\"\n                @toggle-collapse=\"closeMobileSidebar\"\n              />\n            </view>\n          </uni-popup>\n\n          <!-- 聊天区域 -->\n          <view class=\"mobile-chat-main\">\n\t\t\t  <!--添加消息列表容器，遍历每条消息 -->\r\n\t\t\t  \r\n\t\t\t  <!-- \r\n\t\t\t   <view class=\"debug-info\" style=\"padding: 10rpx; background: #f0f0f0; color: red; font-size: 24rpx;\">\r\n\t\t\t     <text>调试: 消息数量 {{ currentMessages.length }}</text>\r\n\t\t\t   </view>\r\n\t\t\t   -->\r\n              <!-- #ifdef MP -->\n              <!-- 中文注释：小程序端使用 scroll-view 作为消息列表滚动容器，保证头部与输入固定 -->\n              <scroll-view\n                class=\"message-list-container\"\n                scroll-y\n                enable-flex\n                :scroll-into-view=\"scrollIntoView\"\n                :scroll-top=\"mpScrollTop\"\n                :lower-threshold=\"80\"\n                @scroll=\"onMpScroll\"\n                @scrolltolower=\"onMpScrollToLower\"\n              >\n                <ChatMessage\n                  v-for=\"(msg, index) in currentMessages\"\n                  :key=\"msg.id || index\"\n                  :message=\"msg\"\n                  @feedback=\"handleMessageFeedback\"\n                  @edit=\"handleMessageEdit\"\r\n                  @request-edit=\"handleRequestEdit\"\n                />\n                <view :id=\"bottomAnchorId\" style=\"height:1px;width:100%;\"></view>\n              </scroll-view>\n              <!-- #endif -->\n\n              <!-- #ifndef MP -->\n              <!-- 中文注释：H5/APP 端由容器自身滚动 -->\n              <view class=\"message-list-container\" ref=\"h5MessageListRef\">\n                <ChatMessage\n                  v-for=\"(msg, index) in currentMessages\"\n                  :key=\"msg.id || index\"\n                  :message=\"msg\"\n                  @feedback=\"handleMessageFeedback\"\n                  @request-edit=\"handleRequestEdit\"\n                />\n                <view :id=\"bottomAnchorId\" style=\"height:1px;width:100%;\"></view>\n              </view>\n              <!-- #endif -->\n\t\t\t  <!-- 遍历结束 -->\n           \n            <ChatInput\r\n\t\t\t  ref=\"chatInputRef\"\n              :is-generating=\"isGenerating\"\n              @send-message=\"handleSendMessage\"\n              @stop-generating=\"stopGenerating\"\n              @clear-conversation=\"clearCurrentConversation\"\n              @add-attachment=\"handleAddAttachment\"\n            />\n          </view>\n        </view>\n      </template>\n    </view>\n\t\r\n\t<!-- 添加调试信息 -->\r\n\t    <view v-if=\"false\" class=\"debug-info\" style=\"position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; z-index: 9999;\">\r\n\t      <text>当前消息数: {{ currentMessages.length }}</text>\r\n\t      <text v-for=\"(msg, index) in currentMessages\" :key=\"index\">\r\n\t        {{ index }}: {{ msg.role }} - {{ typeof msg.content === 'string' ? msg.content.substring(0, 20) : '对象' }}\r\n\t      </text>\r\n\t    </view>\n  </AppLayout>\n</template>\n\n<script setup>\r\nimport { chatStream } from '@/utils/request.js'\nimport { ref, computed, onMounted, onUnmounted, watch, nextTick } from 'vue'\nimport { usePlatformInfo } from '@/utils/platform'\nimport { useSafeArea } from '@/utils/safe-area'\nimport AppLayout from '@/components/layout/AppLayout.vue'\nimport ChatSidebar from '@/components/chat/ChatSidebar.vue'\nimport ChatHeader from '@/components/chat/ChatHeader.vue'\nimport ChatMessage from '@/components/chat/ChatMessage.vue'\nimport ChatInput from '@/components/chat/ChatInput.vue'\r\n\r\nimport { onShow } from '@dcloudio/uni-app'\nimport { navTitleStore } from '@/stores/navTitle.js'\n\r\n//设置头部导航栏title\r\nconst navTitle = navTitleStore()\nonShow(() => navTitle.setTitle('环保通用AI问答'))\r\n\nconst { isDesktop } = usePlatformInfo()\n// 中文注释：安全区信息，用于顶部（状态栏+自定义导航）与 H5 安全区计算\nconst { statusBarHeightPx, navBarHeightPx, totalNavHeightPx } = useSafeArea()\n\n// ====== 状态 ======\nconst conversations = ref([])\nconst currentConversationId = ref('')\nconst isGenerating = ref(false)\nconst sidebarCollapsed = ref(false)     // 仅桌面端使用\nconst mobileSidebarVisible = ref(false) // 仅移动端使用\nconst sidebarPopup = ref(null)          // 仅移动端：uni-popup 抽屉实例\nconst cancelGenerate = ref(null) // 用于停止对话生成\r\n\nconst chatInputRef = ref(null)\r\n\r\n\n// ====== 计算 ======\nconst currentConversation = computed(() => {\n  return (\n    conversations.value.find((c) => c.id === currentConversationId.value) || {\n      id: '',\n      title: '新对话',\n      messages: [],\n    }\n  )\n})\nconst currentMessages = computed(() => currentConversation.value.messages || [])\n\n// ====== 滚动与定位（仅消息区域滚动）======\n// 中文注释：H5/PC 使用普通容器滚动；小程序使用 scroll-view\nconst h5MessageListRef = ref(null) // H5/PC 消息列表容器引用\nconst bottomAnchorId = 'chat-bottom-anchor' // 底部锚点ID\nconst scrollIntoView = ref('') // 小程序滚动到锚点\nconst mpScrollTop = ref(0) // 小程序滚动位置（用于恢复指定位置）\nconst mpLastScrollTop = ref(0)\nconst autoFollow = ref(true) // 是否跟随新消息自动滚动到底\nconst scrollPositions = ref({}) // 每个对话的滚动位置记录：{ [id]: { top } }\n\nfunction isNearBottom(el, threshold = 60) {\n  try {\n    const remain = el.scrollHeight - el.scrollTop - el.clientHeight\n    return remain <= threshold\n  } catch (e) { return true }\n}\n\nfunction scrollToBottom() {\n  try {\n    // #ifdef MP\n    // 中文注释：通过锚点滚到底，更稳\n    scrollIntoView.value = ''\n    nextTick(() => { scrollIntoView.value = bottomAnchorId })\n    // #endif\n    // #ifndef MP\n    const el = h5MessageListRef.value\n    if (el) el.scrollTop = el.scrollHeight\n    // #endif\n  } catch (e) {}\n}\n\nfunction saveScrollPos(id) {\n  try {\n    const key = id || currentConversationId.value\n    if (!key) return\n    // #ifdef MP\n    scrollPositions.value[key] = { top: Number(mpLastScrollTop.value || 0) }\n    // #endif\n    // #ifndef MP\n    const el = h5MessageListRef.value\n    scrollPositions.value[key] = { top: el ? Number(el.scrollTop || 0) : 0 }\n    // #endif\n  } catch (e) {}\n}\n\nfunction restoreScrollPos(id) {\n  try {\n    const key = id || currentConversationId.value\n    const saved = (key && scrollPositions.value[key]) ? Number(scrollPositions.value[key].top || 0) : null\n    if (saved != null && saved > 0) {\n      // #ifdef MP\n      scrollIntoView.value = ''\n      mpScrollTop.value = saved\n      // #endif\n      // #ifndef MP\n      const el = h5MessageListRef.value\n      if (el) el.scrollTop = saved\n      // #endif\n    } else {\n      if (autoFollow.value) scrollToBottom()\n    }\n  } catch (e) {}\n}\n\n// 小程序滚动事件：上滑暂停自动跟随；到底恢复自动跟随\nfunction onMpScroll(e) {\n  try {\n    const top = Number(e?.detail?.scrollTop || 0)\n    if (top + 30 < mpLastScrollTop.value) autoFollow.value = false\n    mpLastScrollTop.value = top\n    if (currentConversationId.value) {\n      scrollPositions.value[currentConversationId.value] = { top }\n    }\n  } catch (e) {}\n}\nfunction onMpScrollToLower() {\n  autoFollow.value = true\n}\n\n// H5/PC 监听容器滚动，计算是否在底部\nlet h5ScrollHandler = null\nfunction bindH5ScrollListener() {\n  try {\n    // #ifdef H5\n    const el = h5MessageListRef.value\n    if (!el) return\n    if (h5ScrollHandler) el.removeEventListener('scroll', h5ScrollHandler)\n    h5ScrollHandler = () => {\n      try {\n        const near = isNearBottom(el)\n        autoFollow.value = near\n        if (currentConversationId.value) {\n          scrollPositions.value[currentConversationId.value] = { top: Number(el.scrollTop || 0) }\n        }\n      } catch (e) {}\n    }\n    el.addEventListener('scroll', h5ScrollHandler)\n    // #endif\n  } catch (e) {}\n}\nfunction unbindH5ScrollListener() {\n  try {\n    // #ifdef H5\n    const el = h5MessageListRef.value\n    if (el && h5ScrollHandler) el.removeEventListener('scroll', h5ScrollHandler)\n    h5ScrollHandler = null\n    // #endif\n  } catch (e) {}\n}\n\n// 桌面/移动切换时，切到桌面强制关闭抽屉，避免残留挡点击\nwatch(isDesktop, (d) => {\n  // 中文注释：切到桌面端强制关闭移动抽屉，避免残留遮罩挡点击\n  if (d) {\n    mobileSidebarVisible.value = false\n    try { sidebarPopup.value?.close?.() } catch (e) {}\n  }\n})\n\n// 切换会话：保存旧会话滚动，恢复新会话滚动\nwatch(currentConversationId, (newId, oldId) => {\n  try { if (oldId) saveScrollPos(oldId) } catch (e) {}\n  nextTick(() => restoreScrollPos(newId))\n})\n\n// 中文注释：抽屉开关统一通过 uni-popup 控制，保证跨端遮罩/定位稳定\nconst toggleMobileSidebar = () => {\n  if (mobileSidebarVisible.value) {\n    try { sidebarPopup.value?.close?.() } catch (e) {}\n  } else {\n    try { sidebarPopup.value?.open?.('left') } catch (e) {}\n  }\n}\nconst closeMobileSidebar = () => {\n  try { sidebarPopup.value?.close?.() } catch (e) {}\n}\nconst onSidebarPopupChange = (e) => {\n  // e = { show: Boolean }\n  if (e && typeof e.show === 'boolean') {\n    mobileSidebarVisible.value = !!e.show\n  }\n}\nconst noop = () => {}\n\n// 中文注释：抽屉顶部安全区内边距样式（MP 使用状态栏高度，H5 使用 CSS 变量/环境变量）\nconst popupDrawerStyle = computed(() => {\n  try {\n    // #ifdef MP\n    // 中文注释：抽屉顶部预留总导航高度，避免被状态栏/胶囊遮挡\n    return `padding-top: ${Number(totalNavHeightPx?.value || 0)}px;`\n    // #endif\n    // #ifdef H5\n    // 中文注释：H5 顶部同时考虑状态栏安全区与自定义导航高度（统一按 44px 兜底）\n    const navH = Number(navBarHeightPx?.value || 44)\n    return `padding-top: calc(${navH}px + constant(safe-area-inset-top)); padding-top: calc(${navH}px + env(safe-area-inset-top));`\n    // #endif\n  } catch (e) {\n    return ''\n  }\n})\n\n// 初始化，if没有对话就自动创建新对话\nonMounted(() => {\n  loadConversations()\n  // 只有在完全没有对话数据时才创建新对话\n  // 避免重复创建\n  if (conversations.value.length === 0) {\n    createNewChat()\n  } else {\n    console.log('初始化：使用已有对话，数量:', conversations.value.length)\n  }\n})\n\r\nwatch(isGenerating, (newVal) => {\n  // console.log('isGenerating 状态变化:', newVal)\n})\n\nwatch(currentMessages, () => {\n  // 中文注释：有新消息且开启自动跟随时滚动到底\n  nextTick(() => { if (autoFollow.value) scrollToBottom() })\n}, { deep: true })\n\n// 中文注释：初次进入自动滚到底，并绑定 H5 滚动监听\nonMounted(() => {\n  nextTick(() => {\n    autoFollow.value = true\n    scrollToBottom()\n    bindH5ScrollListener()\n  })\n})\n\nonUnmounted(() => {\n  unbindH5ScrollListener()\n})\n\r\n\n// ====== 对话 CRUD ======\nfunction loadConversations() {\n  try {\n    const saved = uni.getStorageSync('chat_conversations')\n    if (saved) {\n      conversations.value = JSON.parse(saved)\n      // 确保当前对话ID有效\n      if (conversations.value.length > 0) {\n        currentConversationId.value = conversations.value[0]?.id || ''\n      }\n    }\n  } catch (e) {\n    console.error(e)\n  }\n}\r\n\r\n// 修改 saveConversations 函数确保触发响应式更新\nfunction saveConversations() {\n  try {\n    // 强制触发响应式更新\n    conversations.value = [...conversations.value]\n    uni.setStorageSync('chat_conversations', JSON.stringify(conversations.value))\n    // console.log('保存对话完成，当前消息:', currentMessages.value)\n  } catch (e) {\n    console.error('保存对话失败:', e)\n  }\n}\r\n\r\n// create新对话\nfunction createNewChat() {\n  // 检查是否已经有空对话，避免重复创建\n  const existingEmptyConv = conversations.value.find(conv => \n    !conv.title || conv.title === '新对话' || conv.messages.length === 0\n  )\n  \n  if (existingEmptyConv) {\n    console.log('已有空对话，切换到:', existingEmptyConv.id)\n    currentConversationId.value = existingEmptyConv.id\n    return\n  }\n  \n  const chat = {\n    id: 'conv_' + Date.now(),\n    title: '新对话',\n    createdAt: Date.now(),\n    messages: [],\n  }\n  conversations.value.unshift(chat)\n  currentConversationId.value = chat.id\n  saveConversations()\n  console.log('创建新对话:', chat.id)\n}\r\n\r\n\nfunction selectConversation(id) {\n  currentConversationId.value = id\n}\nfunction handleMobileCreateChat() {\n  createNewChat()\n  closeMobileSidebar()\n}\nfunction handleMobileSelectConversation(id) {\n  selectConversation(id)\n  closeMobileSidebar()\n}\n\nfunction editConversationTitle(id, newTitle) {\n  const conv = conversations.value.find((c) => c.id === id)\n  if (conv) {\n    conv.title = newTitle\n    saveConversations()\n  }\n}\nfunction deleteConversation(id) {\n  const i = conversations.value.findIndex((c) => c.id === id)\n  if (i !== -1) {\n    conversations.value.splice(i, 1)\n    if (currentConversationId.value === id)\n      currentConversationId.value = conversations.value[0]?.id || ''\n    saveConversations()\n  }\n}\n\n// 发送消息\nasync function handleSendMessage(messageData) {\n  const conv = conversations.value.find((c) => c.id === currentConversationId.value)\n  if (!conv) return\n  \n  \n  // 修复：正确提取 content 和 attachments\n  const content = typeof messageData === 'string' \n    ? messageData \n    : (messageData.content || '')\n  \n  const attachments = messageData.attachments || []\n  \n  // 创建用户消息 - 确保 content 是字符串\n  const userMsg = {\n    id: 'msg_' + Date.now(),\n    role: 'user',\n    content: content, // 直接使用字符串\n    attachments,\n    timestamp: Date.now(),\n  }\n  \n  \n  // 添加到消息列表\n  conv.messages.push(userMsg)\n  isGenerating.value = true\n  \r\n   // 如果是新对话或默认标题，根据输入自动生成标题\r\n   if (!conv.title || conv.title === '新对话') {\r\n     conv.title = generateTitleFromText(userMsg.content)\r\n   }\r\n  \n  // 立即保存，确保用户消息显示\n  saveConversations()\n  \n  // 等待DOM更新\n  await nextTick()\n  \n  // 调用AI生成回复\n  await generateAIResponse(conv, userMsg)\n}\r\n\r\n// ai问答接口\nasync function generateAIResponse(conv, userMsg) {\n  \n  // 1) 先推一个空的 AI 消息用于前端累加展示\n  const aiMsg = {\n    id: 'msg_' + Date.now(),\n    role: 'assistant',\n    content: '',\n    timestamp: Date.now()\n  }\n  conv.messages.push(aiMsg)\n  \n  \n  // 立即保存到存储，确保消息列表更新\n  saveConversations()\n  \n  // 等待DOM更新\n  await nextTick()\n  // console.log('DOM更新后检查消息列表')\n\n  // 2) 规范化消息函数保持不变...\n  function normalizeMessagesForBackend(messages) {\n    return messages\n      .map(m => {\n        if (typeof m.content === 'string') {\n          return { role: m.role, content: m.content.trim() }\n        }\n        const { content = '', attachments = [] } = m.content || {}\n        const attachText = attachments.length\n          ? attachments.map(a => `\\n[附件：${a.name || a.url}]`).join('')\n          : ''\n        return { role: m.role, content: (content + attachText).trim() }\n      })\n      .filter(m => m.content && m.content.length > 0)\n      .slice(-30)\n  }\n\n  const body = {\n    model: 'qwen3-max',\n    modelName: 'qwen3-max',\n    messages: normalizeMessagesForBackend(conv.messages),\n    stream: true\n  }\n\n  // console.log('发送给后端的消息:', body)\n\n  // 4) 调用后端流式接口\n  try {\n    // 中文注释：在流式回调中做 UI 与存储节流，减少频繁重渲染与磁盘写入\n    let uiTimer = null\n    let lastSave = 0\n\n    function flushUI() {\n      const messageIndex = conv.messages.findIndex(m => m.id === aiMsg.id)\n      if (messageIndex !== -1) {\n        const newMessages = [...conv.messages]\n        newMessages[messageIndex] = { ...aiMsg }\n        conv.messages = newMessages\n      }\n      uiTimer = null\n      // 存储节流：500ms 至少落盘一次\n      const now = Date.now()\n      if (now - lastSave > 500) {\n        lastSave = now\n        saveConversations()\n      }\n    }\n\n    cancelGenerate.value = chatStream(\n      body,\n      (delta) => {               // onDelta\n        aiMsg.content += delta\n        if (!uiTimer) {\n          uiTimer = setTimeout(flushUI, 80) // 约 12fps 刷新\n        }\n      },\n      () => {                    \n        // 结束前强制刷新与保存，确保最终内容一致\n        try {\n          if (uiTimer) { clearTimeout(uiTimer); uiTimer = null }\n          flushUI()\n        } catch (e) {}\n        isGenerating.value = false\n        cancelGenerate.value = null\n        saveConversations()\n      },\n      (err) => {                 \n        console.error('AI回复错误:', err)\n        aiMsg.content += `\\n[错误] ${err?.message || err}`\n        try {\n          if (uiTimer) { clearTimeout(uiTimer); uiTimer = null }\n          flushUI()\n        } catch (e) {}\n        isGenerating.value = false\n        cancelGenerate.value = null\n        saveConversations()\n      }\n    )\n  } catch (error) {\n    console.error('生成AI回复时发生异常:', error)\n    // 异常情况下也要重置状态\n    isGenerating.value = false\n    cancelGenerate.value = null\n  }\n  \n}\r\n\r\n// 停止对话生成\nfunction stopGenerating() {\n  isGenerating.value = false\n  if (cancelGenerate.value) {\n    try { cancelGenerate.value() } catch (e) {}\n    cancelGenerate.value = null\n  }\n}\r\n\r\n\nfunction clearCurrentConversation() {\n  const conv = conversations.value.find((c) => c.id === currentConversationId.value)\n  if (conv) {\n    conv.messages = []\n    saveConversations()\n  }\n}\r\n\nfunction handleMessageFeedback(messageId, feedback) {\n  const conv = conversations.value.find((c) => c.id === currentConversationId.value)\n  if (!conv) return\n  const i = conv.messages.findIndex((m) => m.id === messageId)\n  if (i !== -1) {\n    conv.messages[i].feedback = feedback\n    saveConversations()\n  }\n}\r\n\nfunction handleMessageEdit(messageId, newContent) {\n  const conv = conversations.value.find((c) => c.id === currentConversationId.value)\n  if (!conv) return\n  const i = conv.messages.findIndex((m) => m.id === messageId)\n  if (i !== -1) {\n    conv.messages[i].content = newContent\n    saveConversations()\n  }\n}\r\n\r\n// 点击“编辑”→ 回填到输入框（文本 + 附件）\nfunction handleRequestEdit(msg) {\n   try {\n     chatInputRef.value?.setDraft(msg?.content || '', msg?.attachments || [])\n   } catch (e) {\n     console.error('回填草稿失败:', e)\n   }\n}\r\n\r\n// 根据用户输入生成会话标题\n function generateTitleFromText(text = '') {\n   // 取第一行/第一句，移除多空格与换行\n   let s = (text || '').trim().replace(/\\s/g, ' ')\n   // 如果包含中文标点或句号，截取第一句\n   const firstEnd = s.search(/[。！？!?\\.]/)\n   if (firstEnd > 0) s = s.slice(0, firstEnd)\n   // 去除首尾标点\n   s = s.replace(/^[~#\\-\\s、，,。!?！?【】\\[\\]\\(\\)（）]|[~#\\-\\s、，,。!?！?【】\\[\\]\\(\\)（）]$/g, '')\n   // 限制长度（例如 20～24 个字符）\n   const maxLen = 10\n   if (s.length > maxLen) s = s.slice(0, maxLen) + '…'\n   // 兜底：如为空\n   return s || '新对话'\n }\r\n\nfunction handleAddAttachment(file) {\n  // 附件逻辑可直接接上\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.chat-page {\n  display: flex;\n  flex: 1;\n  min-height: 0;\n  background: #ffffff;\n  border-radius: 15rpx;\r\n  height: 84vh;\r\n\n}\n\n/* 桌面：右侧聊天主区域 */\n.chat-main {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  min-width: 0;\n  min-height: 0;\n  height: 100%;\n}\n\r\n/* 桌面：左右并排；移动：上下（Header + 内容） */\n.chat-page.layout-desktop { flex-direction: row; }\n.chat-page.layout-mobile  { flex-direction: column; }\n\n/* 移动端容器（扣掉 header 高度） */\n.mobile-chat-container {\n  flex: 1;                   /* 关键：跟随父容器纵向伸展 */\n  position: relative;\n  display: flex;\n  flex-direction: column;\n  min-height: 0;\r\n}\n\n/* 抽屉容器（uni-popup 内容区），统一宽度与背景 */\n.popup-drawer {\n  max-width: 640rpx;\n  height: 100dvh;\n  height: 100vh; /* 回退 */\n  background: #ffffff;\n}\n/* 顶部安全区：H5 使用 env/变量；MP 通过内联样式设置 */\n.popup-drawer {\n  padding-top: var(--safe-top, 0px);\n  padding-top: constant(safe-area-inset-top);\n  padding-top: env(safe-area-inset-top);\n}\n\n/* 移动端聊天区域 */\n.mobile-chat-main {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  min-height: 0;\n  min-width: 0;\n  overflow: hidden;\n}\r\n\n\n.message-list-container {\n  flex: 1;\n  padding: 18rpx;\n  min-height: 0; \n  /* 中文注释：中间消息列表承担滚动 */\n  overflow-y: auto;\n  /* 中文注释：H5 防止滚动穿透/链式滚动，提升滚动体验 */\n  overscroll-behavior: contain;\n  -webkit-overflow-scrolling: touch;\n}\n\n/* 确保滚动正常工作 */\n.message-list-container::-webkit-scrollbar {\n  width: 6rpx;\n}\n\n.message-list-container::-webkit-scrollbar-thumb {\n  background: #cbd5e1;\n  border-radius: 3rpx;\n}\n\n.message-list-container::-webkit-scrollbar-thumb:hover {\n  background: #94a3b8;\n}\n\n</style>\n","import MiniProgramPage from 'C:/Users/97247/Desktop/uni-ecoful/pages/chat/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["navTitleStore","onShow","usePlatformInfo","useSafeArea","ref","computed","nextTick","e","watch","onMounted","uni","onUnmounted","chatStream"],"mappings":"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"}