{"version":3,"file":"index.js","sources":["pages/chat/index.vue","../../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdC9pbmRleC52dWU"],"sourcesContent":["<!-- ai问答界面 -->\r\n<template>\r\n\t<!-- 中文注释：聊天页自行管理滚动，因此关闭 AppLayout 外层滚动（非 H5 有效） -->\r\n\t<AppLayout current=\"pages/chat/index\" :content-scroll=\"false\">\r\n\t\t<view class=\"chat-page\" :class=\"isDesktop ? 'layout-desktop' : 'layout-mobile'\" :style=\"!isDesktop ? { height: `calc(100vh - ${totalNavHeightPx}px)` } : {}\">\r\n\t\t\t<!-- 桌面端：并排布局 -->\r\n\t\t\t<template v-if=\"isDesktop\">\r\n\t\t\t\t<ChatSidebar :conversations=\"conversations\" :current-conversation-id=\"currentConversationId\"\r\n\t\t\t\t\t:collapsed=\"sidebarCollapsed\" @create-chat=\"createNewChat\" @select-conversation=\"selectConversation\"\r\n\t\t\t\t\t@edit-conversation=\"editConversationTitle\" @delete-conversation=\"deleteConversation\"\r\n\t\t\t\t\t@toggle-collapse=\"sidebarCollapsed = !sidebarCollapsed\" />\r\n\r\n\t\t\t\t<view class=\"chat-main\">\r\n\t\t\t\t\t<ChatHeader :conversation=\"currentConversation\" :show-toggle=\"false\" @toggle-sidebar=\"noop\" />\r\n\r\n\t\t\t\t\t<!-- 添加消息列表容器，遍历每条消息 -->\r\n\t\t\t\t\t<view class=\"message-list-container\" ref=\"h5MessageListRef\">\r\n\t\t\t\t\t\t<ChatMessage v-for=\"(msg, index) in currentMessages\" :key=\"msg.id || index\" :message=\"msg\"\r\n\t\t\t\t\t\t\t@feedback=\"handleMessageFeedback\" @edit=\"handleMessageEdit\"\r\n\t\t\t\t\t\t\t@request-edit=\"handleRequestEdit\" />\r\n\t\t\t\t\t\t<!-- 底部锚点：用于滚动到底（H5/MP 通用） -->\r\n\t\t\t\t\t\t<view :id=\"bottomAnchorId\" style=\"height:1px;width:100%;\"></view>\r\n\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<!-- 遍历结束 -->\r\n\r\n\t\t\t\t\t<!-- 输入组件 -->\r\n\t\t\t\t\t<ChatInput ref=\"chatInputRef\" :is-generating=\"isGenerating\" @send-message=\"handleSendMessage\"\r\n\t\t\t\t\t\t@stop-generating=\"stopGenerating\" @clear-conversation=\"clearCurrentConversation\"\r\n\t\t\t\t\t\t@add-attachment=\"handleAddAttachment\" />\r\n\t\t\t\t</view>\r\n\t\t\t</template>\r\n\r\n\t\t\t<!-- 移动端：顶部 Header + 抽屉 + 聊天区 -->\r\n\t\t\t<template v-else>\r\n\t\t\t\t<ChatHeader :conversation=\"currentConversation\" :show-toggle=\"true\"\r\n\t\t\t\t\t@toggle-sidebar=\"toggleMobileSidebar\" />\r\n\r\n\t\t\t\t<view class=\"mobile-chat-container\">\r\n\t\t\t\t\t<!-- 使用官方 uni-popup 统一抽屉与遮罩（跨端更稳） -->\r\n\t\t\t\t\t<uni-popup ref=\"sidebarPopup\" type=\"left\" :is-mask-click=\"false\" @change=\"onSidebarPopupChange\">\r\n\t\t\t\t\t\t<view class=\"popup-drawer\" :style=\"popupDrawerStyle\">\r\n\t\t\t\t\t\t\t<!-- 抽屉场景不使用 collapsed -->\r\n\t\t\t\t\t\t\t<ChatSidebar :conversations=\"conversations\" :current-conversation-id=\"currentConversationId\"\r\n\t\t\t\t\t\t\t\t:collapsed=\"false\" @create-chat=\"handleMobileCreateChat\"\r\n\t\t\t\t\t\t\t\t@select-conversation=\"handleMobileSelectConversation\"\r\n\t\t\t\t\t\t\t\t@edit-conversation=\"editConversationTitle\" @delete-conversation=\"deleteConversation\"\r\n\t\t\t\t\t\t\t\t@toggle-collapse=\"closeMobileSidebar\" />\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</uni-popup>\r\n\r\n\t\t\t\t\t<!-- 聊天区域 -->\r\n\t\t\t\t\t<view class=\"mobile-chat-main\">\r\n\t\t\t\t\t\t<!--添加消息列表容器，遍历每条消息 -->\r\n\r\n\t\t\t\t\t\t<!-- \r\n\t\t\t   <view class=\"debug-info\" style=\"padding: 10rpx; background: #f0f0f0; color: red; font-size: 24rpx;\">\r\n\t\t\t     <text>调试: 消息数量 {{ currentMessages.length }}</text>\r\n\t\t\t   </view>\r\n\t\t\t   -->\r\n\t\t\t\t\t\t<!-- #ifdef MP -->\r\n\t\t\t\t\t\t<!-- 中文注释：小程序端使用 scroll-view 作为消息列表滚动容器，保证头部与输入固定 -->\r\n\t\t\t\t\t\t<scroll-view class=\"message-list-container\" scroll-y enable-flex\r\n\t\t\t\t\t\t\t:scroll-into-view=\"scrollIntoView\" :scroll-top=\"mpScrollTop\" :lower-threshold=\"80\"\r\n\t\t\t\t\t\t\t@scroll=\"onMpScroll\" @scrolltolower=\"onMpScrollToLower\">\r\n\t\t\t\t\t\t\t<ChatMessage v-for=\"(msg, index) in currentMessages\" :key=\"msg.id || index\" :message=\"msg\"\r\n\t\t\t\t\t\t\t\t@feedback=\"handleMessageFeedback\" @edit=\"handleMessageEdit\"\r\n\t\t\t\t\t\t\t\t@request-edit=\"handleRequestEdit\" />\r\n\t\t\t\t\t\t\t<view :id=\"bottomAnchorId\" style=\"height:1px;width:100%;\"></view>\r\n\t\t\t\t\t\t</scroll-view>\r\n\t\t\t\t\t\t<!-- #endif -->\r\n\r\n\t\t\t\t\t\t<!-- #ifndef MP -->\r\n\t\t\t\t\t\t<!-- 中文注释：H5/APP 端由容器自身滚动 -->\r\n\t\t\t\t\t\t<view class=\"message-list-container\" ref=\"h5MessageListRef\">\r\n\t\t\t\t\t\t\t<ChatMessage v-for=\"(msg, index) in currentMessages\" :key=\"msg.id || index\" :message=\"msg\"\r\n\t\t\t\t\t\t\t\t@feedback=\"handleMessageFeedback\" @request-edit=\"handleRequestEdit\" />\r\n\t\t\t\t\t\t\t<view :id=\"bottomAnchorId\" style=\"height:1px;width:100%;\"></view>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<!-- #endif -->\r\n\t\t\t\t\t\t<!-- 遍历结束 -->\r\n\r\n\t\t\t\t\t\t<ChatInput ref=\"chatInputRef\" :is-generating=\"isGenerating\" @send-message=\"handleSendMessage\"\r\n\t\t\t\t\t\t\t@stop-generating=\"stopGenerating\" @clear-conversation=\"clearCurrentConversation\"\r\n\t\t\t\t\t\t\t@add-attachment=\"handleAddAttachment\" />\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</template>\r\n\t\t</view>\r\n\r\n\t\t<!-- 添加调试信息 -->\r\n\t\t<view v-if=\"false\" class=\"debug-info\"\r\n\t\t\tstyle=\"position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; z-index: 9999;\">\r\n\t\t\t<text>当前消息数: {{ currentMessages.length }}</text>\r\n\t\t\t<text v-for=\"(msg, index) in currentMessages\" :key=\"index\">\r\n\t\t\t\t{{ index }}: {{ msg.role }} -\r\n\t\t\t\t{{ typeof msg.content === 'string' ? msg.content.substring(0, 20) : '对象' }}\r\n\t\t\t</text>\r\n\t\t</view>\r\n\t</AppLayout>\r\n</template>\r\n\r\n<script setup>\r\n\timport {\r\n\t\trequest\r\n\t} from '@/utils/request.js'\r\n\timport {\r\n\t\tref,\r\n\t\tcomputed,\r\n\t\tonMounted,\r\n\t\tonUnmounted,\r\n\t\twatch,\r\n\t\tnextTick\r\n\t} from 'vue'\r\n\timport {\r\n\t\tusePlatformInfo\r\n\t} from '@/utils/platform'\r\n\timport {\r\n\t\tuseSafeArea\r\n\t} from '@/utils/safe-area'\r\n\timport AppLayout from '@/components/layout/AppLayout.vue'\r\n\timport ChatSidebar from '@/components/chat/ChatSidebar.vue'\r\n\timport ChatHeader from '@/components/chat/ChatHeader.vue'\r\n\timport ChatMessage from '@/components/chat/ChatMessage.vue'\r\n\timport ChatInput from '@/components/chat/ChatInput.vue'\r\n\r\n\timport {\r\n\t\tonShow\r\n\t} from '@dcloudio/uni-app'\r\n\timport {\r\n\t\tnavTitleStore\r\n\t} from '@/stores/navTitle.js'\r\n\r\n\t//设置头部导航栏title\r\n\tconst navTitle = navTitleStore()\r\n\tonShow(() => navTitle.setTitle('环保通用AI问答'))\r\n\r\n\tconst {\r\n\t\tisDesktop\r\n\t} = usePlatformInfo()\r\n\t// 中文注释：安全区信息，用于顶部（状态栏+自定义导航）与 H5 安全区计算\r\n\tconst {\r\n\t\tstatusBarHeightPx,\r\n\t\tnavBarHeightPx,\r\n\t\ttotalNavHeightPx,\r\n\t\tsafeAreaBottomPx\r\n\t} = useSafeArea()\r\n\r\n\t// ====== 状态 ======\r\n\tconst conversations = ref([])\r\n\tconst currentConversationId = ref('')\r\n\tconst isGenerating = ref(false)\r\n\tconst sidebarCollapsed = ref(false) // 仅桌面端使用\r\n\tconst mobileSidebarVisible = ref(false) // 仅移动端使用\r\n\tconst sidebarPopup = ref(null) // 仅移动端：uni-popup 抽屉实例\r\n\tconst cancelGenerate = ref(null) // 用于停止对话生成\r\n\r\n\tconst chatInputRef = ref(null)\r\n\r\n\r\n\t// ====== 计算 ======\r\n\tconst currentConversation = computed(() => {\r\n\t\treturn (\r\n\t\t\tconversations.value.find((c) => c.id === currentConversationId.value) || {\r\n\t\t\t\tid: '',\r\n\t\t\t\ttitle: '新对话',\r\n\t\t\t\tmessages: [],\r\n\t\t\t}\r\n\t\t)\r\n\t})\r\n\tconst currentMessages = computed(() => currentConversation.value.messages || [])\r\n\r\n\t// ====== 滚动与定位（仅消息区域滚动）======\r\n\t// 中文注释：H5/PC 使用普通容器滚动；小程序使用 scroll-view\r\n\tconst h5MessageListRef = ref(null) // H5/PC 消息列表容器引用\r\n\tconst bottomAnchorId = 'chat-bottom-anchor' // 底部锚点ID\r\n\tconst scrollIntoView = ref('') // 小程序滚动到锚点\r\n\tconst mpScrollTop = ref(0) // 小程序滚动位置（用于恢复指定位置）\r\n\tconst mpLastScrollTop = ref(0)\r\n\tconst autoFollow = ref(true) // 是否跟随新消息自动滚动到底\r\n\tconst scrollPositions = ref({}) // 每个对话的滚动位置记录：{ [id]: { top } }\r\n\r\n\tfunction isNearBottom(el, threshold = 60) {\r\n\t\ttry {\r\n\t\t\tconst remain = el.scrollHeight - el.scrollTop - el.clientHeight\r\n\t\t\treturn remain <= threshold\r\n\t\t} catch (e) {\r\n\t\t\treturn true\r\n\t\t}\r\n\t}\r\n\r\n\tfunction scrollToBottom() {\r\n\t\ttry {\r\n\t\t\t// #ifdef MP\r\n\t\t\t// 中文注释：通过锚点滚到底，更稳\r\n\t\t\tscrollIntoView.value = ''\r\n\t\t\tnextTick(() => {\r\n\t\t\t\tscrollIntoView.value = bottomAnchorId\r\n\t\t\t})\r\n\t\t\t// #endif\r\n\t\t\t// #ifndef MP\r\n\t\t\tconst el = h5MessageListRef.value\r\n\t\t\tif (el) el.scrollTop = el.scrollHeight\r\n\t\t\t// #endif\r\n\t\t} catch (e) {}\r\n\t}\r\n\r\n\tfunction saveScrollPos(id) {\r\n\t\ttry {\r\n\t\t\tconst key = id || currentConversationId.value\r\n\t\t\tif (!key) return\r\n\t\t\t// #ifdef MP\r\n\t\t\tscrollPositions.value[key] = {\r\n\t\t\t\ttop: Number(mpLastScrollTop.value || 0)\r\n\t\t\t}\r\n\t\t\t// #endif\r\n\t\t\t// #ifndef MP\r\n\t\t\tconst el = h5MessageListRef.value\r\n\t\t\tscrollPositions.value[key] = {\r\n\t\t\t\ttop: el ? Number(el.scrollTop || 0) : 0\r\n\t\t\t}\r\n\t\t\t// #endif\r\n\t\t} catch (e) {}\r\n\t}\r\n\r\n\tfunction restoreScrollPos(id) {\r\n\t\ttry {\r\n\t\t\tconst key = id || currentConversationId.value\r\n\t\t\tconst saved = (key && scrollPositions.value[key]) ? Number(scrollPositions.value[key].top || 0) : null\r\n\t\t\tif (saved != null && saved > 0) {\r\n\t\t\t\t// #ifdef MP\r\n\t\t\t\tscrollIntoView.value = ''\r\n\t\t\t\tmpScrollTop.value = saved\r\n\t\t\t\t// #endif\r\n\t\t\t\t// #ifndef MP\r\n\t\t\t\tconst el = h5MessageListRef.value\r\n\t\t\t\tif (el) el.scrollTop = saved\r\n\t\t\t\t// #endif\r\n\t\t\t} else {\r\n\t\t\t\tif (autoFollow.value) scrollToBottom()\r\n\t\t\t}\r\n\t\t} catch (e) {}\r\n\t}\r\n\r\n\t// 小程序滚动事件：上滑暂停自动跟随；到底恢复自动跟随\r\n\tfunction onMpScroll(e) {\r\n\t\ttry {\r\n\t\t\tconst top = Number(e?.detail?.scrollTop || 0)\r\n\t\t\tif (top + 30 < mpLastScrollTop.value) autoFollow.value = false\r\n\t\t\tmpLastScrollTop.value = top\r\n\t\t\tif (currentConversationId.value) {\r\n\t\t\t\tscrollPositions.value[currentConversationId.value] = {\r\n\t\t\t\t\ttop\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (e) {}\r\n\t}\r\n\r\n\tfunction onMpScrollToLower() {\r\n\t\tautoFollow.value = true\r\n\t}\r\n\r\n\t// H5/PC 监听容器滚动，计算是否在底部\r\n\tlet h5ScrollHandler = null\r\n\r\n\tfunction bindH5ScrollListener() {\r\n\t\ttry {\r\n\t\t\t// #ifdef H5\r\n\t\t\tconst el = h5MessageListRef.value\r\n\t\t\tif (!el) return\r\n\t\t\tif (h5ScrollHandler) el.removeEventListener('scroll', h5ScrollHandler)\r\n\t\t\th5ScrollHandler = () => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst near = isNearBottom(el)\r\n\t\t\t\t\tautoFollow.value = near\r\n\t\t\t\t\tif (currentConversationId.value) {\r\n\t\t\t\t\t\tscrollPositions.value[currentConversationId.value] = {\r\n\t\t\t\t\t\t\ttop: Number(el.scrollTop || 0)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (e) {}\r\n\t\t\t}\r\n\t\t\tel.addEventListener('scroll', h5ScrollHandler)\r\n\t\t\t// #endif\r\n\t\t} catch (e) {}\r\n\t}\r\n\r\n\tfunction unbindH5ScrollListener() {\r\n\t\ttry {\r\n\t\t\t// #ifdef H5\r\n\t\t\tconst el = h5MessageListRef.value\r\n\t\t\tif (el && h5ScrollHandler) el.removeEventListener('scroll', h5ScrollHandler)\r\n\t\t\th5ScrollHandler = null\r\n\t\t\t// #endif\r\n\t\t} catch (e) {}\r\n\t}\r\n\r\n\t// 桌面/移动切换时，切到桌面强制关闭抽屉，避免残留挡点击\r\n\twatch(isDesktop, (d) => {\r\n\t\t// 中文注释：切到桌面端强制关闭移动抽屉，避免残留遮罩挡点击\r\n\t\tif (d) {\r\n\t\t\tmobileSidebarVisible.value = false\r\n\t\t\ttry {\r\n\t\t\t\tsidebarPopup.value?.close?.()\r\n\t\t\t} catch (e) {}\r\n\t\t}\r\n\t})\r\n\r\n\t// 切换会话：保存旧会话滚动，恢复新会话滚动\r\n\twatch(currentConversationId, (newId, oldId) => {\r\n\t\ttry {\r\n\t\t\tif (oldId) saveScrollPos(oldId)\r\n\t\t} catch (e) {}\r\n\t\tnextTick(() => restoreScrollPos(newId))\r\n\t})\r\n\r\n\t// 中文注释：抽屉开关统一通过 uni-popup 控制，保证跨端遮罩/定位稳定\r\n\tconst toggleMobileSidebar = () => {\r\n\t\tif (mobileSidebarVisible.value) {\r\n\t\t\ttry {\r\n\t\t\t\tsidebarPopup.value?.close?.()\r\n\t\t\t} catch (e) {}\r\n\t\t} else {\r\n\t\t\ttry {\r\n\t\t\t\tsidebarPopup.value?.open?.('left')\r\n\t\t\t} catch (e) {}\r\n\t\t}\r\n\t}\r\n\tconst closeMobileSidebar = () => {\r\n\t\ttry {\r\n\t\t\tsidebarPopup.value?.close?.()\r\n\t\t} catch (e) {}\r\n\t}\r\n\tconst onSidebarPopupChange = (e) => {\r\n\t\t// e = { show: Boolean }\r\n\t\tif (e && typeof e.show === 'boolean') {\r\n\t\t\tmobileSidebarVisible.value = !!e.show\r\n\t\t}\r\n\t}\r\n\tconst noop = () => {}\r\n\r\n\t// 中文注释：抽屉顶部安全区内边距样式（MP 使用状态栏高度，H5 使用 CSS 变量/环境变量）\r\n\tconst popupDrawerStyle = computed(() => {\r\n\t\ttry {\r\n\t\t\t// #ifdef MP\r\n\t\t\t// 中文注释：抽屉顶部预留总导航高度，避免被状态栏/胶囊遮挡\r\n\t\t\treturn `padding-top: ${Number(totalNavHeightPx?.value || 0)}px;`\r\n\t\t\t// #endif\r\n\t\t\t// #ifdef H5\r\n\t\t\t// 中文注释：H5 顶部同时考虑状态栏安全区与自定义导航高度（统一按 44px 兜底）\r\n\t\t\tconst navH = Number(navBarHeightPx?.value || 44)\r\n\t\t\treturn `padding-top: calc(${navH}px + constant(safe-area-inset-top)); padding-top: calc(${navH}px + env(safe-area-inset-top));`\r\n\t\t\t// #endif\r\n\t\t} catch (e) {\r\n\t\t\treturn ''\r\n\t\t}\r\n\t})\r\n\r\n\t// 初始化，if没有对话就自动创建新对话\r\n\tonMounted(() => {\r\n\t\tloadConversations()\r\n\t\t// 只有在完全没有对话数据时才创建新对话\r\n\t\t// 避免重复创建\r\n\t\tif (conversations.value.length === 0) {\r\n\t\t\tcreateNewChat()\r\n\t\t} else {\r\n\t\t\tconsole.log('初始化：使用已有对话，数量:', conversations.value.length)\r\n\t\t}\r\n\t})\r\n\r\n\twatch(isGenerating, (newVal) => {\r\n\t\t// console.log('isGenerating 状态变化:', newVal)\r\n\t})\r\n\r\n\twatch(currentMessages, () => {\r\n\t\t// 中文注释：有新消息且开启自动跟随时滚动到底\r\n\t\tnextTick(() => {\r\n\t\t\tif (autoFollow.value) scrollToBottom()\r\n\t\t})\r\n\t}, {\r\n\t\tdeep: true\r\n\t})\r\n\r\n\t// 中文注释：初次进入自动滚到底，并绑定 H5 滚动监听\r\n\tonMounted(() => {\r\n\t\tnextTick(() => {\r\n\t\t\tautoFollow.value = true\r\n\t\t\tscrollToBottom()\r\n\t\t\tbindH5ScrollListener()\r\n\t\t})\r\n\t})\r\n\r\n\tonUnmounted(() => {\r\n\t\tunbindH5ScrollListener()\r\n\t})\r\n\r\n\r\n\t// ====== 对话 CRUD ======\r\n\tfunction loadConversations() {\r\n\t\ttry {\r\n\t\t\tconst saved = uni.getStorageSync('chat_conversations')\r\n\t\t\tif (saved) {\r\n\t\t\t\tconst parsed = JSON.parse(saved)\r\n\t\t\t\t// 去重：使用 Map 确保每个 ID 只出现一次\r\n\t\t\t\tconst uniqueMap = new Map()\r\n\t\t\t\tparsed.forEach(conv => {\r\n\t\t\t\t\tif (conv.id && !uniqueMap.has(conv.id)) {\r\n\t\t\t\t\t\tuniqueMap.set(conv.id, conv)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tconversations.value = Array.from(uniqueMap.values())\r\n\t\t\t\t// console.log('加载对话，去重前:', parsed.length, '去重后:', conversations.value.length)\r\n\t\t\t\t\r\n\t\t\t\t// 确保当前对话ID有效\r\n\t\t\t\tif (conversations.value.length > 0) {\r\n\t\t\t\t\tcurrentConversationId.value = conversations.value[0]?.id || ''\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error(e)\r\n\t\t}\r\n\t}\r\n\r\n\t// 修改 saveConversations 函数确保触发响应式更新\r\n\tfunction saveConversations() {\r\n\t\ttry {\r\n\t\t\t// 去重：使用 Map 确保每个 ID 只出现一次\r\n\t\t\tconst uniqueMap = new Map()\r\n\t\t\tconversations.value.forEach(conv => {\r\n\t\t\t\tif (conv.id && !uniqueMap.has(conv.id)) {\r\n\t\t\t\t\tuniqueMap.set(conv.id, conv)\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\tconst uniqueConversations = Array.from(uniqueMap.values())\r\n\t\t\t\r\n\t\t\t// 如果去重后数量变化，说明有重复，需要更新\r\n\t\t\tif (uniqueConversations.length !== conversations.value.length) {\r\n\t\t\t\t// console.warn('检测到重复对话，去重前:', conversations.value.length, '去重后:', uniqueConversations.length)\r\n\t\t\t\tconversations.value = uniqueConversations\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tuni.setStorageSync('chat_conversations', JSON.stringify(conversations.value))\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error('保存对话失败:', e)\r\n\t\t}\r\n\t}\r\n\r\n\t// create新对话\r\n\tfunction createNewChat() {\r\n\t\t// 检查是否已经有空对话，避免重复创建\r\n\t\tconst existingEmptyConv = conversations.value.find(conv =>\r\n\t\t\t!conv.title || conv.title === '新对话' || conv.messages.length === 0\r\n\t\t)\r\n\r\n\t\tif (existingEmptyConv) {\r\n\t\t\tconsole.log('已有空对话，切换到:', existingEmptyConv.id)\r\n\t\t\tcurrentConversationId.value = existingEmptyConv.id\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\tconst chat = {\r\n\t\t\tid: 'conv_' + Date.now(),\r\n\t\t\ttitle: '新对话',\r\n\t\t\tcreatedAt: Date.now(),\r\n\t\t\tmessages: [],\r\n\t\t}\r\n\t\tconversations.value.unshift(chat)\r\n\t\tcurrentConversationId.value = chat.id\r\n\t\tsaveConversations()\r\n\t\tconsole.log('创建新对话:', chat.id)\r\n\t}\r\n\r\n\r\n\tfunction selectConversation(id) {\r\n\t\tcurrentConversationId.value = id\r\n\t}\r\n\r\n\tfunction handleMobileCreateChat() {\r\n\t\tcreateNewChat()\r\n\t\tcloseMobileSidebar()\r\n\t}\r\n\r\n\tfunction handleMobileSelectConversation(id) {\r\n\t\tselectConversation(id)\r\n\t\tcloseMobileSidebar()\r\n\t}\r\n\r\n\tfunction editConversationTitle(id, newTitle) {\r\n\t\tconst conv = conversations.value.find((c) => c.id === id)\r\n\t\tif (conv) {\r\n\t\t\tconv.title = newTitle\r\n\t\t\tsaveConversations()\r\n\t\t}\r\n\t}\r\n\r\n\tfunction deleteConversation(id) {\r\n\t\tconst i = conversations.value.findIndex((c) => c.id === id)\r\n\t\tif (i !== -1) {\r\n\t\t\tconversations.value.splice(i, 1)\r\n\t\t\tif (currentConversationId.value === id)\r\n\t\t\t\tcurrentConversationId.value = conversations.value[0]?.id || ''\r\n\t\t\tsaveConversations()\r\n\t\t}\r\n\t}\r\n\r\n\t// 发送消息\r\n\tasync function handleSendMessage(messageData) {\r\n\t\tconst conv = conversations.value.find((c) => c.id === currentConversationId.value)\r\n\t\tif (!conv) return\r\n\r\n\r\n\t\t// 修复：正确提取 content 和 attachments\r\n\t\tconst content = typeof messageData === 'string' ?\r\n\t\t\tmessageData :\r\n\t\t\t(messageData.content || '')\r\n\r\n\t\tconst attachments = messageData.attachments || []\r\n\r\n\t\t// 创建用户消息 - 确保 content 是字符串\r\n\t\tconst userMsg = {\r\n\t\t\tid: 'msg_' + Date.now(),\r\n\t\t\trole: 'user',\r\n\t\t\tcontent: content, // 直接使用字符串\r\n\t\t\tattachments,\r\n\t\t\ttimestamp: Date.now(),\r\n\t\t}\r\n\r\n\r\n\t\t// 添加到消息列表\r\n\t\tconv.messages.push(userMsg)\r\n\t\tisGenerating.value = true\r\n\r\n\t\t// 如果是新对话或默认标题，根据输入自动生成标题\r\n\t\tif (!conv.title || conv.title === '新对话') {\r\n\t\t\tconv.title = generateTitleFromText(userMsg.content)\r\n\t\t}\r\n\r\n\t\t// 立即保存，确保用户消息显示\r\n\t\tsaveConversations()\r\n\r\n\t\t// 等待DOM更新\r\n\t\tawait nextTick()\r\n\r\n\t\t// 调用AI生成回复\r\n\t\tawait generateAIResponse(conv, userMsg)\r\n\t}\r\n\r\n\t// ai问答接口\r\n\tasync function generateAIResponse(conv, userMsg) {\r\n\r\n\t\t// 1) 先推一个空的 AI 消息用于前端累加展示\r\n\t\tconst aiMsg = {\r\n\t\t\tid: 'msg_' + Date.now(),\r\n\t\t\trole: 'assistant',\r\n\t\t\tcontent: '',\r\n\t\t\ttimestamp: Date.now()\r\n\t\t}\r\n\t\tconv.messages.push(aiMsg)\r\n\r\n\r\n\t\t// 立即保存到存储，确保消息列表更新\r\n\t\tsaveConversations()\r\n\r\n\t\t// 等待DOM更新\r\n\t\tawait nextTick()\r\n\t\t// console.log('DOM更新后检查消息列表')\r\n\r\n\t\t// 2) 规范化消息函数保持不变...\r\n\t\tfunction normalizeMessagesForBackend(messages) {\r\n\t\t\treturn messages\r\n\t\t\t\t.map(m => {\r\n\t\t\t\t\tif (typeof m.content === 'string') {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\trole: m.role,\r\n\t\t\t\t\t\t\tcontent: m.content.trim()\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst {\r\n\t\t\t\t\t\tcontent = '', attachments = []\r\n\t\t\t\t\t} = m.content || {}\r\n\t\t\t\t\tconst attachText = attachments.length ?\r\n\t\t\t\t\t\tattachments.map(a => `\\n[附件：${a.name || a.url}]`).join('') :\r\n\t\t\t\t\t\t''\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\trole: m.role,\r\n\t\t\t\t\t\tcontent: (content + attachText).trim()\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.filter(m => m.content && m.content.length > 0)\r\n\t\t\t\t.slice(-30)\r\n\t\t}\r\n\r\n\t\tconst body = {\r\n\t\t\tmodel: 'qwen3-max',\r\n\t\t\tmodelName: 'qwen3-max',\r\n\t\t\tmessages: normalizeMessagesForBackend(conv.messages),\r\n\t\t\tstream: true\r\n\t\t}\r\n\r\n\t\t// console.log('发送给后端的消息:', body)\r\n\r\n\t\t// 4) 调用后端流式接口\r\n\t\ttry {\r\n\t\t\t// 中文注释：在流式回调中做 UI 与存储节流，减少频繁重渲染与磁盘写入\r\n\t\t\tlet uiTimer = null\r\n\t\t\tlet lastSave = 0\r\n\r\n\t\t\tfunction flushUI() {\r\n\t\t\t\tconst messageIndex = conv.messages.findIndex(m => m.id === aiMsg.id)\r\n\t\t\t\tif (messageIndex !== -1) {\r\n\t\t\t\t\tconst newMessages = [...conv.messages]\r\n\t\t\t\t\tnewMessages[messageIndex] = {\r\n\t\t\t\t\t\t...aiMsg\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconv.messages = newMessages\r\n\t\t\t\t}\r\n\t\t\t\tuiTimer = null\r\n\t\t\t\t// 存储节流：500ms 至少落盘一次\r\n\t\t\t\tconst now = Date.now()\r\n\t\t\t\tif (now - lastSave > 500) {\r\n\t\t\t\t\tlastSave = now\r\n\t\t\t\t\tsaveConversations()\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tcancelGenerate.value = request.chatStream(\r\n\t\t\t\tbody,\r\n\t\t\t\t(delta) => { // onDelta\r\n\t\t\t\t\taiMsg.content += delta\r\n\t\t\t\t\tif (!uiTimer) {\r\n\t\t\t\t\t\tuiTimer = setTimeout(flushUI, 80) // 约 12fps 刷新\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\t() => {\r\n\t\t\t\t\t// 结束前强制刷新与保存，确保最终内容一致\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tif (uiTimer) {\r\n\t\t\t\t\t\t\tclearTimeout(uiTimer);\r\n\t\t\t\t\t\t\tuiTimer = null\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tflushUI()\r\n\t\t\t\t\t} catch (e) {}\r\n\t\t\t\t\tisGenerating.value = false\r\n\t\t\t\t\tcancelGenerate.value = null\r\n\t\t\t\t\tsaveConversations()\r\n\t\t\t\t},\r\n\t\t\t\t(err) => {\r\n\t\t\t\t\tconsole.error('AI回复错误:', err)\r\n\t\t\t\t\taiMsg.content += `\\n[错误] ${err?.message || err}`\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tif (uiTimer) {\r\n\t\t\t\t\t\t\tclearTimeout(uiTimer);\r\n\t\t\t\t\t\t\tuiTimer = null\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tflushUI()\r\n\t\t\t\t\t} catch (e) {}\r\n\t\t\t\t\tisGenerating.value = false\r\n\t\t\t\t\tcancelGenerate.value = null\r\n\t\t\t\t\tsaveConversations()\r\n\t\t\t\t}\r\n\t\t\t)\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('生成AI回复时发生异常:', error)\r\n\t\t\t// 异常情况下也要重置状态\r\n\t\t\tisGenerating.value = false\r\n\t\t\tcancelGenerate.value = null\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// 停止对话生成\r\n\tfunction stopGenerating() {\r\n\t\tisGenerating.value = false\r\n\t\tif (cancelGenerate.value) {\r\n\t\t\ttry {\r\n\t\t\t\tcancelGenerate.value()\r\n\t\t\t} catch (e) {}\r\n\t\t\tcancelGenerate.value = null\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tfunction clearCurrentConversation() {\r\n\t\tconst conv = conversations.value.find((c) => c.id === currentConversationId.value)\r\n\t\tif (conv) {\r\n\t\t\tconv.messages = []\r\n\t\t\tsaveConversations()\r\n\t\t}\r\n\t}\r\n\r\n\tfunction handleMessageFeedback(messageId, feedback) {\r\n\t\tconst conv = conversations.value.find((c) => c.id === currentConversationId.value)\r\n\t\tif (!conv) return\r\n\t\tconst i = conv.messages.findIndex((m) => m.id === messageId)\r\n\t\tif (i !== -1) {\r\n\t\t\tconv.messages[i].feedback = feedback\r\n\t\t\tsaveConversations()\r\n\t\t}\r\n\t}\r\n\r\n\tfunction handleMessageEdit(messageId, newContent) {\r\n\t\tconst conv = conversations.value.find((c) => c.id === currentConversationId.value)\r\n\t\tif (!conv) return\r\n\t\tconst i = conv.messages.findIndex((m) => m.id === messageId)\r\n\t\tif (i !== -1) {\r\n\t\t\tconv.messages[i].content = newContent\r\n\t\t\tsaveConversations()\r\n\t\t}\r\n\t}\r\n\r\n\t// 点击“编辑”→ 回填到输入框（文本 + 附件）\r\n\tfunction handleRequestEdit(msg) {\r\n\t\ttry {\r\n\t\t\tchatInputRef.value?.setDraft(msg?.content || '', msg?.attachments || [])\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error('回填草稿失败:', e)\r\n\t\t}\r\n\t}\r\n\r\n\t// 根据用户输入生成会话标题\r\n\tfunction generateTitleFromText(text = '') {\r\n\t\t// 取第一行/第一句，移除多空格与换行\r\n\t\tlet s = (text || '').trim().replace(/\\s/g, ' ')\r\n\t\t// 如果包含中文标点或句号，截取第一句\r\n\t\tconst firstEnd = s.search(/[。！？!?\\.]/)\r\n\t\tif (firstEnd > 0) s = s.slice(0, firstEnd)\r\n\t\t// 去除首尾标点\r\n\t\ts = s.replace(/^[~#\\-\\s、，,。!?！?【】\\[\\]\\(\\)（）]|[~#\\-\\s、，,。!?！?【】\\[\\]\\(\\)（）]$/g, '')\r\n\t\t// 限制长度（例如 20～24 个字符）\r\n\t\tconst maxLen = 10\r\n\t\tif (s.length > maxLen) s = s.slice(0, maxLen) + '…'\r\n\t\t// 兜底：如为空\r\n\t\treturn s || '新对话'\r\n\t}\r\n\r\n\tfunction handleAddAttachment(file) {\r\n\t\t// 附件逻辑可直接接上\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n\t.chat-page {\r\n\t\tdisplay: flex;\r\n\t\tflex: 1;\r\n\t\tmin-height: 0;\r\n\t\tbackground: #ffffff;\r\n\t\tborder-radius: 15rpx;\r\n\t\theight: 100vh;\r\n\t\toverflow: hidden;\r\n\t\t\r\n\t}\r\n\r\n\t/* 桌面：右侧聊天主区域 */\r\n\t.chat-main {\r\n\t\tflex: 1;\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tmin-width: 0;\r\n\t\tmin-height: 0;\r\n\t\theight: 100%;\r\n\t}\r\n\r\n\t/* 桌面：左右并排；移动：上下（Header + 内容） */\r\n\t.chat-page.layout-desktop {\r\n\t\tflex-direction: row;\r\n\t}\r\n\r\n\t.chat-page.layout-mobile {\r\n\t\tflex-direction: column;\r\n\t\t/* height 由内联样式动态设置，适配所有机型 */\r\n\t\toverflow: hidden;\r\n\t}\r\n\r\n\t/* 移动端容器（扣掉 header 高度） */\r\n\t.mobile-chat-container {\r\n\t\tflex: 1;\r\n\t\t/* 关键：跟随父容器纵向伸展 */\r\n\t\tposition: relative;\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tmin-height: 0;\r\n\t}\r\n\r\n\t/* 抽屉容器（uni-popup 内容区），统一宽度与背景 */\r\n\t.popup-drawer {\r\n\t\tmax-width: 640rpx;\r\n\t\theight: 100dvh;\r\n\t\theight: 100vh;\r\n\t\t/* 回退 */\r\n\t\tbackground: #ffffff;\r\n\t}\r\n\r\n\t/* 顶部安全区：H5 使用 env/变量；MP 通过内联样式设置 */\r\n\t.popup-drawer {\r\n\t\tpadding-top: var(--safe-top, 0px);\r\n\t\tpadding-top: constant(safe-area-inset-top);\r\n\t\tpadding-top: env(safe-area-inset-top);\r\n\t}\r\n\r\n\t/* 移动端聊天区域 */\r\n\t.mobile-chat-main {\r\n\t\tflex: 1;\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tmin-height: 0;\r\n\t\tmin-width: 0;\r\n\t\toverflow: hidden;\r\n\t}\r\n\r\n\r\n\t.message-list-container {\r\n\t\tflex: 1;\r\n\t\tmin-height: 0;\r\n\t\t/* 中文注释：中间消息列表承担滚动 */\r\n\t\toverflow-y: auto;\r\n\t\t/* 中文注释：H5 防止滚动穿透/链式滚动，提升滚动体验 */\r\n\t\toverscroll-behavior: contain;\r\n\t\t-webkit-overflow-scrolling: touch;\r\n\t}\r\n\r\n\t/* 确保滚动正常工作 */\r\n\t.message-list-container::-webkit-scrollbar {\r\n\t\twidth: 6rpx;\r\n\t}\r\n\r\n\t.message-list-container::-webkit-scrollbar-thumb {\r\n\t\tbackground: #cbd5e1;\r\n\t\tborder-radius: 3rpx;\r\n\t}\r\n\r\n\t.message-list-container::-webkit-scrollbar-thumb:hover {\r\n\t\tbackground: #94a3b8;\r\n\t}\r\n</style>","import MiniProgramPage from 'C:/Users/97247/Desktop/uni-ecoful/pages/chat/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["navTitleStore","onShow","usePlatformInfo","useSafeArea","ref","computed","nextTick","e","watch","onMounted","uni","onUnmounted","request"],"mappings":"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"}