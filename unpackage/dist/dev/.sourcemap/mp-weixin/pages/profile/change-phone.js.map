{"version":3,"file":"change-phone.js","sources":["pages/profile/change-phone.vue","../../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS9jaGFuZ2UtcGhvbmUudnVl"],"sourcesContent":["<!-- 修改/绑定手机号页面（UTF-8，中文注释） -->\n<template>\n  <app-layout current=\"pages/profile/change-phone\">\n    <view class=\"profile-page\">\n      <!-- 顶部说明 -->\n      <view class=\"profile__card\">\n        <view class=\"profile__card-header\">\n          <uni-icons type=\"phone\" size=\"20\" color=\"#276019\" />\n          <text class=\"profile__card-title\">更换手机号</text>\n        </view>\n        <view class=\"profile__card-content\">\n          <view class=\"profile__card-row\">\n            <view class=\"profile__card-left\">\n              <text class=\"profile__card-label\">当前手机号</text>\n            </view>\n            <view class=\"profile__card-right\">\n              <text class=\"profile__card-value\">{{ maskedCurrentPhone }}</text>\n            </view>\n          </view>\n        </view>\n      </view>\n\n      <!-- 表单区 -->\n      <view class=\"profile__card\">\n        <view class=\"profile__card-header\">\n          <uni-icons type=\"compose\" size=\"20\" color=\"#276019\" />\n          <text class=\"profile__card-title\">验证与绑定</text>\n        </view>\n        <view class=\"profile__card-content\">\n          <view class=\"form-row\">\n            <text class=\"form-label\">新手机号</text>\n            <uni-easyinput v-model=\"form.phone\" type=\"number\" placeholder=\"请输入新手机号\" :clearable=\"true\" />\n          </view>\n\n          <!-- 小程序：手机号快捷获取 -->\n          <!-- #ifdef MP-WEIXIN -->\n          <view class=\"form-row\">\n            <text class=\"form-hint\">也可使用微信授权快速获取手机号</text>\n            <button class=\"btn-secondary\" open-type=\"getPhoneNumber\" @getphonenumber=\"onGetPhoneNumber\">微信快捷获取</button>\n          </view>\n          <!-- #endif -->\n\n          <view class=\"form-row\">\n            <text class=\"form-label\">验证码</text>\n            <view class=\"code-row\">\n              <uni-easyinput v-model=\"form.code\" type=\"number\" placeholder=\"请输入验证码\" />\n              <button class=\"btn-code\" :disabled=\"countdown>0 || sending\" @tap=\"sendCode\">\n                {{ countdown>0 ? `${countdown}s` : (sending ? '发送中' : '获取验证码') }}\n              </button>\n            </view>\n          </view>\n        </view>\n      </view>\n\n      <!-- 提交按钮 -->\n      <view class=\"actions\">\n        <button class=\"profile__submit-btn\" :disabled=\"submitting\" @tap=\"handleSubmit\">{{ submitting ? '提交中...' : '确认绑定' }}</button>\n      </view>\n\n      <view class=\"safe-area-bottom\" />\n    </view>\n  </app-layout>\n  \n</template>\n\n<script setup>\n// UTF-8，中文注释\nimport { ref, computed, onUnmounted } from 'vue'\nimport { onShow } from '@dcloudio/uni-app'\nimport AppLayout from '@/components/layout/AppLayout.vue'\nimport { navTitleStore } from '@/stores/navTitle.js'\nimport { request } from '@/utils/request.js'\nimport { useUserStore } from '@/api/user.js'\n\nconst navTitle = navTitleStore()\nonShow(() => navTitle.setTitle('更换手机号'))\n\nconst userStore = useUserStore?.() || { profile: null }\nconst currentPhone = ref(userStore?.profile?.phone || '')\nconst maskedCurrentPhone = computed(() => {\n  const p = currentPhone.value\n  if (!p) return '未绑定'\n  return String(p).replace(/(\\d{3})\\d{4}(\\d{4})/, '$1****$2')\n})\n\nconst form = ref({ phone: '', code: '' })\nconst countdown = ref(0)\nconst sending = ref(false)\nconst submitting = ref(false)\nlet timer = null\n\nfunction validatePhone(phone) {\n  return /^1\\d{10}$/.test(String(phone || '').trim())\n}\n\nfunction startCountdown(sec = 60) {\n  countdown.value = sec\n  timer && clearInterval(timer)\n  timer = setInterval(() => {\n    if (countdown.value <= 1) {\n      clearInterval(timer)\n      countdown.value = 0\n    } else {\n      countdown.value -= 1\n    }\n  }, 1000)\n}\n\nasync function sendCode() {\n  if (!validatePhone(form.value.phone)) {\n    uni.showToast({ title: '请输入正确的手机号', icon: 'none' })\n    return\n  }\n  if (countdown.value > 0 || sending.value) return\n  sending.value = true\n  try {\n    await request({ url: '/user/phone/sendCode', method: 'POST', data: { phone: form.value.phone } })\n    uni.showToast({ title: '验证码已发送', icon: 'success' })\n    startCountdown(60)\n  } catch (e) {\n    uni.showToast({ title: '发送失败，请稍后重试', icon: 'none' })\n  } finally {\n    sending.value = false\n  }\n}\n\n// 小程序：微信快捷获取手机号\nfunction onGetPhoneNumber(e) {\n  // #ifdef MP-WEIXIN\n  const code = e?.detail?.code\n  if (!code) {\n    uni.showToast({ title: '获取失败，请手动输入', icon: 'none' })\n    return\n  }\n  uni.showLoading({ title: '获取中' })\n  request({ url: '/user/phone/weapp', method: 'POST', data: { code } })\n    .then((res) => {\n      const phone = res?.phone\n      if (validatePhone(phone)) {\n        form.value.phone = phone\n        uni.showToast({ title: '已获取手机号', icon: 'success' })\n      } else {\n        uni.showToast({ title: '获取失败，请手动输入', icon: 'none' })\n      }\n    })\n    .catch(() => {\n      uni.showToast({ title: '获取失败，请手动输入', icon: 'none' })\n    })\n    .finally(() => {\n      uni.hideLoading()\n    })\n  // #endif\n}\n\nasync function handleSubmit() {\n  if (!validatePhone(form.value.phone)) {\n    uni.showToast({ title: '请输入正确的手机号', icon: 'none' })\n    return\n  }\n  if (!/^\\d{4,8}$/.test(String(form.value.code))) {\n    uni.showToast({ title: '请输入正确的验证码', icon: 'none' })\n    return\n  }\n  submitting.value = true\n  try {\n    await request({ url: '/user/phone/bind', method: 'POST', data: { phone: form.value.phone, code: form.value.code } })\n    uni.showToast({ title: '绑定成功', icon: 'success' })\n    setTimeout(() => {\n      uni.navigateBack({ delta: 1 })\n    }, 600)\n  } catch (e) {\n    uni.showToast({ title: '绑定失败，请稍后重试', icon: 'none' })\n  } finally {\n    submitting.value = false\n  }\n}\n\nonUnmounted(() => { timer && clearInterval(timer) })\n</script>\n\n<style lang=\"scss\" scoped>\n.profile-page { display: flex; flex-direction: column; gap: 24rpx; background-color: #f5f7fa; }\n\n/* 复用个人中心卡片视觉 */\n.profile__card { background-color: #ffffff; border-radius: 20rpx; overflow: hidden; }\n.profile__card-header { display: flex; align-items: center; gap: 16rpx; padding: 32rpx 32rpx 24rpx; border-bottom: 1rpx solid #f1f5f9; }\n.profile__card-title { font-size: 30rpx; font-weight: 600; color: #0f172a; }\n.profile__card-content { padding: 0; }\n.profile__card-row { display: flex; align-items: center; justify-content: space-between; padding: 28rpx 32rpx; border-bottom: 1rpx solid #f8fafc; }\n.profile__card-row:last-child { border-bottom: none; }\n.profile__card-left { display: flex; align-items: center; gap: 20rpx; flex: 1; }\n.profile__card-label { font-size: 28rpx; color: #334155; font-weight: 500; }\n.profile__card-right { display: flex; align-items: center; gap: 16rpx; }\n.profile__card-value { font-size: 28rpx; color: #64748b; }\n\n.form-row { display: flex; flex-direction: column; gap: 16rpx; padding: 24rpx 32rpx; }\n.form-label { font-size: 28rpx; color: #334155; }\n.form-hint { font-size: 26rpx; color: #94a3b8; }\n.code-row { display: flex; align-items: center; gap: 16rpx; }\n\n.btn-code { padding: 16rpx 24rpx; background: #276019; color: #fff; border: none; border-radius: 12rpx; font-size: 26rpx; }\n.btn-code:disabled { opacity: .6; }\n.btn-secondary { padding: 16rpx 24rpx; background: #f1f5f9; color: #276019; border: none; border-radius: 12rpx; font-size: 26rpx; }\n\n.actions { padding: 0 24rpx; }\n.profile__submit-btn { width: 100%; background: #276019; color: #fff; border: none; border-radius: 16rpx; padding: 24rpx; font-size: 32rpx; font-weight: 600; }\n.profile__submit-btn:active { opacity: .9; transform: scale(.98); }\n\n.safe-area-bottom { height: env(safe-area-inset-bottom); min-height: 0rpx; }\n\n@media (max-width: 1023px) {\n  .profile__card-header { padding: 28rpx 28rpx 22rpx; }\n  .profile__card-row { padding: 24rpx 28rpx; }\n}\n</style>\n\n","import MiniProgramPage from 'C:/Users/97247/Desktop/uni-ecoful/pages/profile/change-phone.vue'\nwx.createPage(MiniProgramPage)"],"names":["navTitleStore","onShow","useUserStore","ref","computed","uni","request","_a","onUnmounted"],"mappings":"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"}