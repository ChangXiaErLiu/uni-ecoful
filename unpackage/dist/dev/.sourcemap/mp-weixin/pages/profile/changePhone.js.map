{"version":3,"file":"changePhone.js","sources":["pages/profile/changePhone.vue","../../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS9jaGFuZ2VQaG9uZS52dWU"],"sourcesContent":["<!-- 修改/绑定手机号页面（UTF-8，中文注释） -->\r\n<template>\r\n  <AppLayout current=\"pages/profile/changePhone\">\r\n    <view class=\"profile-page\">\r\n      <!-- 顶部说明 -->\r\n      <view class=\"profile__card\">\r\n        <view class=\"profile__card-header\">\r\n          <uni-icons type=\"phone\" size=\"20\" color=\"#276019\" />\r\n          <text class=\"profile__card-title\">更换手机号</text>\r\n        </view>\r\n        <view class=\"profile__card-content\">\r\n          <view class=\"profile__card-row\">\r\n            <view class=\"profile__card-left\">\r\n              <text class=\"profile__card-label\">当前手机号</text>\r\n            </view>\r\n            <view class=\"profile__card-right\">\r\n              <text class=\"profile__card-value\">{{ maskedCurrentPhone }}</text>\r\n            </view>\r\n          </view>\r\n        </view>\r\n      </view>\r\n\r\n      <!-- 表单区 -->\r\n      <view class=\"profile__card\">\r\n        <view class=\"profile__card-header\">\r\n          <uni-icons type=\"compose\" size=\"20\" color=\"#276019\" />\r\n          <text class=\"profile__card-title\">验证与绑定</text>\r\n        </view>\r\n        <view class=\"profile__card-content\">\r\n          <view class=\"form-row\">\r\n            <text class=\"form-label\">新手机号</text>\r\n            <uni-easyinput v-model=\"form.phone\" type=\"number\" placeholder=\"请输入新手机号\" :clearable=\"true\" />\r\n          </view>\r\n\r\n          <!-- 小程序：手机号快捷获取 -->\r\n          <!-- #ifdef MP-WEIXIN -->\r\n          <view class=\"form-row\">\r\n            <text class=\"form-hint\">也可使用微信授权快速获取手机号</text>\r\n            <button class=\"btn-secondary\" open-type=\"getPhoneNumber\" @getphonenumber=\"onGetPhoneNumber\">微信快捷获取</button>\r\n          </view>\r\n          <!-- #endif -->\r\n\r\n          <view class=\"form-row\">\r\n            <text class=\"form-label\">验证码</text>\r\n            <view class=\"code-row\">\r\n              <uni-easyinput v-model=\"form.code\" type=\"number\" placeholder=\"请输入验证码\" />\r\n              <button class=\"btn-code\" :disabled=\"countdown>0 || sending\" @tap=\"sendCode\">\r\n                {{ countdown>0 ? `${countdown}s` : (sending ? '发送中' : '获取验证码') }}\r\n              </button>\r\n            </view>\r\n          </view>\r\n        </view>\r\n      </view>\r\n\r\n      <!-- 提交按钮 -->\r\n      <view class=\"actions\">\r\n        <button class=\"profile__submit-btn\" :disabled=\"submitting\" @tap=\"handleSubmit\">{{ submitting ? '提交中...' : '确认绑定' }}</button>\r\n      </view>\r\n\r\n      <view class=\"safe-area-bottom\" />\r\n    </view>\r\n  </AppLayout>\r\n  \r\n</template>\r\n\r\n<script setup>\r\n// UTF-8，中文注释\r\nimport { ref, computed, onUnmounted } from 'vue'\r\nimport { onShow } from '@dcloudio/uni-app'\r\nimport AppLayout from '@/components/layout/AppLayout.vue'\r\nimport { navTitleStore } from '@/stores/navTitle.js'\r\nimport { request } from '@/utils/request.js'\r\nimport { useUserStore } from '@/api/user.js'\r\n\r\nconst navTitle = navTitleStore()\r\nonShow(() => navTitle.setTitle('更换手机号'))\r\n\r\nconst userStore = useUserStore?.() || { profile: null }\r\nconst currentPhone = ref(userStore?.profile?.phone || '')\r\nconst maskedCurrentPhone = computed(() => {\r\n  const p = currentPhone.value\r\n  if (!p) return '未绑定'\r\n  return String(p).replace(/(\\d{3})\\d{4}(\\d{4})/, '$1****$2')\r\n})\r\n\r\nconst form = ref({ phone: '', code: '' })\r\nconst countdown = ref(0)\r\nconst sending = ref(false)\r\nconst submitting = ref(false)\r\nlet timer = null\r\n\r\nfunction validatePhone(phone) {\r\n  return /^1\\d{10}$/.test(String(phone || '').trim())\r\n}\r\n\r\nfunction startCountdown(sec = 60) {\r\n  countdown.value = sec\r\n  timer && clearInterval(timer)\r\n  timer = setInterval(() => {\r\n    if (countdown.value <= 1) {\r\n      clearInterval(timer)\r\n      countdown.value = 0\r\n    } else {\r\n      countdown.value -= 1\r\n    }\r\n  }, 1000)\r\n}\r\n\r\nasync function sendCode() {\r\n  if (!validatePhone(form.value.phone)) {\r\n    uni.showToast({ title: '请输入正确的手机号', icon: 'none' })\r\n    return\r\n  }\r\n  if (countdown.value > 0 || sending.value) return\r\n  sending.value = true\r\n  try {\r\n    await request({ url: '/user/phone/sendCode', method: 'POST', data: { phone: form.value.phone } })\r\n    uni.showToast({ title: '验证码已发送', icon: 'success' })\r\n    startCountdown(60)\r\n  } catch (e) {\r\n    uni.showToast({ title: '发送失败，请稍后重试', icon: 'none' })\r\n  } finally {\r\n    sending.value = false\r\n  }\r\n}\r\n\r\n// 小程序：微信快捷获取手机号\r\nfunction onGetPhoneNumber(e) {\r\n  // #ifdef MP-WEIXIN\r\n  const code = e?.detail?.code\r\n  if (!code) {\r\n    uni.showToast({ title: '获取失败，请手动输入', icon: 'none' })\r\n    return\r\n  }\r\n  uni.showLoading({ title: '获取中' })\r\n  request({ url: '/user/phone/weapp', method: 'POST', data: { code } })\r\n    .then((res) => {\r\n      const phone = res?.phone\r\n      if (validatePhone(phone)) {\r\n        form.value.phone = phone\r\n        uni.showToast({ title: '已获取手机号', icon: 'success' })\r\n      } else {\r\n        uni.showToast({ title: '获取失败，请手动输入', icon: 'none' })\r\n      }\r\n    })\r\n    .catch(() => {\r\n      uni.showToast({ title: '获取失败，请手动输入', icon: 'none' })\r\n    })\r\n    .finally(() => {\r\n      uni.hideLoading()\r\n    })\r\n  // #endif\r\n}\r\n\r\nasync function handleSubmit() {\r\n  if (!validatePhone(form.value.phone)) {\r\n    uni.showToast({ title: '请输入正确的手机号', icon: 'none' })\r\n    return\r\n  }\r\n  if (!/^\\d{4,8}$/.test(String(form.value.code))) {\r\n    uni.showToast({ title: '请输入正确的验证码', icon: 'none' })\r\n    return\r\n  }\r\n  submitting.value = true\r\n  try {\r\n    await request({ url: '/user/phone/bind', method: 'POST', data: { phone: form.value.phone, code: form.value.code } })\r\n    uni.showToast({ title: '绑定成功', icon: 'success' })\r\n    setTimeout(() => {\r\n      uni.navigateBack({ delta: 1 })\r\n    }, 600)\r\n  } catch (e) {\r\n    uni.showToast({ title: '绑定失败，请稍后重试', icon: 'none' })\r\n  } finally {\r\n    submitting.value = false\r\n  }\r\n}\r\n\r\nonUnmounted(() => { timer && clearInterval(timer) })\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.profile-page { display: flex; flex-direction: column; gap: 24rpx; background-color: #f5f7fa; }\r\n\r\n/* 复用个人中心卡片视觉 */\r\n.profile__card { background-color: #ffffff; border-radius: 20rpx; overflow: hidden; }\r\n.profile__card-header { display: flex; align-items: center; gap: 16rpx; padding: 32rpx 32rpx 24rpx; border-bottom: 1rpx solid #f1f5f9; }\r\n.profile__card-title { font-size: 30rpx; font-weight: 600; color: #0f172a; }\r\n.profile__card-content { padding: 0; }\r\n.profile__card-row { display: flex; align-items: center; justify-content: space-between; padding: 28rpx 32rpx; border-bottom: 1rpx solid #f8fafc; }\r\n.profile__card-row:last-child { border-bottom: none; }\r\n.profile__card-left { display: flex; align-items: center; gap: 20rpx; flex: 1; }\r\n.profile__card-label { font-size: 28rpx; color: #334155; font-weight: 500; }\r\n.profile__card-right { display: flex; align-items: center; gap: 16rpx; }\r\n.profile__card-value { font-size: 28rpx; color: #64748b; }\r\n\r\n.form-row { display: flex; flex-direction: column; gap: 16rpx; padding: 24rpx 32rpx; }\r\n.form-label { font-size: 28rpx; color: #334155; }\r\n.form-hint { font-size: 26rpx; color: #94a3b8; }\r\n.code-row { display: flex; align-items: center; gap: 16rpx; }\r\n\r\n.btn-code { padding: 16rpx 24rpx; background: #276019; color: #fff; border: none; border-radius: 12rpx; font-size: 26rpx; }\r\n.btn-code:disabled { opacity: .6; }\r\n.btn-secondary { padding: 16rpx 24rpx; background: #f1f5f9; color: #276019; border: none; border-radius: 12rpx; font-size: 26rpx; }\r\n\r\n.actions { padding: 0 24rpx; }\r\n.profile__submit-btn { width: 100%; background: #276019; color: #fff; border: none; border-radius: 16rpx; padding: 24rpx; font-size: 32rpx; font-weight: 600; }\r\n.profile__submit-btn:active { opacity: .9; transform: scale(.98); }\r\n\r\n.safe-area-bottom { height: env(safe-area-inset-bottom); min-height: 0rpx; }\r\n\r\n@media (max-width: 1023px) {\r\n  .profile__card-header { padding: 28rpx 28rpx 22rpx; }\r\n  .profile__card-row { padding: 24rpx 28rpx; }\r\n}\r\n</style>\r\n\r\n","import MiniProgramPage from 'C:/Users/97247/Desktop/uni-ecoful/pages/profile/changePhone.vue'\nwx.createPage(MiniProgramPage)"],"names":["navTitleStore","onShow","useUserStore","ref","computed","uni","request","_a","onUnmounted"],"mappings":"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"}