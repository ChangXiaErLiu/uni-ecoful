{"version":3,"file":"request.js","sources":["services/request.js"],"sourcesContent":["﻿// request.js\n// === 基础配置 ===\nexport const BASE_URL = 'http://localhost:6039'; // 如有 context-path 一并写上\n\n// 统一请求（非流式接口仍然可用）\nexport function createRequest(options = {}) {\n  return function request(config) {\n    const { url, method = 'GET', data = {}, header = {} } = config\n    return new Promise((resolve, reject) => {\n      uni.request({\n        url: url.startsWith('http') ? url : (BASE_URL + url),\n        method,\n        data,\n        header: {\n          'Content-Type': 'application/json',\n          ...options.header,\n          ...header\n        },\n        success: (res) => resolve(res.data),\n        fail: (error) => {\n          console.error('请求失败：', error)\n          reject(error)\n        }\n      })\n    })\n  }\n}\n\nexport const request = createRequest()\n\n/**\n * === 新增：聊天流式接口（仅 H5 生效）===\n * @param {Object} chatRequest - { model/modelName, messages:[{role,content}], stream:true }\n * @param {function(string)} onDelta - 每次增量回调\n * @param {function()} onDone - 结束回调\n * @param {function(Error)} onError - 错误回调\n * @returns {function} cancel - 调用可中断生成\n */\nexport function chatStream(\n  chatRequest,\n  onDelta = () => {},\n  onDone  = () => {},\n  onError = () => {}\n) {\n  let cancelled = false\n  let aborter = null\n\n  // #ifdef H5\n  ;(async () => {\n    try {\n      const controller = new AbortController()\n      aborter = controller\n      const res = await fetch(`${BASE_URL}/chat/send`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'text/event-stream'\n        },\n        body: JSON.stringify(chatRequest),\n        signal: controller.signal,\n        // 保险：明确跨域模式\n        mode: 'cors',\n      })\n      if (!res.ok || !res.body) throw new Error(`请求失败：${res.status}`)\n\n      const reader  = res.body.getReader()\n      const decoder = new TextDecoder('utf-8')\n\n      while (true) {\n        const { value, done } = await reader.read()\n        if (done || cancelled) break\n        const chunk = decoder.decode(value, { stream: true })\n        for (const line of chunk.split('\\n')) {\n          if (!line.startsWith('data:')) continue\n          const data = line.slice(5).trim()\n          if (!data) continue\n          if (data === '[DONE]') onDone()\n          else onDelta(data)\n        }\n      }\n      onDone()\n    } catch (err) {\n      if (!cancelled) onError(err)\n    }\n  })()\n  // #endif\n\n  // #ifndef H5\n  onError(new Error('当前平台暂不支持流式聊天（仅 H5 浏览器）。'))\n  // #endif\n\n  // 始终返回“可取消”的函数（即使没用到也存在，不会是 null）\n  return () => {\n    cancelled = true\n    try { aborter && aborter.abort() } catch (e) {}\n  }\n}"],"names":[],"mappings":";;AAsCO,SAAS,WACd,aACA,UAAU,MAAM;AAAE,GAClB,SAAU,MAAM;AAAE,GAClB,UAAU,MAAM;AAAE,GAClB;AAEA,MAAI,UAAU;AA2Cd,UAAQ,IAAI,MAAM,yBAAyB,CAAC;AAI5C,SAAO,MAAM;AAEX,QAAI;AAAE,iBAAW,QAAQ,MAAK;AAAA,IAAI,SAAQ,GAAG;AAAA,IAAE;AAAA,EAChD;AACH;;"}