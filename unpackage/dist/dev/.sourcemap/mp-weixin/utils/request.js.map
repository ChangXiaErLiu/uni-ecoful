{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["// request.js（UTF-8，中文注释）\n// 说明：统一请求与流式请求封装；基础地址从 utils/config.js 注入\nimport { BASE_URL, WS_URL } from './config.js'\n\n// 统一请求（函数式工厂，保留灵活性）\nexport function createRequest(options = {}) {\n  return function request(config) {\n    const { url, method = 'GET', data = {}, header = {} } = config\n    return new Promise((resolve, reject) => {\n      uni.request({\n        url: url.startsWith('http') ? url : (BASE_URL + url),\n        method,\n        data,\n        header: {\n          'Content-Type': 'application/json',\n          ...options.header,\n          ...header\n        },\n        success: (res) => {\n          console.log('请求成功:', res.data)\n          resolve(res.data)\n        },\n        fail: (error) => {\n          console.error('请求失败:', error)\n          reject(error)\n        }\n      })\n    })\n  }\n}\n\nexport const request = createRequest()\n\n/**\n * 聊天流式接口（H5 使用 SSE；小程序使用 WebSocket）\n * @param {Object} chatRequest - { model/modelName, messages:[{role,content}], stream:true }\n * @param {function(string)} onDelta - 每段增量回调\n * @param {function()} onDone - 完成回调\n * @param {function(Error)} onError - 出错回调\n * @returns {function} cancel - 取消函数\n */\n\n// chatStream：跨端流式实现\nexport function chatStream(\n  chatRequest,\n  onDelta = () => {},\n  onDone  = () => {},\n  onError = () => {}\n) {\n  let cancelled = false\n  let aborter = null\n\n  // #ifdef MP\n  // 小程序端：使用 WebSocket 实现\n  try {\n    // 若未使用 wss 提示（在发布前请确保为 wss:// 且配置合法域名）\n    // #ifdef MP\n    try {\n      if (typeof WS_URL === 'string' && /^ws:\\/\\//i.test(WS_URL)) {\n        console.warn('当前为 ws://，小程序需使用 wss:// 且配置合法域名:', WS_URL)\n      }\n    } catch(e) {}\n    // #endif\n    const socketTask = uni.connectSocket({ url: WS_URL, protocols: [], tcpNoDelay: true })\n    let opened = false\n\n    socketTask.onOpen(() => {\n      opened = true\n      try {\n        socketTask.send({ data: JSON.stringify(chatRequest) })\n      } catch (e) {\n        onError && onError(e)\n      }\n    })\n\n    socketTask.onMessage((evt) => {\n      if (cancelled) return\n      try {\n        // 约定：服务端每条消息为一段纯文本，收到 \"[DONE]\" 表示结束\n        const data = (evt?.data ?? '')\n        if (!data) return\n        if (data === '[DONE]') {\n          onDone && onDone()\n          return\n        }\n        onDelta && onDelta(String(data))\n      } catch (err) {\n        onError && onError(err)\n      }\n    })\n\n    socketTask.onError((err) => {\n      if (!cancelled) onError && onError(err)\n    })\n\n    socketTask.onClose(() => {\n      if (!cancelled) onDone && onDone()\n    })\n\n    return () => {\n      cancelled = true\n      try { socketTask?.close?.() } catch (e) {}\n    }\n  } catch (err) {\n    onError && onError(err)\n  }\n  // #endif\n\n  // #ifdef H5\n  ;(async () => {\n    try {\n      const controller = new AbortController()\n      aborter = controller\n      \n      // H5 使用 fetch + SSE（服务端需返回 text/event-stream）\n      const res = await fetch(BASE_URL + '/chat/send', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'text/event-stream'\n        },\n        body: JSON.stringify(chatRequest),\n        signal: controller.signal,\n        mode: 'cors',\n      })\n      \n      if (!res.ok || !res.body) throw new Error(`流式请求失败: ${res.status}`)\n\n      const reader = res.body.getReader()\n      const decoder = new TextDecoder('utf-8')\n\n      while (true) {\n        const { value, done } = await reader.read()\n        \n        // 读取结束\n        if (done) {\n          onDone && onDone()\n          break\n        }\n\n        const chunk = decoder.decode(value, { stream: true })\n        \n        const lines = chunk.replace(/\\r/g, '').split('\\n')\n\n        for (const raw of lines) {\n          const line = raw.trim()\n          if (!line) continue\n\n          let payload = ''\n          if (line.startsWith('data:')) payload = line.slice(5).trim()\n          else payload = line\n\n          if (!payload) continue\n          if (payload === '[DONE]') {\n            console.log('收到 [DONE]，触发 onDone')\n            onDone && onDone()\n            continue\n          }\n          \n          onDelta && onDelta(payload)\n        }\n      }\n    } catch (err) {\n      console.error('流式请求错误:', err)\n      if (!cancelled) onError(err)\n    }\n  })()\n  // #endif\n\n  // #ifndef H5\n  console.error('当前平台不支持流式请求（仅 H5 / 小程序）')\n  onError(new Error('当前平台不支持流式请求（仅 H5 / 小程序）'))\n  // #endif\n\n  return () => {\n    cancelled = true\n    try { aborter && aborter.abort() } catch (e) {}\n  }\n}\n\n"],"names":["request","uni","BASE_URL","WS_URL"],"mappings":";;;AAKO,SAAS,cAAc,UAAU,IAAI;AAC1C,SAAO,SAASA,SAAQ,QAAQ;AAC9B,UAAM,EAAE,KAAK,SAAS,OAAO,OAAO,IAAI,SAAS,CAAE,EAAA,IAAK;AACxD,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCC,oBAAAA,MAAI,QAAQ;AAAA,QACV,KAAK,IAAI,WAAW,MAAM,IAAI,MAAOC,aAAQ,WAAG;AAAA,QAChD;AAAA,QACA;AAAA,QACA,QAAQ;AAAA,UACN,gBAAgB;AAAA,UAChB,GAAG,QAAQ;AAAA,UACX,GAAG;AAAA,QACJ;AAAA,QACD,SAAS,CAAC,QAAQ;AAChBD,wBAAY,MAAA,MAAA,OAAA,0BAAA,SAAS,IAAI,IAAI;AAC7B,kBAAQ,IAAI,IAAI;AAAA,QACjB;AAAA,QACD,MAAM,CAAC,UAAU;AACfA,wBAAAA,MAAA,MAAA,SAAA,0BAAc,SAAS,KAAK;AAC5B,iBAAO,KAAK;AAAA,QACb;AAAA,MACT,CAAO;AAAA,IACP,CAAK;AAAA,EACF;AACH;AAEY,MAAC,UAAU,cAAe;AAY/B,SAAS,WACd,aACA,UAAU,MAAM;AAAE,GAClB,SAAU,MAAM;AAAE,GAClB,UAAU,MAAM;AAAE,GAClB;AACA,MAAI,YAAY;AAChB,MAAI,UAAU;AAId,MAAI;AAGF,QAAI;AACF,UAAI,OAAOE,aAAM,WAAK,YAAY,YAAY,KAAKA,aAAM,MAAA,GAAG;AAC1DF,sBAAAA,MAAa,MAAA,QAAA,0BAAA,oCAAoCE,aAAAA,MAAM;AAAA,MACxD;AAAA,IACP,SAAY,GAAG;AAAA,IAAE;AAEb,UAAM,aAAaF,cAAAA,MAAI,cAAc,EAAE,KAAKE,qBAAQ,WAAW,CAAE,GAAE,YAAY,MAAM;AACrF,QAAI,SAAS;AAEb,eAAW,OAAO,MAAM;AACtB,eAAS;AACT,UAAI;AACF,mBAAW,KAAK,EAAE,MAAM,KAAK,UAAU,WAAW,GAAG;AAAA,MACtD,SAAQ,GAAG;AACV,mBAAW,QAAQ,CAAC;AAAA,MACrB;AAAA,IACP,CAAK;AAED,eAAW,UAAU,CAAC,QAAQ;AAC5B,UAAI;AAAW;AACf,UAAI;AAEF,cAAM,QAAQ,2BAAK,SAAQ;AAC3B,YAAI,CAAC;AAAM;AACX,YAAI,SAAS,UAAU;AACrB,oBAAU,OAAQ;AAClB;AAAA,QACD;AACD,mBAAW,QAAQ,OAAO,IAAI,CAAC;AAAA,MAChC,SAAQ,KAAK;AACZ,mBAAW,QAAQ,GAAG;AAAA,MACvB;AAAA,IACP,CAAK;AAED,eAAW,QAAQ,CAAC,QAAQ;AAC1B,UAAI,CAAC;AAAW,mBAAW,QAAQ,GAAG;AAAA,IAC5C,CAAK;AAED,eAAW,QAAQ,MAAM;AACvB,UAAI,CAAC;AAAW,kBAAU,OAAQ;AAAA,IACxC,CAAK;AAED,WAAO,MAAM;;AACX,kBAAY;AACZ,UAAI;AAAE,uDAAY,UAAZ;AAAA,MAAqB,SAAU,GAAG;AAAA,MAAE;AAAA,IAC3C;AAAA,EACF,SAAQ,KAAK;AACZ,eAAW,QAAQ,GAAG;AAAA,EACvB;AAiEDF,gBAAAA,MAAc,MAAA,SAAA,2BAAA,yBAAyB;AACvC,UAAQ,IAAI,MAAM,yBAAyB,CAAC;AAG5C,SAAO,MAAM;AACX,gBAAY;AACZ,QAAI;AAAE,iBAAW,QAAQ,MAAK;AAAA,IAAI,SAAQ,GAAG;AAAA,IAAE;AAAA,EAChD;AACH;;;"}