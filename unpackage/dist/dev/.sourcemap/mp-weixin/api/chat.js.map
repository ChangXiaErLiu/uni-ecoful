{"version":3,"file":"chat.js","sources":["api/chat.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { request } from '@/utils/request.js'  \n\nexport const useChatStore = defineStore('chat', {\n  state: () => ({\n    sessions: [],\n    activeSessionId: 'default',\n    messageMap: {}\n  }),\n  \n  getters: {\n    activeSession(state) {\n      return state.sessions.find((item) => item.id === state.activeSessionId) || null\n    },\n    messages(state) {\n      return state.messageMap[state.activeSessionId] || []\n    }\n  },\n  \n  actions: {\n    ensureSession(sessionId = this.activeSessionId) {\n      if (!this.sessions.find(s => s.id === sessionId)) {\n        this.sessions = [...this.sessions, { id: sessionId, title: '粤风AI助手' }]\n      }\n      if (!this.messageMap[sessionId]) {\n        this.messageMap[sessionId] = []\n      }\n    },\n\n    setSessions(list) { \n      this.sessions = list \n    },\n    \n    setActiveSession(sessionId) { \n      this.activeSessionId = sessionId \n    },\n    \n    upsertMessages(sessionId, messages) { \n      this.messageMap[sessionId] = messages \n    },\n    \n    async sendMessage({ content }) {\n      const sessionId = this.activeSessionId || 'default'\n      this.ensureSession(sessionId)\n\n      // 1. 添加用户消息\n      const userMsg = { role: 'user', content, timestamp: Date.now() }\n      this.messageMap[sessionId] = [...this.messageMap[sessionId], userMsg]\n\n      // 2. 添加 AI 占位消息\n      const aiMsg = { role: 'assistant', content: '', timestamp: Date.now() }\n      const aiIndex = this.messageMap[sessionId].length\n      this.messageMap[sessionId] = [...this.messageMap[sessionId], aiMsg]\n\n      // 3. 调用流式请求（✅ 使用 request.chatStream）\n      try {\n        const cancel = request.chatStream(\n          {\n            url: '/chat/stream',  // 使用相对路径，会自动拼接 WS_URL\n            method: 'POST',\n            body: {\n              model: 'qwen3-max',\n              messages: this.messageMap[sessionId].map(m => ({ \n                role: m.role, \n                content: m.content \n              })),\n              stream: true\n            }\n          },\n          // onDelta: 收到数据片段\n          (delta) => {\n            aiMsg.content += delta\n            const arr = [...this.messageMap[sessionId]]\n            arr[aiIndex] = { ...aiMsg }\n            this.messageMap[sessionId] = arr\n          },\n          // onError: 流式错误\n          (err) => {\n            aiMsg.content += '\\n[流式错误] ' + (err?.message || err)\n            const arr = [...this.messageMap[sessionId]]\n            arr[aiIndex] = { ...aiMsg }\n            this.messageMap[sessionId] = arr\n          },\n          // onDone: 流式完成\n          () => {\n            console.log('[Chat] 流式响应完成')\n          }\n        )\n\n        // 4. 存储 cancel 函数（用于中断）\n        this._cancel = cancel\n      } catch (error) {\n        // 初始化连接失败\n        aiMsg.content += '\\n[连接失败] ' + error.message\n        const arr = [...this.messageMap[sessionId]]\n        arr[aiIndex] = { ...aiMsg }\n        this.messageMap[sessionId] = arr\n      }\n    },\n\n    // 新增：中断聊天\n    cancelChat() {\n      if (this._cancel) {\n        this._cancel()\n        this._cancel = null\n        return true\n      }\n      return false\n    }\n  }\n})"],"names":["defineStore","request","uni"],"mappings":"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"}