{"version":3,"file":"chat.js","sources":["api/chat.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { chatStream } from '@/utils/request.js'\n\nexport const useChatStore = defineStore('chat', {\n  state: () => ({\n    sessions: [],\n    activeSessionId: 'default',\n    messageMap: {}\n  }),\n  \n  getters: {\n    activeSession(state) {\n      return state.sessions.find((item) => item.id === state.activeSessionId) || null\n    },\n    messages(state) {\n      return state.messageMap[state.activeSessionId] || []\n    }\n  },\n  \n  actions: {\r\n\tensureSession(sessionId = this.activeSessionId) {\r\n\t  if (!this.sessions.find(s => s.id === sessionId)) {\r\n\t    this.sessions = [...this.sessions, { id: sessionId, title: '粤风AI助手' }]\r\n\t  }\r\n\t  if (!this.messageMap[sessionId]) {\r\n\t    // 确保有消息数组\r\n\t    this.messageMap[sessionId] = []\r\n\t  }\r\n\t},\n    setSessions(list) { \n      this.sessions = list \r\n\t  \n    },\n    \n    setActiveSession(sessionId) { \n      this.activeSessionId = sessionId \n    },\n    \n    upsertMessages(sessionId, messages) { \n      this.messageMap[sessionId] = messages \n    },\n\tasync sendMessage({ content }) {\r\n\t  const sessionId = this.activeSessionId || 'default'\r\n\t  this.ensureSession(sessionId) // <<< 关键：保证会话与消息数组存在\r\n\t\r\n\t  // 1) 先 push 用户消息\r\n  const userMsg = { role: 'user', content, timestamp: Date.now() }\n\t  const list1 = [...(this.messageMap[sessionId] || [])]\r\n\t  list1.push(userMsg)\r\n\t  this.messageMap[sessionId] = list1\r\n\t\r\n\t  // 2) 再 push AI 占位\r\n  const aiMsg = { role: 'assistant', content: '', timestamp: Date.now() }\n\t  const list2 = [...this.messageMap[sessionId]]\r\n\t  const aiIndex = list2.length\r\n\t  list2.push(aiMsg)\r\n\t  this.messageMap[sessionId] = list2\r\n\t\r\n\t  // 3) 开始流式\r\n\t  const cancel = chatStream(\r\n\t    {\r\n\t      url: '/chat/send',\r\n\t      method: 'POST',\r\n\t      body: {\r\n\t        model: 'qwen3-max',\r\n\t        modelName: 'qwen3-max',\r\n\t        messages: this.messageMap[sessionId].map(m => ({ role: m.role, content: m.content })),\r\n\t        stream: true\r\n\t      }\r\n\t    },\r\n\t    // onDelta\r\n\t    (delta) => {\r\n\t      aiMsg.content += delta\r\n\t      const arr = [...this.messageMap[sessionId]]\r\n\t      arr[aiIndex] = { ...aiMsg }\r\n\t      this.messageMap[sessionId] = arr\r\n\t      // console.log('delta:', delta)\r\n\t    },\r\n\t    // onError\r\n\t    (err) => {\r\n\t      aiMsg.content += '\\n[错误] ' + (err?.message || err)\r\n\t      const arr = [...this.messageMap[sessionId]]\r\n\t      arr[aiIndex] = { ...aiMsg }\r\n\t      this.messageMap[sessionId] = arr\r\n\t    },\r\n\t    // onDone（可选）\r\n\t    () => {}\r\n\t  )\r\n\t\r\n\t  // 存一下 cancel 如需中断\r\n\t  this._cancel = cancel\r\n\t}\r\n\n    \n  }\n})\n"],"names":["defineStore","chatStream"],"mappings":";;;AAG4BA,cAAW,YAAC,QAAQ;AAAA,EAC9C,OAAO,OAAO;AAAA,IACZ,UAAU,CAAE;AAAA,IACZ,iBAAiB;AAAA,IACjB,YAAY,CAAE;AAAA,EAClB;AAAA,EAEE,SAAS;AAAA,IACP,cAAc,OAAO;AACnB,aAAO,MAAM,SAAS,KAAK,CAAC,SAAS,KAAK,OAAO,MAAM,eAAe,KAAK;AAAA,IAC5E;AAAA,IACD,SAAS,OAAO;AACd,aAAO,MAAM,WAAW,MAAM,eAAe,KAAK,CAAE;AAAA,IACrD;AAAA,EACF;AAAA,EAED,SAAS;AAAA,IACV,cAAc,YAAY,KAAK,iBAAiB;AAC9C,UAAI,CAAC,KAAK,SAAS,KAAK,OAAK,EAAE,OAAO,SAAS,GAAG;AAChD,aAAK,WAAW,CAAC,GAAG,KAAK,UAAU,EAAE,IAAI,WAAW,OAAO,UAAU;AAAA,MACtE;AACD,UAAI,CAAC,KAAK,WAAW,SAAS,GAAG;AAE/B,aAAK,WAAW,SAAS,IAAI,CAAE;AAAA,MAChC;AAAA,IACF;AAAA,IACE,YAAY,MAAM;AAChB,WAAK,WAAW;AAAA,IAEjB;AAAA,IAED,iBAAiB,WAAW;AAC1B,WAAK,kBAAkB;AAAA,IACxB;AAAA,IAED,eAAe,WAAW,UAAU;AAClC,WAAK,WAAW,SAAS,IAAI;AAAA,IAC9B;AAAA,IACJ,MAAM,YAAY,EAAE,WAAW;AAC7B,YAAM,YAAY,KAAK,mBAAmB;AAC1C,WAAK,cAAc,SAAS;AAG7B,YAAM,UAAU,EAAE,MAAM,QAAQ,SAAS,WAAW,KAAK,MAAO;AAC/D,YAAM,QAAQ,CAAC,GAAI,KAAK,WAAW,SAAS,KAAK,EAAI;AACrD,YAAM,KAAK,OAAO;AAClB,WAAK,WAAW,SAAS,IAAI;AAG9B,YAAM,QAAQ,EAAE,MAAM,aAAa,SAAS,IAAI,WAAW,KAAK,MAAO;AACtE,YAAM,QAAQ,CAAC,GAAG,KAAK,WAAW,SAAS,CAAC;AAC5C,YAAM,UAAU,MAAM;AACtB,YAAM,KAAK,KAAK;AAChB,WAAK,WAAW,SAAS,IAAI;AAG7B,YAAM,SAASC,cAAU;AAAA,QACvB;AAAA,UACE,KAAK;AAAA,UACL,QAAQ;AAAA,UACR,MAAM;AAAA,YACJ,OAAO;AAAA,YACP,WAAW;AAAA,YACX,UAAU,KAAK,WAAW,SAAS,EAAE,IAAI,QAAM,EAAE,MAAM,EAAE,MAAM,SAAS,EAAE,QAAS,EAAC;AAAA,YACpF,QAAQ;AAAA,UACT;AAAA,QACF;AAAA;AAAA,QAED,CAAC,UAAU;AACT,gBAAM,WAAW;AACjB,gBAAM,MAAM,CAAC,GAAG,KAAK,WAAW,SAAS,CAAC;AAC1C,cAAI,OAAO,IAAI,EAAE,GAAG,MAAO;AAC3B,eAAK,WAAW,SAAS,IAAI;AAAA,QAE9B;AAAA;AAAA,QAED,CAAC,QAAQ;AACP,gBAAM,WAAW,cAAa,2BAAK,YAAW;AAC9C,gBAAM,MAAM,CAAC,GAAG,KAAK,WAAW,SAAS,CAAC;AAC1C,cAAI,OAAO,IAAI,EAAE,GAAG,MAAO;AAC3B,eAAK,WAAW,SAAS,IAAI;AAAA,QAC9B;AAAA;AAAA,QAED,MAAM;AAAA,QAAE;AAAA,MACT;AAGD,WAAK,UAAU;AAAA,IAChB;AAAA,EAGC;AACH,CAAC;"}