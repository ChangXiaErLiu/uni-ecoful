{"version":3,"file":"acceptance.js","sources":["api/acceptance.js"],"sourcesContent":["/**\n * api/acceptance.js\n * 验收报告页面，各个方法总结\n * author:zyg\n * date:2025.12.1\n */\n\nimport {\n\tBASE_URL\n} from '@/utils/config.js'\nimport {\n\trequest\n} from '@/utils/request.js'\n\n/**\n * 执行任务（提取项目信息）- 异步版本\n * @param {Object} options - 选项\n * @param {number} options.projectId - 项目ID（必填）\n * @param {string} options.projectFolder - 项目文件夹名（必填）\n * @param {Function} options.onProgress - 进度回调函数 (progress, status) => void\n * @param {number} options.pollInterval - 轮询间隔（毫秒，默认3秒）\n * @param {number} options.timeout - 超时时间（毫秒，默认30分钟）\n * @returns {Promise<Object>} 任务执行结果\n */\nexport async function runTask(options = {}) {\n\tconst {\n\t\tprojectId = null,\n\t\t\tprojectFolder = null,\n\t\t\tonProgress = null,\n\t\t\tpollInterval = 3000, // 默认3秒轮询一次\n\t\t\ttimeout = 1800000 // 默认30分钟\n\t} = options\n\n\ttry {\n\t\t// 第一步：提交异步任务\n\t\t// console.log('📤 提交信息提取任务...')\n\t\tconst submitResult = await request.post('/api/v1/completion/extract-info/async/start', {\n\t\t\tproject_id: projectId,\n\t\t\tproject_folder: projectFolder,\n\t\t\tproject_data: {}\n\t\t}, {\n\t\t\thideLoading: true // 已经有了自定义提示窗)\n\t\t})\n\t\tconst taskId = submitResult.task_id\n\t\t// console.log(`✅ 任务已提交，Task ID: ${taskId}`)\n\n\t\t// 第二步：轮询任务状态\n\t\tconst startTime = Date.now()\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst pollStatus = async () => {\n\t\t\t\ttry {\n\t\t\t\t\t// 检查是否超时\n\t\t\t\t\tif (Date.now() - startTime > timeout) {\n\t\t\t\t\t\treject(new Error('任务超时，请稍后重试'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 查询任务状态\n\t\t\t\t\tconst statusResult = await request.get(`/api/v1/tasks/${taskId}/status`, {\n\t\t\t\t\t\thideLoading: true // 已有自定义进度提示窗\n\t\t\t\t\t})\n\n\t\t\t\t\tconst {\n\t\t\t\t\t\tstatus,\n\t\t\t\t\t\tprogress = 0,\n\t\t\t\t\t\tcurrent_step = '',\n\t\t\t\t\t\ttask_result,\n\t\t\t\t\t\terror_message\n\t\t\t\t\t} = statusResult\n\n\t\t\t\t\tconsole.log(`[${status}] ${progress}% - ${current_step}`)\n\n\t\t\t\t\t// 调用进度回调\n\t\t\t\t\tif (onProgress && typeof onProgress === 'function') {\n\t\t\t\t\t\tonProgress(progress, current_step, status)\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务完成\n\t\t\t\t\tif (status === 'success') {\n\t\t\t\t\t\t// console.log('✅ 任务完成！')\n\n\t\t\t\t\t\t// 数据校验\n\t\t\t\t\t\tconst data = task_result?.result || task_result\n\t\t\t\t\t\tif (!data || typeof data !== 'object' || Object.keys(data).length === 0) {\n\t\t\t\t\t\t\treject(new Error('未提取到任何项目信息，请检查文件内容是否完整'))\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\tstatus: 'success',\n\t\t\t\t\t\t\tresult: data\n\t\t\t\t\t\t})\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务失败\n\t\t\t\t\tif (status === 'failed') {\n\t\t\t\t\t\tconsole.error('❌ 任务失败:', error_message)\n\t\t\t\t\t\treject(new Error(error_message || '任务执行失败'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务取消\n\t\t\t\t\tif (status === 'cancelled') {\n\t\t\t\t\t\treject(new Error('任务已被取消'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 继续轮询\n\t\t\t\t\tsetTimeout(pollStatus, pollInterval)\n\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error('查询任务状态失败:', error)\n\t\t\t\t\treject(error)\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// 开始轮询\n\t\t\tpollStatus()\n\t\t})\n\n\t} catch (error) {\n\t\t// 错误分类处理\n\t\tif (error.code === 'NETWORK_ERROR' && error.message.includes('timeout')) {\n\t\t\tthrow new Error('提取超时：文档过大或网络不稳定，请稍后重试')\n\t\t} else if (error.code === 'HTTP_ERROR' && error.message.includes('404')) {\n\t\t\tthrow new Error('任务不存在，请联系管理员配置')\n\t\t} else {\n\t\t\tthrow error\n\t\t}\n\t}\n}\n\n/**\n * 取消正在运行的任务\n * @param {string} taskId - 任务ID\n * @returns {Promise<Object>} 取消结果\n */\nexport async function cancelTask(taskId) {\n\tif (!taskId) {\n\t\tthrow new Error('任务ID不能为空')\n\t}\n\n\ttry {\n\t\tconst result = await request.post(`/api/v1/tasks/${taskId}/cancel`)\n\t\treturn result\n\t} catch (error) {\n\t\tthrow new Error(error.message || '取消任务失败')\n\t}\n}\n\n/**\n * 获取我的任务列表\n * @param {Object} options - 选项\n * @param {string} options.status - 状态过滤（pending/running/success/failed）\n * @param {string} options.taskType - 任务类型过滤\n * @param {number} options.limit - 返回数量\n * @returns {Promise<Object>} 任务列表\n */\nexport async function getMyTasks(options = {}) {\n\tconst {\n\t\tstatus = null,\n\t\t\ttaskType = null,\n\t\t\tlimit = 20\n\t} = options\n\n\ttry {\n\t\tconst params = new URLSearchParams()\n\t\tif (status) params.append('status', status)\n\t\tif (taskType) params.append('task_type', taskType)\n\t\tparams.append('limit', limit)\n\n\t\tconst result = await request.get(`/api/v1/tasks/my-tasks?${params.toString()}`)\n\t\treturn result\n\t} catch (error) {\n\t\tthrow new Error(error.message || '获取任务列表失败')\n\t}\n}\n\n/**\n * 转换后端提取结果为 baseTable 格式（支持嵌套对象）\n * @param {Object} result - 后端返回的 result 对象\n * @returns {Array} baseTable 格式的数组\n */\nexport function transformExtractResult(result) {\n\t// 完整的字段映射表：后端中文 key -> 英文 id + 显示标签\n\tconst FIELD_MAP = {\n\t\t// 基本信息\n\t\t'建设项目名称': {\n\t\t\tid: 'project_name',\n\t\t\tlabel: '建设项目名称'\n\t\t},\n\t\t'建设单位名称': {\n\t\t\tid: 'company_name',\n\t\t\tlabel: '建设单位名称'\n\t\t},\n\t\t'建设地点': {\n\t\t\tid: 'project_address',\n\t\t\tlabel: '建设地点'\n\t\t},\n\t\t'建设项目性质': {\n\t\t\tid: 'project_type',\n\t\t\tlabel: '建设项目性质'\n\t\t},\n\t\t'产品及产能': {\n\t\t\tid: 'product_scale',\n\t\t\tlabel: '产品及产能'\n\t\t},\n\n\t\t// 审批信息\n\t\t'环评报告表审批部门': {\n\t\t\tid: 'assessment_department',\n\t\t\tlabel: '环评报告表审批部门'\n\t\t},\n\t\t'环评报告表编制单位': {\n\t\t\tid: 'assessment_unit',\n\t\t\tlabel: '环评报告表编制单位'\n\t\t},\n\n\t\t// 投资信息\n\t\t'投资总概算(万元)': {\n\t\t\tid: 'investment',\n\t\t\tlabel: '投资总概算(万元)'\n\t\t},\n\t\t'环保投资总概算(万元)': {\n\t\t\tid: 'env_investment',\n\t\t\tlabel: '环保投资总概算(万元)'\n\t\t},\n\t\t'比例': {\n\t\t\tid: 'env_investment_ratio',\n\t\t\tlabel: '环保投资占比'\n\t\t},\n\n\t\t// 建设内容\n\t\t'主要建设内容': {\n\t\t\tid: 'construction_content',\n\t\t\tlabel: '主要建设内容'\n\t\t},\n\t\t'改扩建项目变动情况': {\n\t\t\tid: 'project_changes',\n\t\t\tlabel: '改扩建项目变动情况'\n\t\t},\n\t\t// 建设内容\n\t\t'单位联系人': {\n\t\t\tid: 'contact_person',\n\t\t\tlabel: '单位联系人'\n\t\t},\n\t\t'联系方式': {\n\t\t\tid: 'contact_phone',\n\t\t\tlabel: '联系方式'\n\t\t},\n\t\t'注册地址': {\n\t\t\tid: 'registered_address',\n\t\t\tlabel: '建设单位注册地址'\n\t\t},\n\n\t\t// 污染物\n\t\t'固体废物产生情况': {\n\t\t\tid: 'solid_generation',\n\t\t\tlabel: '固体废物产生情况'\n\t\t},\n\t\t'污染物产排情况': {\n\t\t\tid: 'pollutants_emission',\n\t\t\tlabel: '污染物产排情况',\n\t\t\ttype: 'table' // 添加类型标识\n\t\t},\n\n\t}\n\n\tconst baseTable = []\n\n\t// 遍历 result 对象\n\tObject.entries(result).forEach(([chineseKey, value]) => {\n\t\t// 如果有映射，按映射显示\n\t\tif (FIELD_MAP[chineseKey]) {\n\t\t\tconst fieldConfig = FIELD_MAP[chineseKey]\n\n\t\t\t// ✅ 特殊处理表格类型数据\n\t\t\tif (fieldConfig.type === 'table') {\n\t\t\t\tbaseTable.push({\n\t\t\t\t\tid: fieldConfig.id,\n\t\t\t\t\tlabel: fieldConfig.label,\n\t\t\t\t\tvalue: value, // 保留原始对象，不进行格式化\n\t\t\t\t\tsource: 'extracted',\n\t\t\t\t\ttype: 'table' // 前端通过这个类型来识别需要渲染表格\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\t// 普通字段正常处理\n\t\t\t\tbaseTable.push({\n\t\t\t\t\tid: fieldConfig.id,\n\t\t\t\t\tlabel: fieldConfig.label,\n\t\t\t\t\tvalue: formatValue(value),\n\t\t\t\t\tsource: 'extracted'\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\t// 如果是嵌套对象（但不是表格类型），展开显示\n\t\telse if (typeof value === 'object' && value !== null) {\n\t\t\tObject.entries(value).forEach(([subKey, subValue]) => {\n\t\t\t\tbaseTable.push({\n\t\t\t\t\tid: `${chineseKey}_${subKey}`,\n\t\t\t\t\tlabel: `${chineseKey} - ${subKey}`,\n\t\t\t\t\tvalue: formatValue(subValue),\n\t\t\t\t\tsource: 'extracted'\n\t\t\t\t})\n\t\t\t})\n\t\t}\n\t\t// 如果没有映射，直接显示\n\t\telse {\n\t\t\tbaseTable.push({\n\t\t\t\tid: chineseKey,\n\t\t\t\tlabel: chineseKey,\n\t\t\t\tvalue: formatValue(value),\n\t\t\t\tsource: 'extracted'\n\t\t\t})\n\t\t}\n\t})\n\n\t// 按id顺序排序\n\tconst ORDER = [\n\t\t'project_name', // 建设项目名称\n\t\t'company_name', // 建设单位名称\n\t\t'project_address', // 建设地点\n\t\t'project_type', // 建设项目性质\n\t\t'product_scale', // 产品及产能\n\t\t'assessment_department', // 环评报告表审批部门\n\t\t'assessment_unit', // 环评报告表编制单位\n\t\t'investment', // 投资总概算(万元)\n\t\t'env_investment', // 环保投资总概算(万元)\n\t\t'env_investment_ratio', // 比例\n\t\t'construction_content', // 主要建设内容\n\t\t'project_changes', // 改扩建项目变动情况\n\t\t'registered_address', // 注册地址\n\t\t'contact_person', // 联系人\n\t\t'contact_phone', // 联系方式\n\t\t'solid_generation', // 固体废物产生情况\n\t\t'pollutants_emission', // 污染物产排情况\n\t];\n\treturn baseTable.sort((a, b) => {\n\t\tconst aIndex = ORDER.indexOf(a.id)\n\t\tconst bIndex = ORDER.indexOf(b.id)\n\t\tif (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex\n\t\tif (aIndex !== -1) return -1\n\t\tif (bIndex !== -1) return 1\n\t\treturn 0\n\t})\n}\n\n// 格式化值的辅助函数（处理数组、对象等）\nfunction formatValue(value) {\n\t// 如果是数组，转成字符串\n\tif (Array.isArray(value)) {\n\t\treturn value.length > 0 ? JSON.stringify(value, null, 2) : '未提取到相关信息'\n\t}\n\t// 如果是对象，转成字符串\n\tif (typeof value === 'object' && value !== null) {\n\t\treturn JSON.stringify(value, null, 2)\n\t}\n\t// 如果是数字，直接返回\n\tif (typeof value === 'number') {\n\t\treturn value\n\t}\n\t// 如果是字符串，去掉首尾空格\n\tif (typeof value === 'string') {\n\t\treturn value.trim() || '未提取到相关信息'\n\t}\n\t// 其他情况\n\treturn value || '未提取到相关信息'\n}\n\n/**\n * 标识牌下载\n * 纯前端数据 → 后端生成 Word\n * @param {Object} signboard - 标识牌数据\n * @param {number} projectId - 项目ID（必填）\n * @returns {Promise<ArrayBuffer>}\n */\nexport function downloadSignboardWord(signboard, projectId) {\n\tif (!projectId) {\n\t\tthrow new Error('项目ID不能为空')\n\t}\n\n\tconst payload = {\n\t\tproject_id: projectId, // 添加项目ID\n\t\tsections: signboard.sections.map(sec => ({\n\t\t\tblock: sec.block,\n\t\t\titems: sec.items.map(it => ({\n\t\t\t\ttitle: it.title,\n\t\t\t\tcontent: it.content\n\t\t\t}))\n\t\t}))\n\t};\n\n\t// #ifdef H5\n\t// H5 环境：uni.request 的 arraybuffer 不稳定，使用原生 fetch\n\tconst token = uni.getStorageSync('token')\n\tconst headers = {\n\t\t'Content-Type': 'application/json'\n\t}\n\tif (token) {\n\t\theaders['Authorization'] = `Bearer ${token}`\n\t}\n\n\treturn fetch(BASE_URL + '/api/v1/completion/signboard/download', {\n\t\tmethod: 'POST',\n\t\theaders: headers,\n\t\tbody: JSON.stringify(payload)\n\t}).then(res => {\n\t\tif (!res.ok) {\n\t\t\t// 处理不同的错误状态\n\t\t\tif (res.status === 403) {\n\t\t\t\tthrow new Error('您不是该项目的成员，无权下载标识牌')\n\t\t\t} else if (res.status === 404) {\n\t\t\t\tthrow new Error('项目提取结果文件不存在，请先提取项目信息')\n\t\t\t} else {\n\t\t\t\tthrow new Error('生成失败')\n\t\t\t}\n\t\t}\n\t\treturn res.arrayBuffer()\n\t})\n\t// #endif\n\n\t// #ifndef H5\n\t// 小程序/App 环境：直接使用 uni.request（因为 responseType 需要特殊处理）\n\treturn new Promise((resolve, reject) => {\n\t\tconst token = uni.getStorageSync('token')\n\t\tconst header = {\n\t\t\t'Content-Type': 'application/json'\n\t\t}\n\t\tif (token) {\n\t\t\theader['Authorization'] = `Bearer ${token}`\n\t\t}\n\n\t\tuni.request({\n\t\t\turl: BASE_URL + '/api/v1/completion/signboard/download',\n\t\t\tmethod: 'POST',\n\t\t\tdata: payload,\n\t\t\theader: header,\n\t\t\tresponseType: 'arraybuffer',\n\t\t\tsuccess: (res) => {\n\t\t\t\tconsole.log('标识牌下载响应:', res)\n\t\t\t\tif (res.statusCode === 200 && res.data) {\n\t\t\t\t\t// 检查是否是 ArrayBuffer\n\t\t\t\t\tif (res.data instanceof ArrayBuffer && res.data.byteLength > 0) {\n\t\t\t\t\t\tresolve(res.data)\n\t\t\t\t\t} else if (typeof res.data === 'string' && res.data.length > 0) {\n\t\t\t\t\t\t// 如果返回的是字符串，说明小程序没有正确处理 arraybuffer\n\t\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\t\ttitle: '文件格式错误',\n\t\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t\t})\n\t\t\t\t\t\treject(new Error('文件格式错误'))\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(new Error('空文件'))\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\treject(new Error('生成失败'))\n\t\t\t\t}\n\t\t\t},\n\t\t\tfail: (error) => {\n\t\t\t\treject(new Error(error.errMsg || '网络请求失败'))\n\t\t\t}\n\t\t})\n\t})\n\t// #endif\n}\n\n/**\n * 生成监测方案（异步任务）\n * @param {Object} options - 选项\n * @param {number} options.projectId - 项目ID（必填）\n * @param {Function} options.onProgress - 进度回调函数 (progress, status) => void\n * @param {number} options.pollInterval - 轮询间隔（毫秒，默认3秒）\n * @param {number} options.timeout - 超时时间（毫秒，默认30分钟）\n * @returns {Promise<Object>} 任务执行结果\n */\nexport async function generateMonitorPlan(options = {}) {\n\tconst {\n\t\tprojectId = null,\n\t\t\tonProgress = null,\n\t\t\tpollInterval = 3000,\n\t\t\ttimeout = 1800000 // 默认30分钟\n\t} = options\n\n\tif (!projectId) {\n\t\tthrow new Error('项目ID不能为空')\n\t}\n\n\ttry {\n\t\t// 第一步：提交异步任务\n\t\tconst submitResult = await request.post('/api/v1/completion/monitor-plan/async/start', {\n\t\t\tproject_id: projectId\n\t\t})\n\n\t\tconst taskId = submitResult.task_id\n\t\t// console.log(`✅ 监测方案任务已提交，Task ID: ${taskId}`)\n\n\t\t// 第二步：轮询任务状态\n\t\tconst startTime = Date.now()\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst pollStatus = async () => {\n\t\t\t\ttry {\n\t\t\t\t\t// 检查是否超时\n\t\t\t\t\tif (Date.now() - startTime > timeout) {\n\t\t\t\t\t\treject(new Error('任务超时，请稍后重试'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 查询任务状态\n\t\t\t\t\tconst statusResult = await request.get(`/api/v1/tasks/${taskId}/status`)\n\n\t\t\t\t\tconst {\n\t\t\t\t\t\tstatus,\n\t\t\t\t\t\tprogress = 0,\n\t\t\t\t\t\tcurrent_step = '',\n\t\t\t\t\t\ttask_result,\n\t\t\t\t\t\terror_message\n\t\t\t\t\t} = statusResult\n\n\t\t\t\t\tconsole.log(`[${status}] ${progress}% - ${current_step}`)\n\n\t\t\t\t\t// 调用进度回调\n\t\t\t\t\tif (onProgress && typeof onProgress === 'function') {\n\t\t\t\t\t\tonProgress(progress, current_step, status)\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务完成\n\t\t\t\t\tif (status === 'success') {\n\t\t\t\t\t\tconsole.log('✅ 监测方案生成完成！')\n\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\tstatus: 'success',\n\t\t\t\t\t\t\tresult: task_result,\n\t\t\t\t\t\t\tproject_id: projectId\n\t\t\t\t\t\t})\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务失败\n\t\t\t\t\tif (status === 'failed') {\n\t\t\t\t\t\tconsole.error('❌ 任务失败:', error_message)\n\t\t\t\t\t\treject(new Error(error_message || '监测方案生成失败'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务取消\n\t\t\t\t\tif (status === 'cancelled') {\n\t\t\t\t\t\treject(new Error('任务已被取消'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 继续轮询\n\t\t\t\t\tsetTimeout(pollStatus, pollInterval)\n\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error('查询任务状态失败:', error)\n\t\t\t\t\treject(error)\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// 开始轮询\n\t\t\tpollStatus()\n\t\t})\n\n\t} catch (error) {\n\t\tif (error.message && error.message.includes('已有一个监测方案生成任务正在运行')) {\n\t\t\tthrow new Error('您已有一个监测方案生成任务正在运行，请等待完成')\n\t\t}\n\t\tthrow error\n\t}\n}\n\n/**\n * 下载监测方案（不指定格式，完全信任后端返回的文件名）\n * @param {number} projectId - 项目ID\n * @returns {Promise<{ab:ArrayBuffer,filename:string}>} 文件流+真实文件名\n */\nexport function downloadMonitorPlan(projectId) {\n\tif (!projectId) throw new Error('项目ID不能为空')\n\n\tconst url = `/api/v1/completion/monitor-plan/${projectId}/download`\n\n\t// #ifdef H5\n\tconst token = uni.getStorageSync('token')\n\tconst headers = {}\n\tif (token) headers.Authorization = `Bearer ${token}`\n\treturn fetch(BASE_URL + url, {\n\t\t\tmethod: 'GET',\n\t\t\theaders\n\t\t})\n\t\t.then(res => {\n\t\t\tif (!res.ok) {\n\t\t\t\tif (res.status === 403) throw new Error('无权下载')\n\t\t\t\tif (res.status === 404) throw new Error('请先点击生成监测方案')\n\t\t\t\tthrow new Error('下载失败')\n\t\t\t}\n\t\t\t// 安全获取响应头（兼容大小写）\n\t\t\tconst contentDisposition = res.headers.get('content-disposition') ||\n\t\t\t\tres.headers.get('Content-Disposition') || ''\n\t\t\tconst filename = extractFilename(contentDisposition)\n\t\t\treturn res.arrayBuffer().then(ab => ({\n\t\t\t\tab,\n\t\t\t\tfilename\n\t\t\t}))\n\t\t})\n\t// #endif\n\n\t// #ifndef H5\n\treturn new Promise((resolve, reject) => {\n\t\tconst token = uni.getStorageSync('token')\n\t\tconst header = {}\n\t\tif (token) header.Authorization = `Bearer ${token}`\n\t\tuni.request({\n\t\t\turl: BASE_URL + url,\n\t\t\tmethod: 'GET',\n\t\t\theader,\n\t\t\tresponseType: 'arraybuffer',\n\t\t\tsuccess: (res) => {\n\t\t\t\tif (res.statusCode === 200 && res.data instanceof ArrayBuffer) {\n\t\t\t\t\t// 安全获取响应头（兼容大小写）\n\t\t\t\t\tconst contentDisposition = res.header?.['Content-Disposition'] ||\n\t\t\t\t\t\tres.header?.['content-disposition'] || ''\n\t\t\t\t\tconst filename = extractFilename(contentDisposition)\n\t\t\t\t\tresolve({\n\t\t\t\t\t\tab: res.data,\n\t\t\t\t\t\tfilename\n\t\t\t\t\t})\n\t\t\t\t} else if (res.statusCode === 404) {\n\t\t\t\t\treject(new Error('请先点击生成监测方案'))\n\t\t\t\t} else {\n\t\t\t\t\treject(new Error('下载失败'))\n\t\t\t\t}\n\t\t\t},\n\t\t\tfail: (e) => reject(new Error(e.errMsg || '网络错误'))\n\t\t})\n\t})\n\t// #endif\n}\n\n/* 从 Content-Disposition 头里抠文件名 */\nfunction extractFilename(str) {\n\t// 确保 str 是字符串，防止 null 或 undefined 导致错误\n\tif (!str || typeof str !== 'string') {\n\t\treturn 'AI生成报告.docx'\n\t}\n\n\t// 优先匹配 RFC 5987 编码格式：filename*=UTF-8''encoded_name\n\tconst rfc5987Match = str.match(/filename\\*=UTF-8''([^;\\n]+)/i)\n\tif (rfc5987Match && rfc5987Match[1]) {\n\t\ttry {\n\t\t\treturn decodeURIComponent(rfc5987Match[1])\n\t\t} catch {\n\t\t\t// 解码失败，继续尝试普通格式\n\t\t}\n\t}\n\n\t// 降级到普通格式：filename=\"name\" 或 filename=name\n\tconst normalMatch = str.match(/filename=[\"']?([^;\"'\\n]+)[\"']?/i)\n\tif (normalMatch && normalMatch[1]) {\n\t\tconst name = normalMatch[1].trim()\n\t\ttry {\n\t\t\treturn decodeURIComponent(name)\n\t\t} catch {\n\t\t\treturn name\n\t\t}\n\t}\n\n\treturn 'AI生成报告.docx'\n}\n\n\n\n/**\n * 生成竣工验收报告\n * @param {Object} options - 选项\n * @param {number} options.projectId - 项目ID（必填）\n * @param {Function} options.onProgress - 进度回调函数 (progress, status) => void\n * @param {number} options.pollInterval - 轮询间隔（毫秒，默认3秒）\n * @param {number} options.timeout - 超时时间（毫秒，默认30分钟）\n * @returns {Promise<Object>} 任务执行结果\n */\nexport async function generateReport(options = {}) {\n\tconst {\n\t\tprojectId = null,\n\t\t\tonProgress = null,\n\t\t\tpollInterval = 3000,\n\t\t\ttimeout = 1800000 // 默认30分钟\n\t} = options\n\n\tif (!projectId) {\n\t\tthrow new Error('项目ID不能为空')\n\t}\n\n\ttry {\n\t\t// 第一步：提交异步任务\n\t\t const submitResult = await request.post(\n\t\t   `/api/v1/completion/char/batch/merge/async?project_id=${projectId}`,\n\t\t   {} // body 为空\n\t\t )\n\n\t\tconst taskId = submitResult.task_id\n\t\t// console.log(`竣工验收报告生成任务已提交，Task ID: ${taskId}`)\n\n\t\t// 第二步：轮询任务状态\n\t\tconst startTime = Date.now()\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst pollStatus = async () => {\n\t\t\t\ttry {\n\t\t\t\t\t// 检查是否超时\n\t\t\t\t\tif (Date.now() - startTime > timeout) {\n\t\t\t\t\t\treject(new Error('任务超时，请稍后重试'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 查询任务状态\n\t\t\t\t\tconst statusResult = await request.get(`/api/v1/tasks/${taskId}/status`)\n\n\t\t\t\t\tconst {\n\t\t\t\t\t\tstatus,\n\t\t\t\t\t\tprogress = 0,\n\t\t\t\t\t\tcurrent_step = '',\n\t\t\t\t\t\ttask_result,\n\t\t\t\t\t\terror_message\n\t\t\t\t\t} = statusResult\n\n\t\t\t\t\t// console.log(`[${status}] ${progress}% - ${current_step}`)\n\n\t\t\t\t\t// 调用进度回调\n\t\t\t\t\tif (onProgress && typeof onProgress === 'function') {\n\t\t\t\t\t\tonProgress(progress, current_step, status)\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务完成\n\t\t\t\t\tif (status === 'success') {\n\t\t\t\t\t\tconsole.log('✅ 竣工验收报告已生成！')\n\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\tstatus: 'success',\n\t\t\t\t\t\t\tresult: task_result,\n\t\t\t\t\t\t\tproject_id: projectId\n\t\t\t\t\t\t})\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务失败\n\t\t\t\t\tif (status === 'failed') {\n\t\t\t\t\t\tconsole.error('❌ 任务失败:', error_message)\n\t\t\t\t\t\treject(new Error(error_message || '竣工验收报告生成失败'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 任务取消\n\t\t\t\t\tif (status === 'cancelled') {\n\t\t\t\t\t\treject(new Error('任务已被取消'))\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// 继续轮询\n\t\t\t\t\tsetTimeout(pollStatus, pollInterval)\n\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error('查询任务状态失败:', error)\n\t\t\t\t\treject(error)\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// 开始轮询\n\t\t\tpollStatus()\n\t\t})\n\n\t} catch (error) {\n\t\tif (error.message && error.message.includes('已有一个竣工验收报告生成任务正在运行')) {\n\t\t\tthrow new Error('您已有一个竣工验收报告生成任务正在运行，请等待完成')\n\t\t}\n\t\tthrow error\n\t}\n}\n\n/**\n * 下载竣工验收报告\n * @param {number} projectId - 项目ID\n * @returns {Promise<{ab:ArrayBuffer,filename:string}>} 文件流+真实文件名\n */\nexport function downloadReport(projectId) {\n\tif (!projectId) throw new Error('项目ID不能为空')\n\n\tconst url = `/api/v1/completion/char/batch/merge/download?project_id=${projectId}`\n\t// #ifdef H5\n\tconst token = uni.getStorageSync('token')\n\tconst headers = {}\n\tif (token) headers.Authorization = `Bearer ${token}`\n\treturn fetch(BASE_URL + url, {\n\t\t\tmethod: 'GET',\n\t\t\theaders\n\t\t})\n\t\t.then(res => {\n\t\t\tif (!res.ok) {\n\t\t\t\tif (res.status === 403) throw new Error('无权下载')\n\t\t\t\tif (res.status === 404) throw new Error('请先点击生成竣工验收报告')\n\t\t\t\tthrow new Error('下载失败')\n\t\t\t}\n\t\t\t// 安全获取响应头（兼容大小写）\n\t\t\tconst contentDisposition = res.headers.get('content-disposition') ||\n\t\t\t\tres.headers.get('Content-Disposition') || ''\n\t\t\tconst filename = extractFilename(contentDisposition)\n\t\t\treturn res.arrayBuffer().then(ab => ({\n\t\t\t\tab,\n\t\t\t\tfilename\n\t\t\t}))\n\t\t})\n\t// #endif\n\n\t// #ifndef H5\n\treturn new Promise((resolve, reject) => {\n\t\tconst token = uni.getStorageSync('token')\n\t\tconst header = {}\n\t\tif (token) header.Authorization = `Bearer ${token}`\n\t\tuni.request({\n\t\t\turl: BASE_URL + url,\n\t\t\tmethod: 'GET',\n\t\t\theader,\n\t\t\tresponseType: 'arraybuffer',\n\t\t\tsuccess: (res) => {\n\t\t\t\tif (res.statusCode === 200 && res.data instanceof ArrayBuffer) {\n\t\t\t\t\t// 安全获取响应头（兼容大小写）\n\t\t\t\t\tconst contentDisposition = res.header?.['Content-Disposition'] ||\n\t\t\t\t\t\tres.header?.['content-disposition'] || ''\n\t\t\t\t\tconst filename = extractFilename(contentDisposition)\n\t\t\t\t\tresolve({\n\t\t\t\t\t\tab: res.data,\n\t\t\t\t\t\tfilename\n\t\t\t\t\t})\n\t\t\t\t} else if (res.statusCode === 404) {\n\t\t\t\t\treject(new Error('请先点击生成竣工验收报告'))\n\t\t\t\t} else {\n\t\t\t\t\treject(new Error('下载失败'))\n\t\t\t\t}\n\t\t\t},\n\t\t\tfail: (e) => reject(new Error(e.errMsg || '网络错误'))\n\t\t})\n\t})\n\t// #endif\n}"],"names":["request","uni","BASE_URL"],"mappings":"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"}