{"version":3,"file":"acceptance.js","sources":["api/acceptance.js"],"sourcesContent":["/**\r\n * api/acceptance.js\r\n * 验收报告页面，各个方法总结\r\n * author:zyg\r\n * date:2025.12.1\r\n */\r\n\r\nimport {\r\n\tBASE_URL\r\n} from '@/utils/config.js'\r\nimport {\r\n\trequest\r\n} from '@/utils/request.js'\r\n\r\n/**\r\n * 执行任务（提取项目信息）- 异步版本\r\n * @param {Object} options - 选项\r\n * @param {number} options.projectId - 项目ID（必填）\r\n * @param {string} options.projectFolder - 项目文件夹名（必填）\r\n * @param {Function} options.onProgress - 进度回调函数 (progress, status) => void\r\n * @param {number} options.pollInterval - 轮询间隔（毫秒，默认3秒）\r\n * @param {number} options.timeout - 超时时间（毫秒，默认30分钟）\r\n * @returns {Promise<Object>} 任务执行结果\r\n */\r\nexport async function runTask(options = {}) {\r\n\tconst {\r\n\t\tprojectId = null,\r\n\t\t\tprojectFolder = null,\r\n\t\t\tonProgress = null,\r\n\t\t\tpollInterval = 3000, // 默认3秒轮询一次\r\n\t\t\ttimeout = 1800000 // 默认30分钟\r\n\t} = options\r\n\r\n\ttry {\r\n\t\t// 第一步：提交异步任务\r\n\t\t// console.log('📤 提交信息提取任务...')\r\n\t\tconst submitResult = await request.post('/api/v1/completion/extract-info/async/start', {\r\n\t\t\tproject_id: projectId,\r\n\t\t\tproject_folder: projectFolder,\r\n\t\t\tproject_data: {}\r\n\t\t}, {\r\n\t\t\thideLoading: true // 已经有了自定义提示窗)\r\n\t\t})\r\n\t\tconst taskId = submitResult.task_id\r\n\t\t// console.log(`✅ 任务已提交，Task ID: ${taskId}`)\r\n\r\n\t\t// 第二步：轮询任务状态\r\n\t\tconst startTime = Date.now()\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst pollStatus = async () => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// 检查是否超时\r\n\t\t\t\t\tif (Date.now() - startTime > timeout) {\r\n\t\t\t\t\t\treject(new Error('任务超时，请稍后重试'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 查询任务状态\r\n\t\t\t\t\tconst statusResult = await request.get(`/api/v1/tasks/${taskId}/status`, {\r\n\t\t\t\t\t\thideLoading: true // 已有自定义进度提示窗\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\tconst {\r\n\t\t\t\t\t\tstatus,\r\n\t\t\t\t\t\tprogress = 0,\r\n\t\t\t\t\t\tcurrent_step = '',\r\n\t\t\t\t\t\ttask_result,\r\n\t\t\t\t\t\terror_message\r\n\t\t\t\t\t} = statusResult\r\n\r\n\t\t\t\t\tconsole.log(`[${status}] ${progress}% - ${current_step}`)\r\n\r\n\t\t\t\t\t// 调用进度回调\r\n\t\t\t\t\tif (onProgress && typeof onProgress === 'function') {\r\n\t\t\t\t\t\tonProgress(progress, current_step, status)\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务完成\r\n\t\t\t\t\tif (status === 'success') {\r\n\t\t\t\t\t\t// console.log('✅ 任务完成！')\r\n\r\n\t\t\t\t\t\t// 数据校验\r\n\t\t\t\t\t\tconst data = task_result?.result || task_result\r\n\t\t\t\t\t\tif (!data || typeof data !== 'object' || Object.keys(data).length === 0) {\r\n\t\t\t\t\t\t\treject(new Error('未提取到任何项目信息，请检查文件内容是否完整'))\r\n\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tresolve({\r\n\t\t\t\t\t\t\tstatus: 'success',\r\n\t\t\t\t\t\t\tresult: data\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务失败\r\n\t\t\t\t\tif (status === 'failed') {\r\n\t\t\t\t\t\tconsole.error('❌ 任务失败:', error_message)\r\n\t\t\t\t\t\treject(new Error(error_message || '任务执行失败'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务取消\r\n\t\t\t\t\tif (status === 'cancelled') {\r\n\t\t\t\t\t\treject(new Error('任务已被取消'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 继续轮询\r\n\t\t\t\t\tsetTimeout(pollStatus, pollInterval)\r\n\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tconsole.error('查询任务状态失败:', error)\r\n\t\t\t\t\treject(error)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// 开始轮询\r\n\t\t\tpollStatus()\r\n\t\t})\r\n\r\n\t} catch (error) {\r\n\t\t// 错误分类处理\r\n\t\tif (error.code === 'NETWORK_ERROR' && error.message.includes('timeout')) {\r\n\t\t\tthrow new Error('提取超时：文档过大或网络不稳定，请稍后重试')\r\n\t\t} else if (error.code === 'HTTP_ERROR' && error.message.includes('404')) {\r\n\t\t\tthrow new Error('任务不存在，请联系管理员配置')\r\n\t\t} else {\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * 取消正在运行的任务\r\n * @param {string} taskId - 任务ID\r\n * @returns {Promise<Object>} 取消结果\r\n */\r\nexport async function cancelTask(taskId) {\r\n\tif (!taskId) {\r\n\t\tthrow new Error('任务ID不能为空')\r\n\t}\r\n\r\n\ttry {\r\n\t\tconst result = await request.post(`/api/v1/tasks/${taskId}/cancel`)\r\n\t\treturn result\r\n\t} catch (error) {\r\n\t\tthrow new Error(error.message || '取消任务失败')\r\n\t}\r\n}\r\n\r\n/**\r\n * 获取我的任务列表\r\n * @param {Object} options - 选项\r\n * @param {string} options.status - 状态过滤（pending/running/success/failed）\r\n * @param {string} options.taskType - 任务类型过滤\r\n * @param {number} options.limit - 返回数量\r\n * @returns {Promise<Object>} 任务列表\r\n */\r\nexport async function getMyTasks(options = {}) {\r\n\tconst {\r\n\t\tstatus = null,\r\n\t\t\ttaskType = null,\r\n\t\t\tlimit = 20\r\n\t} = options\r\n\r\n\ttry {\r\n\t\tconst params = new URLSearchParams()\r\n\t\tif (status) params.append('status', status)\r\n\t\tif (taskType) params.append('task_type', taskType)\r\n\t\tparams.append('limit', limit)\r\n\r\n\t\tconst result = await request.get(`/api/v1/tasks/my-tasks?${params.toString()}`)\r\n\t\treturn result\r\n\t} catch (error) {\r\n\t\tthrow new Error(error.message || '获取任务列表失败')\r\n\t}\r\n}\r\n\r\n/**\r\n * 转换后端提取结果为 baseTable 格式（支持嵌套对象）\r\n * @param {Object} result - 后端返回的 result 对象\r\n * @returns {Array} baseTable 格式的数组\r\n */\r\nexport function transformExtractResult(result) {\r\n\t// 完整的字段映射表：后端中文 key -> 英文 id + 显示标签\r\n\tconst FIELD_MAP = {\r\n\t\t// 基本信息\r\n\t\t'建设项目名称': {\r\n\t\t\tid: 'project_name',\r\n\t\t\tlabel: '建设项目名称'\r\n\t\t},\r\n\t\t'建设单位名称': {\r\n\t\t\tid: 'company_name',\r\n\t\t\tlabel: '建设单位名称'\r\n\t\t},\r\n\t\t'建设地点': {\r\n\t\t\tid: 'project_address',\r\n\t\t\tlabel: '建设地点'\r\n\t\t},\r\n\t\t'建设项目性质': {\r\n\t\t\tid: 'project_type',\r\n\t\t\tlabel: '建设项目性质'\r\n\t\t},\r\n\t\t'产品及产能': {\r\n\t\t\tid: 'product_scale',\r\n\t\t\tlabel: '产品及产能'\r\n\t\t},\r\n\r\n\t\t// 审批信息\r\n\t\t'环评报告表审批部门': {\r\n\t\t\tid: 'assessment_department',\r\n\t\t\tlabel: '环评报告表审批部门'\r\n\t\t},\r\n\t\t'环评报告表编制单位': {\r\n\t\t\tid: 'assessment_unit',\r\n\t\t\tlabel: '环评报告表编制单位'\r\n\t\t},\r\n\r\n\t\t// 投资信息\r\n\t\t'投资总概算(万元)': {\r\n\t\t\tid: 'investment',\r\n\t\t\tlabel: '投资总概算(万元)'\r\n\t\t},\r\n\t\t'环保投资总概算(万元)': {\r\n\t\t\tid: 'env_investment',\r\n\t\t\tlabel: '环保投资总概算(万元)'\r\n\t\t},\r\n\t\t'比例': {\r\n\t\t\tid: 'env_investment_ratio',\r\n\t\t\tlabel: '环保投资占比'\r\n\t\t},\r\n\r\n\t\t// 建设内容\r\n\t\t'主要建设内容': {\r\n\t\t\tid: 'construction_content',\r\n\t\t\tlabel: '主要建设内容'\r\n\t\t},\r\n\t\t'改扩建项目变动情况': {\r\n\t\t\tid: 'project_changes',\r\n\t\t\tlabel: '改扩建项目变动情况'\r\n\t\t},\r\n\t\t// 建设内容\r\n\t\t'单位联系人': {\r\n\t\t\tid: 'contact_person',\r\n\t\t\tlabel: '单位联系人'\r\n\t\t},\r\n\t\t'联系方式': {\r\n\t\t\tid: 'contact_phone',\r\n\t\t\tlabel: '联系方式'\r\n\t\t},\r\n\t\t'注册地址': {\r\n\t\t\tid: 'registered_address',\r\n\t\t\tlabel: '建设单位注册地址'\r\n\t\t},\r\n\r\n\t\t// 污染物\r\n\t\t'固体废物产生情况': {\r\n\t\t\tid: 'solid_generation',\r\n\t\t\tlabel: '固体废物产生情况'\r\n\t\t},\r\n\t\t'污染物产排情况': {\r\n\t\t\tid: 'pollutants_emission',\r\n\t\t\tlabel: '污染物产排情况',\r\n\t\t\ttype: 'table' // 添加类型标识\r\n\t\t},\r\n\r\n\t}\r\n\r\n\tconst baseTable = []\r\n\r\n\t// 遍历 result 对象\r\n\tObject.entries(result).forEach(([chineseKey, value]) => {\r\n\t\t// 如果有映射，按映射显示\r\n\t\tif (FIELD_MAP[chineseKey]) {\r\n\t\t\tconst fieldConfig = FIELD_MAP[chineseKey]\r\n\r\n\t\t\t// ✅ 特殊处理表格类型数据\r\n\t\t\tif (fieldConfig.type === 'table') {\r\n\t\t\t\tbaseTable.push({\r\n\t\t\t\t\tid: fieldConfig.id,\r\n\t\t\t\t\tlabel: fieldConfig.label,\r\n\t\t\t\t\tvalue: value, // 保留原始对象，不进行格式化\r\n\t\t\t\t\tsource: 'extracted',\r\n\t\t\t\t\ttype: 'table' // 前端通过这个类型来识别需要渲染表格\r\n\t\t\t\t})\r\n\t\t\t} else {\r\n\t\t\t\t// 普通字段正常处理\r\n\t\t\t\tbaseTable.push({\r\n\t\t\t\t\tid: fieldConfig.id,\r\n\t\t\t\t\tlabel: fieldConfig.label,\r\n\t\t\t\t\tvalue: formatValue(value),\r\n\t\t\t\t\tsource: 'extracted'\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t\t// 如果是嵌套对象（但不是表格类型），展开显示\r\n\t\telse if (typeof value === 'object' && value !== null) {\r\n\t\t\tObject.entries(value).forEach(([subKey, subValue]) => {\r\n\t\t\t\tbaseTable.push({\r\n\t\t\t\t\tid: `${chineseKey}_${subKey}`,\r\n\t\t\t\t\tlabel: `${chineseKey} - ${subKey}`,\r\n\t\t\t\t\tvalue: formatValue(subValue),\r\n\t\t\t\t\tsource: 'extracted'\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t}\r\n\t\t// 如果没有映射，直接显示\r\n\t\telse {\r\n\t\t\tbaseTable.push({\r\n\t\t\t\tid: chineseKey,\r\n\t\t\t\tlabel: chineseKey,\r\n\t\t\t\tvalue: formatValue(value),\r\n\t\t\t\tsource: 'extracted'\r\n\t\t\t})\r\n\t\t}\r\n\t})\r\n\r\n\t// 按id顺序排序\r\n\tconst ORDER = [\r\n\t\t'project_name', // 建设项目名称\r\n\t\t'company_name', // 建设单位名称\r\n\t\t'project_address', // 建设地点\r\n\t\t'project_type', // 建设项目性质\r\n\t\t'product_scale', // 产品及产能\r\n\t\t'assessment_department', // 环评报告表审批部门\r\n\t\t'assessment_unit', // 环评报告表编制单位\r\n\t\t'investment', // 投资总概算(万元)\r\n\t\t'env_investment', // 环保投资总概算(万元)\r\n\t\t'env_investment_ratio', // 比例\r\n\t\t'construction_content', // 主要建设内容\r\n\t\t'project_changes', // 改扩建项目变动情况\r\n\t\t'registered_address', // 注册地址\r\n\t\t'contact_person', // 联系人\r\n\t\t'contact_phone', // 联系方式\r\n\t\t'solid_generation', // 固体废物产生情况\r\n\t\t'pollutants_emission', // 污染物产排情况\r\n\t];\r\n\treturn baseTable.sort((a, b) => {\r\n\t\tconst aIndex = ORDER.indexOf(a.id)\r\n\t\tconst bIndex = ORDER.indexOf(b.id)\r\n\t\tif (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex\r\n\t\tif (aIndex !== -1) return -1\r\n\t\tif (bIndex !== -1) return 1\r\n\t\treturn 0\r\n\t})\r\n}\r\n\r\n// 格式化值的辅助函数（处理数组、对象等）\r\nfunction formatValue(value) {\r\n\t// 如果是数组，转成字符串\r\n\tif (Array.isArray(value)) {\r\n\t\treturn value.length > 0 ? JSON.stringify(value, null, 2) : '未提取到相关信息'\r\n\t}\r\n\t// 如果是对象，转成字符串\r\n\tif (typeof value === 'object' && value !== null) {\r\n\t\treturn JSON.stringify(value, null, 2)\r\n\t}\r\n\t// 如果是数字，直接返回\r\n\tif (typeof value === 'number') {\r\n\t\treturn value\r\n\t}\r\n\t// 如果是字符串，去掉首尾空格\r\n\tif (typeof value === 'string') {\r\n\t\treturn value.trim() || '未提取到相关信息'\r\n\t}\r\n\t// 其他情况\r\n\treturn value || '未提取到相关信息'\r\n}\r\n\r\n/**\r\n * 标识牌下载\r\n * 纯前端数据 → 后端生成 Word\r\n * @param {Object} signboard - 标识牌数据\r\n * @param {number} projectId - 项目ID（必填）\r\n * @returns {Promise<ArrayBuffer>}\r\n */\r\nexport function downloadSignboardWord(signboard, projectId) {\r\n\tif (!projectId) {\r\n\t\tthrow new Error('项目ID不能为空')\r\n\t}\r\n\r\n\tconst payload = {\r\n\t\tproject_id: projectId, // 添加项目ID\r\n\t\tsections: signboard.sections.map(sec => ({\r\n\t\t\tblock: sec.block,\r\n\t\t\titems: sec.items.map(it => ({\r\n\t\t\t\ttitle: it.title,\r\n\t\t\t\tcontent: it.content\r\n\t\t\t}))\r\n\t\t}))\r\n\t};\r\n\r\n\t// #ifdef H5\r\n\t// H5 环境：uni.request 的 arraybuffer 不稳定，使用原生 fetch\r\n\tconst token = uni.getStorageSync('token')\r\n\tconst headers = {\r\n\t\t'Content-Type': 'application/json'\r\n\t}\r\n\tif (token) {\r\n\t\theaders['Authorization'] = `Bearer ${token}`\r\n\t}\r\n\r\n\treturn fetch(BASE_URL + '/api/v1/completion/signboard/download', {\r\n\t\tmethod: 'POST',\r\n\t\theaders: headers,\r\n\t\tbody: JSON.stringify(payload)\r\n\t}).then(res => {\r\n\t\tif (!res.ok) {\r\n\t\t\t// 处理不同的错误状态\r\n\t\t\tif (res.status === 403) {\r\n\t\t\t\tthrow new Error('您不是该项目的成员，无权下载标识牌')\r\n\t\t\t} else if (res.status === 404) {\r\n\t\t\t\tthrow new Error('项目提取结果文件不存在，请先提取项目信息')\r\n\t\t\t} else {\r\n\t\t\t\tthrow new Error('生成失败')\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn res.arrayBuffer()\r\n\t})\r\n\t// #endif\r\n\r\n\t// #ifndef H5\r\n\t// 小程序/App 环境：直接使用 uni.request（因为 responseType 需要特殊处理）\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tconst token = uni.getStorageSync('token')\r\n\t\tconst header = {\r\n\t\t\t'Content-Type': 'application/json'\r\n\t\t}\r\n\t\tif (token) {\r\n\t\t\theader['Authorization'] = `Bearer ${token}`\r\n\t\t}\r\n\r\n\t\tuni.request({\r\n\t\t\turl: BASE_URL + '/api/v1/completion/signboard/download',\r\n\t\t\tmethod: 'POST',\r\n\t\t\tdata: payload,\r\n\t\t\theader: header,\r\n\t\t\tresponseType: 'arraybuffer',\r\n\t\t\tsuccess: (res) => {\r\n\t\t\t\tconsole.log('标识牌下载响应:', res)\r\n\t\t\t\tif (res.statusCode === 200 && res.data) {\r\n\t\t\t\t\t// 检查是否是 ArrayBuffer\r\n\t\t\t\t\tif (res.data instanceof ArrayBuffer && res.data.byteLength > 0) {\r\n\t\t\t\t\t\tresolve(res.data)\r\n\t\t\t\t\t} else if (typeof res.data === 'string' && res.data.length > 0) {\r\n\t\t\t\t\t\t// 如果返回的是字符串，说明小程序没有正确处理 arraybuffer\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: '文件格式错误',\r\n\t\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\treject(new Error('文件格式错误'))\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(new Error('空文件'))\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\treject(new Error('生成失败'))\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tfail: (error) => {\r\n\t\t\t\treject(new Error(error.errMsg || '网络请求失败'))\r\n\t\t\t}\r\n\t\t})\r\n\t})\r\n\t// #endif\r\n}\r\n\r\n/**\r\n * 生成监测方案（异步任务）\r\n * @param {Object} options - 选项\r\n * @param {number} options.projectId - 项目ID（必填）\r\n * @param {Function} options.onProgress - 进度回调函数 (progress, status) => void\r\n * @param {number} options.pollInterval - 轮询间隔（毫秒，默认3秒）\r\n * @param {number} options.timeout - 超时时间（毫秒，默认30分钟）\r\n * @returns {Promise<Object>} 任务执行结果\r\n */\r\nexport async function generateMonitorPlan(options = {}) {\r\n\tconst {\r\n\t\tprojectId = null,\r\n\t\t\tonProgress = null,\r\n\t\t\tpollInterval = 3000,\r\n\t\t\ttimeout = 1800000 // 默认30分钟\r\n\t} = options\r\n\r\n\tif (!projectId) {\r\n\t\tthrow new Error('项目ID不能为空')\r\n\t}\r\n\r\n\ttry {\r\n\t\t// 第一步：提交异步任务\r\n\t\tconst submitResult = await request.post('/api/v1/completion/monitor-plan/async/start', {\r\n\t\t\tproject_id: projectId\r\n\t\t})\r\n\r\n\t\tconst taskId = submitResult.task_id\r\n\t\t// console.log(`✅ 监测方案任务已提交，Task ID: ${taskId}`)\r\n\r\n\t\t// 第二步：轮询任务状态\r\n\t\tconst startTime = Date.now()\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst pollStatus = async () => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// 检查是否超时\r\n\t\t\t\t\tif (Date.now() - startTime > timeout) {\r\n\t\t\t\t\t\treject(new Error('任务超时，请稍后重试'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 查询任务状态\r\n\t\t\t\t\tconst statusResult = await request.get(`/api/v1/tasks/${taskId}/status`)\r\n\r\n\t\t\t\t\tconst {\r\n\t\t\t\t\t\tstatus,\r\n\t\t\t\t\t\tprogress = 0,\r\n\t\t\t\t\t\tcurrent_step = '',\r\n\t\t\t\t\t\ttask_result,\r\n\t\t\t\t\t\terror_message\r\n\t\t\t\t\t} = statusResult\r\n\r\n\t\t\t\t\tconsole.log(`[${status}] ${progress}% - ${current_step}`)\r\n\r\n\t\t\t\t\t// 调用进度回调\r\n\t\t\t\t\tif (onProgress && typeof onProgress === 'function') {\r\n\t\t\t\t\t\tonProgress(progress, current_step, status)\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务完成\r\n\t\t\t\t\tif (status === 'success') {\r\n\t\t\t\t\t\tconsole.log('✅ 监测方案生成完成！')\r\n\t\t\t\t\t\tresolve({\r\n\t\t\t\t\t\t\tstatus: 'success',\r\n\t\t\t\t\t\t\tresult: task_result,\r\n\t\t\t\t\t\t\tproject_id: projectId\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务失败\r\n\t\t\t\t\tif (status === 'failed') {\r\n\t\t\t\t\t\tconsole.error('❌ 任务失败:', error_message)\r\n\t\t\t\t\t\treject(new Error(error_message || '监测方案生成失败'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务取消\r\n\t\t\t\t\tif (status === 'cancelled') {\r\n\t\t\t\t\t\treject(new Error('任务已被取消'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 继续轮询\r\n\t\t\t\t\tsetTimeout(pollStatus, pollInterval)\r\n\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tconsole.error('查询任务状态失败:', error)\r\n\t\t\t\t\treject(error)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// 开始轮询\r\n\t\t\tpollStatus()\r\n\t\t})\r\n\r\n\t} catch (error) {\r\n\t\tif (error.message && error.message.includes('已有一个监测方案生成任务正在运行')) {\r\n\t\t\tthrow new Error('您已有一个监测方案生成任务正在运行，请等待完成')\r\n\t\t}\r\n\t\tthrow error\r\n\t}\r\n}\r\n\r\n/**\r\n * 下载监测方案（不指定格式，完全信任后端返回的文件名）\r\n * @param {number} projectId - 项目ID\r\n * @returns {Promise<{ab:ArrayBuffer,filename:string}>} 文件流+真实文件名\r\n */\r\nexport function downloadMonitorPlan(projectId) {\r\n\tif (!projectId) throw new Error('项目ID不能为空')\r\n\r\n\tconst url = `/api/v1/completion/monitor-plan/${projectId}/download`\r\n\r\n\t// #ifdef H5\r\n\tconst token = uni.getStorageSync('token')\r\n\tconst headers = {}\r\n\tif (token) headers.Authorization = `Bearer ${token}`\r\n\treturn fetch(BASE_URL + url, {\r\n\t\t\tmethod: 'GET',\r\n\t\t\theaders\r\n\t\t})\r\n\t\t.then(res => {\r\n\t\t\tif (!res.ok) {\r\n\t\t\t\tif (res.status === 403) throw new Error('无权下载')\r\n\t\t\t\tif (res.status === 404) throw new Error('请先点击生成监测方案')\r\n\t\t\t\tthrow new Error('下载失败')\r\n\t\t\t}\r\n\t\t\t// 安全获取响应头（兼容大小写）\r\n\t\t\tconst contentDisposition = res.headers.get('content-disposition') ||\r\n\t\t\t\tres.headers.get('Content-Disposition') || ''\r\n\t\t\tconst filename = extractFilename(contentDisposition)\r\n\t\t\treturn res.arrayBuffer().then(ab => ({\r\n\t\t\t\tab,\r\n\t\t\t\tfilename\r\n\t\t\t}))\r\n\t\t})\r\n\t// #endif\r\n\r\n\t// #ifndef H5\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tconst token = uni.getStorageSync('token')\r\n\t\tconst header = {}\r\n\t\tif (token) header.Authorization = `Bearer ${token}`\r\n\t\tuni.request({\r\n\t\t\turl: BASE_URL + url,\r\n\t\t\tmethod: 'GET',\r\n\t\t\theader,\r\n\t\t\tresponseType: 'arraybuffer',\r\n\t\t\tsuccess: (res) => {\r\n\t\t\t\tif (res.statusCode === 200 && res.data instanceof ArrayBuffer) {\r\n\t\t\t\t\t// 安全获取响应头（兼容大小写）\r\n\t\t\t\t\tconst contentDisposition = res.header?.['Content-Disposition'] ||\r\n\t\t\t\t\t\tres.header?.['content-disposition'] || ''\r\n\t\t\t\t\tconst filename = extractFilename(contentDisposition)\r\n\t\t\t\t\tresolve({\r\n\t\t\t\t\t\tab: res.data,\r\n\t\t\t\t\t\tfilename\r\n\t\t\t\t\t})\r\n\t\t\t\t} else if (res.statusCode === 404) {\r\n\t\t\t\t\treject(new Error('请先点击生成监测方案'))\r\n\t\t\t\t} else {\r\n\t\t\t\t\treject(new Error('下载失败'))\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tfail: (e) => reject(new Error(e.errMsg || '网络错误'))\r\n\t\t})\r\n\t})\r\n\t// #endif\r\n}\r\n\r\n/* 从 Content-Disposition 头里抠文件名 */\r\nfunction extractFilename(str) {\r\n\t// 确保 str 是字符串，防止 null 或 undefined 导致错误\r\n\tif (!str || typeof str !== 'string') {\r\n\t\treturn 'AI生成报告.docx'\r\n\t}\r\n\r\n\t// 优先匹配 RFC 5987 编码格式：filename*=UTF-8''encoded_name\r\n\tconst rfc5987Match = str.match(/filename\\*=UTF-8''([^;\\n]+)/i)\r\n\tif (rfc5987Match && rfc5987Match[1]) {\r\n\t\ttry {\r\n\t\t\treturn decodeURIComponent(rfc5987Match[1])\r\n\t\t} catch {\r\n\t\t\t// 解码失败，继续尝试普通格式\r\n\t\t}\r\n\t}\r\n\r\n\t// 降级到普通格式：filename=\"name\" 或 filename=name\r\n\tconst normalMatch = str.match(/filename=[\"']?([^;\"'\\n]+)[\"']?/i)\r\n\tif (normalMatch && normalMatch[1]) {\r\n\t\tconst name = normalMatch[1].trim()\r\n\t\ttry {\r\n\t\t\treturn decodeURIComponent(name)\r\n\t\t} catch {\r\n\t\t\treturn name\r\n\t\t}\r\n\t}\r\n\r\n\treturn 'AI生成报告.docx'\r\n}\r\n\r\n\r\n\r\n/**\r\n * 生成竣工验收报告\r\n * @param {Object} options - 选项\r\n * @param {number} options.projectId - 项目ID（必填）\r\n * @param {Function} options.onProgress - 进度回调函数 (progress, status) => void\r\n * @param {number} options.pollInterval - 轮询间隔（毫秒，默认3秒）\r\n * @param {number} options.timeout - 超时时间（毫秒，默认30分钟）\r\n * @returns {Promise<Object>} 任务执行结果\r\n */\r\nexport async function generateReport(options = {}) {\r\n\tconst {\r\n\t\tprojectId = null,\r\n\t\t\tonProgress = null,\r\n\t\t\tpollInterval = 3000,\r\n\t\t\ttimeout = 1800000 // 默认30分钟\r\n\t} = options\r\n\r\n\tif (!projectId) {\r\n\t\tthrow new Error('项目ID不能为空')\r\n\t}\r\n\r\n\ttry {\r\n\t\t// 第一步：提交异步任务\r\n\t\t const submitResult = await request.post(\r\n\t\t   `/api/v1/completion/char/batch/merge/async?project_id=${projectId}`,\r\n\t\t   {} // body 为空\r\n\t\t )\r\n\r\n\t\tconst taskId = submitResult.task_id\r\n\t\t// console.log(`竣工验收报告生成任务已提交，Task ID: ${taskId}`)\r\n\r\n\t\t// 第二步：轮询任务状态\r\n\t\tconst startTime = Date.now()\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst pollStatus = async () => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// 检查是否超时\r\n\t\t\t\t\tif (Date.now() - startTime > timeout) {\r\n\t\t\t\t\t\treject(new Error('任务超时，请稍后重试'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 查询任务状态\r\n\t\t\t\t\tconst statusResult = await request.get(`/api/v1/tasks/${taskId}/status`)\r\n\r\n\t\t\t\t\tconst {\r\n\t\t\t\t\t\tstatus,\r\n\t\t\t\t\t\tprogress = 0,\r\n\t\t\t\t\t\tcurrent_step = '',\r\n\t\t\t\t\t\ttask_result,\r\n\t\t\t\t\t\terror_message\r\n\t\t\t\t\t} = statusResult\r\n\r\n\t\t\t\t\t// console.log(`[${status}] ${progress}% - ${current_step}`)\r\n\r\n\t\t\t\t\t// 调用进度回调\r\n\t\t\t\t\tif (onProgress && typeof onProgress === 'function') {\r\n\t\t\t\t\t\tonProgress(progress, current_step, status)\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务完成\r\n\t\t\t\t\tif (status === 'success') {\r\n\t\t\t\t\t\tconsole.log('✅ 竣工验收报告已生成！')\r\n\t\t\t\t\t\tresolve({\r\n\t\t\t\t\t\t\tstatus: 'success',\r\n\t\t\t\t\t\t\tresult: task_result,\r\n\t\t\t\t\t\t\tproject_id: projectId\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务失败\r\n\t\t\t\t\tif (status === 'failed') {\r\n\t\t\t\t\t\tconsole.error('❌ 任务失败:', error_message)\r\n\t\t\t\t\t\treject(new Error(error_message || '竣工验收报告生成失败'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 任务取消\r\n\t\t\t\t\tif (status === 'cancelled') {\r\n\t\t\t\t\t\treject(new Error('任务已被取消'))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 继续轮询\r\n\t\t\t\t\tsetTimeout(pollStatus, pollInterval)\r\n\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tconsole.error('查询任务状态失败:', error)\r\n\t\t\t\t\treject(error)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// 开始轮询\r\n\t\t\tpollStatus()\r\n\t\t})\r\n\r\n\t} catch (error) {\r\n\t\tif (error.message && error.message.includes('已有一个竣工验收报告生成任务正在运行')) {\r\n\t\t\tthrow new Error('您已有一个竣工验收报告生成任务正在运行，请等待完成')\r\n\t\t}\r\n\t\tthrow error\r\n\t}\r\n}\r\n\r\n/**\r\n * 下载竣工验收报告\r\n * @param {number} projectId - 项目ID\r\n * @returns {Promise<{ab:ArrayBuffer,filename:string}>} 文件流+真实文件名\r\n */\r\nexport function downloadReport(projectId) {\r\n\tif (!projectId) throw new Error('项目ID不能为空')\r\n\r\n\tconst url = `/api/v1/completion/char/batch/merge/download?project_id=${projectId}`\r\n\t// #ifdef H5\r\n\tconst token = uni.getStorageSync('token')\r\n\tconst headers = {}\r\n\tif (token) headers.Authorization = `Bearer ${token}`\r\n\treturn fetch(BASE_URL + url, {\r\n\t\t\tmethod: 'GET',\r\n\t\t\theaders\r\n\t\t})\r\n\t\t.then(res => {\r\n\t\t\tif (!res.ok) {\r\n\t\t\t\tif (res.status === 403) throw new Error('无权下载')\r\n\t\t\t\tif (res.status === 404) throw new Error('请先点击生成竣工验收报告')\r\n\t\t\t\tthrow new Error('下载失败')\r\n\t\t\t}\r\n\t\t\t// 安全获取响应头（兼容大小写）\r\n\t\t\tconst contentDisposition = res.headers.get('content-disposition') ||\r\n\t\t\t\tres.headers.get('Content-Disposition') || ''\r\n\t\t\tconst filename = extractFilename(contentDisposition)\r\n\t\t\treturn res.arrayBuffer().then(ab => ({\r\n\t\t\t\tab,\r\n\t\t\t\tfilename\r\n\t\t\t}))\r\n\t\t})\r\n\t// #endif\r\n\r\n\t// #ifndef H5\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tconst token = uni.getStorageSync('token')\r\n\t\tconst header = {}\r\n\t\tif (token) header.Authorization = `Bearer ${token}`\r\n\t\tuni.request({\r\n\t\t\turl: BASE_URL + url,\r\n\t\t\tmethod: 'GET',\r\n\t\t\theader,\r\n\t\t\tresponseType: 'arraybuffer',\r\n\t\t\tsuccess: (res) => {\r\n\t\t\t\tif (res.statusCode === 200 && res.data instanceof ArrayBuffer) {\r\n\t\t\t\t\t// 安全获取响应头（兼容大小写）\r\n\t\t\t\t\tconst contentDisposition = res.header?.['Content-Disposition'] ||\r\n\t\t\t\t\t\tres.header?.['content-disposition'] || ''\r\n\t\t\t\t\tconst filename = extractFilename(contentDisposition)\r\n\t\t\t\t\tresolve({\r\n\t\t\t\t\t\tab: res.data,\r\n\t\t\t\t\t\tfilename\r\n\t\t\t\t\t})\r\n\t\t\t\t} else if (res.statusCode === 404) {\r\n\t\t\t\t\treject(new Error('请先点击生成竣工验收报告'))\r\n\t\t\t\t} else {\r\n\t\t\t\t\treject(new Error('下载失败'))\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tfail: (e) => reject(new Error(e.errMsg || '网络错误'))\r\n\t\t})\r\n\t})\r\n\t// #endif\r\n}"],"names":["request","uni","BASE_URL"],"mappings":"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"}