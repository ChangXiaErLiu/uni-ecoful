{"version":3,"file":"acceptance.js","sources":["api/acceptance.js"],"sourcesContent":["/**\r\n * api/acceptance.js\r\n * 验收报告页面，各个方法总结\r\n */\r\n\r\nimport {\r\n\tBASE_URL\r\n} from '@/utils/config.js'\r\nimport {\r\n\trequest\r\n} from '@/utils/request.js'\r\n\r\n//---------- 文件上传、文件处理方法----------------//\r\n/**\r\n * 上传单个文件到后端\r\n * @param {Object} file - uni-file-picker返回的文件对象\r\n * @returns {Promise} 上传结果\r\n */\r\nexport async function uploadFileToBackend(file) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\t// 获取文件路径\r\n\t\tconst filePath = file.url || file.path || file.tempFilePath\r\n\t\tconst fileName = file.name || '环评报告.pdf'\r\n\r\n\t\tif (!filePath) {\r\n\t\t\treject(new Error('文件路径无效'))\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\tuni.uploadFile({\r\n\t\t\turl: BASE_URL + '/api/v1/documents/upload',\r\n\t\t\tfilePath: filePath,\r\n\t\t\tname: 'file',\r\n\t\t\tformData: {\r\n\t\t\t\tcategory: 'eia_report' // 标记为环评报告\r\n\t\t\t},\r\n\t\t\tsuccess: (res) => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst data = JSON.parse(res.data)\r\n\t\t\t\t\tif (res.statusCode === 200) {\r\n\t\t\t\t\t\tresolve({\r\n\t\t\t\t\t\t\tsuccess: true,\r\n\t\t\t\t\t\t\tdocument_id: data.document_id,\r\n\t\t\t\t\t\t\tfilename: data.filename,\r\n\t\t\t\t\t\t\tsize_bytes: data.size_bytes,\r\n\t\t\t\t\t\t\tupload_time: data.upload_time\r\n\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(new Error(data.detail || '上传失败'))\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\treject(new Error('解析响应失败'))\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tfail: (error) => {\r\n\t\t\t\treject(new Error('网络请求失败'))\r\n\t\t\t}\r\n\t\t})\r\n\t})\r\n}\r\n\r\n/**\r\n * 批量上传文件\r\n * @param {Array} files - 文件数组\r\n * @returns {Promise} 上传结果数组\r\n */\r\nexport async function uploadMultipleFiles(files) {\r\n\tif (!files || files.length === 0) {\r\n\t\tthrow new Error('没有选择文件')\r\n\t}\r\n\r\n\tconst uploadPromises = files.map(file => uploadFileToBackend(file))\r\n\treturn await Promise.all(uploadPromises)\r\n}\r\n\r\n/**\r\n * 临时测试构建向量方案：硬编码 source_dir，后端需要优化\r\n * @param {Object} options - 选项\r\n * @param {boolean} options.hideLoading - 是否隐藏 loading（默认 false）\r\n */\r\nexport async function rebuildIndex(options = {}) {\r\n\tconst {\r\n\t\thideLoading = false\r\n\t} = options;\r\n\r\n\tconst TEST_SOURCE_DIR = './storage/project_completion_and_acceptance/uploads'\r\n\r\n\treturn request.post('/api/v1/index/build', {\r\n\t\tsource_dir: TEST_SOURCE_DIR,\r\n\t\tsplit_by_heading: true\r\n\t}, {\r\n\t\thideLoading,\r\n\t\ttimeout: 900000 // 增加：15分钟超时（900秒）\r\n\t});\r\n}\r\n\r\n/**\r\n * 执行任务（提取项目信息）\r\n * @param {string} taskName - 任务名称（如 'task1'）\r\n * @param {Object} options - 选项\r\n * @param {boolean} options.hideLoading - 是否隐藏 loading\r\n * @param {number} options.timeout - 超时时间（毫秒）\r\n * @returns {Promise<Object>} 任务执行结果\r\n */\r\nexport async function runTask(taskName, options = {}) {\r\n\tconst {\r\n\t\thideLoading = false,\r\n\t\t\ttimeout = 600000 // 默认10分钟\r\n\t} = options\r\n\r\n\ttry {\r\n\t\tconst result = await request.get(`/api/v1/tasks/${taskName}/run`, {\r\n\t\t\ttimeout,\r\n\t\t\thideLoading\r\n\t\t})\r\n\r\n\t\t// ✅ 数据校验\r\n\t\tif (!result || result.status !== 'success') {\r\n\t\t\tthrow new Error(result?.message || '任务执行失败')\r\n\t\t}\r\n\r\n\t\tif (!result.result || Object.keys(result.result).length === 0) {\r\n\t\t\tthrow new Error('未提取到任何项目信息，请检查文件内容是否完整')\r\n\t\t}\r\n\r\n\t\treturn result\r\n\t} catch (error) {\r\n\t\t// ✅ 错误分类处理\r\n\t\tif (error.code === 'NETWORK_ERROR' && error.message.includes('timeout')) {\r\n\t\t\tthrow new Error('提取超时：文档过大或网络不稳定，请稍后重试')\r\n\t\t} else if (error.code === 'HTTP_ERROR' && error.message.includes('404')) {\r\n\t\t\tthrow new Error(`任务 ${taskName} 不存在，请联系管理员配置`)\r\n\t\t} else {\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\n * 转换后端提取结果为 baseTable 格式（支持嵌套对象）\n * @param {Object} result - 后端返回的 result 对象\n * @returns {Array} baseTable 格式的数组\n */\nexport function transformExtractResult(result) {\n  // ✅ 完整的字段映射表：后端中文 key -> 英文 id + 显示标签\n  const FIELD_MAP = {\n    // 基本信息\n    '建设项目名称': { id: 'project_name', label: '项目名称' },\n    '建设单位名称': { id: 'company_name', label: '建设单位' },\n    '建设地点': { id: 'project_address', label: '项目地址' },\n    '建设项目性质': { id: 'project_type', label: '建设性质' },\n    \n    // 投资信息\n    '投资总概算(万元)': { id: 'investment', label: '投资总额(万元)' },\n    '环保投资总概算(万元)': { id: 'env_investment', label: '环保投资(万元)' },\n    '比例': { id: 'env_investment_ratio', label: '环保投资占比' },\n    \n    // 审批信息\n    '环评报告表审批部门': { id: 'assessment_department', label: '审批部门' },\n    '环评报告表编制单位': { id: 'assessment_unit', label: '编制单位' },\n    \n    // 建设内容\n    '主要建设内容': { id: 'construction_content', label: '建设内容' },\n    '产品及产能': { id: 'product_scale', label: '产品规模' },\n    \n    // 污染物\n    '生产工艺': { id: 'production_process', label: '生产工艺' },\n    '固体废物产生情况': { id: 'solid_waste', label: '固废情况' },\n    '噪声执行标准': { id: 'noise_standard', label: '噪声标准' }\n  }\n\n  const baseTable = []\n\n  // ✅ 遍历 result 对象\n  Object.entries(result).forEach(([chineseKey, value]) => {\n    // 如果有映射，按映射显示\n    if (FIELD_MAP[chineseKey]) {\n      baseTable.push({\n        id: FIELD_MAP[chineseKey].id,\n        label: FIELD_MAP[chineseKey].label,\n        value: formatValue(value),\n        source: 'extracted'\n      })\n    } \n    // 如果是嵌套对象（如\"污染物产排情况\"），展开显示\n    else if (typeof value === 'object' && value !== null) {\n      Object.entries(value).forEach(([subKey, subValue]) => {\n        baseTable.push({\n          id: `${chineseKey}_${subKey}`,\n          label: `${chineseKey} - ${subKey}`,\n          value: formatValue(subValue),\n          source: 'extracted'\n        })\n      })\n    }\n    // 如果没有映射，直接显示\n    else {\n      baseTable.push({\n        id: chineseKey,\n        label: chineseKey,\n        value: formatValue(value),\n        source: 'extracted'\n      })\n    }\n  })\n\n  // ✅ 按顺序排序（让重要信息在前面）\n  const ORDER = ['project_name', 'company_name', 'project_address', 'investment', 'env_investment']\n  return baseTable.sort((a, b) => {\n    const aIndex = ORDER.indexOf(a.id)\n    const bIndex = ORDER.indexOf(b.id)\n    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex\n    if (aIndex !== -1) return -1\n    if (bIndex !== -1) return 1\n    return 0\n  })\n}\n\n// 格式化值的辅助函数（处理数组、对象等）\nfunction formatValue(value) {\n  // 如果是数组，转成字符串\n  if (Array.isArray(value)) {\n    return value.length > 0 ? JSON.stringify(value, null, 2) : '-'\n  }\n  // 如果是对象，转成字符串\n  if (typeof value === 'object' && value !== null) {\n    return JSON.stringify(value, null, 2)\n  }\n  // 如果是数字，直接返回\n  if (typeof value === 'number') {\n    return value\n  }\n  // 如果是字符串，去掉首尾空格\n  if (typeof value === 'string') {\n    return value.trim() || '-'\n  }\n  // 其他情况\n  return value || ''\n}"],"names":["uni","BASE_URL","request"],"mappings":"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"}