{"version":3,"file":"project.js","sources":["api/project.js"],"sourcesContent":["/**\n * 项目管理接口方法\n * author:zyg\n * date:2025.12.1\n */\nimport {\n\trequest\n} from '@/utils/request.js'\nimport {\n\tBASE_URL\n} from '@/utils/config.js'\n/* ================== 1. 项目基础 ================== */\n/**\n * 创建项目\n * @param {Object} data\n * @param {string} data.name          项目名称（必填）\n * @param {string} data.description   项目背景（可选）\n * @param {string} data.notes         备注（可选）\n * @param {number[]} data.member_ids  项目成员用户 ID 数组（可选）\n * @returns {Promise}\n */\nexport function createProjects(data) {\n\treturn request.post('/api/v1/project/projects', data)\n}\n\n/**\n * 获取项目列表\n * @returns {Promise<Array>} 返回项目列表数组\n */\nexport function getProjects() {\n\treturn request.get('/api/v1/project/projects')\n}\n\n/**\n * 获取项目详情\n * @param {number} projectId 项目ID\n * @returns {Promise<Object>} 返回项目详情对象\n */\nexport function getProjectDetail(projectId) {\n\treturn request.get(`/api/v1/project/projects/${projectId}`)\n}\n\n/**\n * 更新项目\n * @param {number} projectId 项目ID\n * @param {Object} data 更新数据\n * @param {string} data.name          项目名称（可选）\n * @param {string} data.description   项目背景（可选）\n * @param {string} data.notes         备注（可选）\n * @param {number[]} data.member_ids  项目成员用户 ID 数组（可选，覆盖模式）\n * @returns {Promise<Object>} 返回更新后的项目信息\n */\nexport function updateProject(projectId, data) {\n\treturn request.patch(`/api/v1/project/projects/${projectId}`, data)\n}\n\n/**\n * 删除项目\n * @param {number} projectId 项目ID\n * @returns {Promise<Object>} 返回删除结果\n */\nexport function deleteProject(projectId) {\n\treturn request.delete(`/api/v1/project/projects/${projectId}`)\n}\n\n\n/* ================== 2. 成员管理 ================== */\n/**\n * 获取项目成员列表\n * @param {number} projectId 项目ID\n * @returns {Promise<Object>} 返回成员列表和总数\n */\nexport function getProjectMembers(projectId) {\n\treturn request.get(`/api/v1/project/projects/${projectId}/members`)\n}\n\n/**\n * 添加项目成员\n * @param {number} projectId 项目ID\n * @param {number} userId 用户ID\n * @returns {Promise<Object>} 返回添加结果\n */\nexport function addProjectMember(projectId, userId) {\n\treturn request.post(`/api/v1/project/projects/${projectId}/members`, {\n\t\tuser_id: userId\n\t})\n}\n\n/**\n * 移除项目成员\n * @param {number} projectId 项目ID\n * @param {number} userId 用户ID\n * @returns {Promise<Object>} 返回移除结果\n */\nexport function removeProjectMember(projectId, userId) {\n\treturn request.delete(`/api/v1/project/projects/${projectId}/members/${userId}`)\n}\n\n\n/* ================== 3. 文件管理 ================== */\n// 因为微信小程序和h5、图片、文件上传处理方法不一样，因此要区分\n// 参考地址:https://uniapp.dcloud.net.cn/api/media/file.html#choosefile\n\n/** 选择文件（H5、App、微信小程序通用）\n * 内部自动区分平台，返回统一格式 { path, name, size, type, file? }\n * 失败或取消返回 null\n */\nexport function pickProjectFile() {\n\tconst isMp = () => process.env.UNI_PLATFORM === 'mp-weixin'\n\tconst isH5 = () => process.env.UNI_PLATFORM === 'h5'\n\n\t/* 1. H5 使用原生 input 获取真正的 File 对象 */\n\tif (isH5()) {\n\t\treturn new Promise(resolve => {\n\t\t\tconst input = document.createElement('input')\n\t\t\tinput.type = 'file'\n\t\t\tinput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.md,.txt,.jpg,.jpeg,.png'\n\t\t\t\n\t\t\tinput.onchange = (e) => {\n\t\t\t\tconst file = e.target.files[0]\n\t\t\t\tif (!file) {\n\t\t\t\t\tresolve(null)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tconst max = 500 * 1024 * 1024\n\t\t\t\tif (file.size > max) {\n\t\t\t\t\tuni.showToast({ title: '文件不能超过 500 MB', icon: 'none' })\n\t\t\t\t\tresolve(null)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tresolve({\n\t\t\t\t\tpath: '',  // H5 不需要 path\n\t\t\t\t\tname: file.name,\n\t\t\t\t\tsize: file.size,\n\t\t\t\t\ttype: getFileExt(file.name),\n\t\t\t\t\tfile: file  // 原生 File 对象\n\t\t\t\t})\n\t\t\t}\n\t\t\t\n\t\t\tinput.click()\n\t\t})\n\t}\n\n\t/* 2. 微信小程序 / App：同步 API */\n\tlet res\n\ttry {\n\t\tif (isMp()) {\n\t\t\tres = wx.chooseMessageFile({\n\t\t\t\tcount: 1,\n\t\t\t\ttype: 'file'\n\t\t\t})\n\t\t} else {\n\t\t\tres = uni.chooseFile({\n\t\t\t\tcount: 1,\n\t\t\t\ttype: 'all',\n\t\t\t\textension: []\n\t\t\t})\n\t\t}\n\t} catch (e) {\n\t\treturn Promise.resolve(null)\n\t}\n\treturn Promise.resolve(res).then(r => wrapFile(r.tempFiles[0]))\n}\n\n/* 公用包装 */\nfunction wrapFile(raw) {\n  if (!raw) return null\n  const max = 500 * 1024 * 1024\n  if (raw.size > max) {\n    uni.showToast({ title: '文件不能超过 500 MB', icon: 'none' })\n    return null\n  }\n  return {\n    path: raw.path || raw.tempFilePath,\n    name: raw.name || 'unknown',\n    size: raw.size,\n    type: getFileExt(raw.name),\n    file: raw\n  }\n}\n\n/*** 选择图片（uni.chooseImage 封装）*/\nexport function pickProjectImage() {\n\tconst isH5 = () => process.env.UNI_PLATFORM === 'h5'\n\n\t// ⚡️ H5 环境：使用原生 input 获取真正的 File 对象\n\tif (isH5()) {\n\t\treturn new Promise(resolve => {\n\t\t\tconst input = document.createElement('input')\n\t\t\tinput.type = 'file'\n\t\t\tinput.accept = 'image/jpeg,image/jpg,image/png'\n\t\t\t\n\t\t\tinput.onchange = (e) => {\n\t\t\t\tconst file = e.target.files[0]\n\t\t\t\tif (!file) {\n\t\t\t\t\tresolve(null)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tconst max = 100 * 1024 * 1024\n\t\t\t\tif (file.size > max) {\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '图片不能超过 100 MB',\n\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t})\n\t\t\t\t\tresolve(null)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tresolve({\n\t\t\t\t\tpath: '',  // H5 不需要 path\n\t\t\t\t\tname: file.name,\n\t\t\t\t\tsize: file.size,\n\t\t\t\t\ttype: getFileExt(file.name),\n\t\t\t\t\tfile: file  // 原生 File 对象\n\t\t\t\t})\n\t\t\t}\n\t\t\t\n\t\t\tinput.click()\n\t\t})\n\t}\n\n\t// 微信小程序/App：同步 API\n\tlet res\n\ttry {\n\t\tres = uni.chooseImage({\n\t\t\tcount: 1\n\t\t})\n\t} catch (e) {\n\t\treturn Promise.resolve(null)\n\t}\n\n\treturn Promise.resolve(res)\n\t\t.then(res => (res.tempFiles || [])[0])\n\t\t.then(raw => {\n\t\t\tif (!raw) return null\n\n\t\t\tconst max = 100 * 1024 * 1024\n\t\t\tif (raw.size > max) {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '图片不能超过 100 MB',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t})\n\t\t\t\treturn null\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tpath: raw.path || raw.tempFilePath,\n\t\t\t\tname: raw.name || 'image.jpg',\n\t\t\t\tsize: raw.size,\n\t\t\t\ttype: getFileExt(raw.name),\n\t\t\t\tfile: raw\n\t\t\t}\n\t\t})\n\t\t.catch(() => null)\n}\n\n// 辅助函数\nfunction getFileExt(filename) {\n\tif (!filename) return ''\n\tconst parts = filename.split('.')\n\treturn parts.length > 1 ? parts.pop().toLowerCase() : ''\n}\n\n/**\n * 真正上传（内部自动区分平台）\n * @param {Number} projectId\n * @param {Object} fileInfo 上面两个函数返回的对象\n * @returns {Promise<Object>} 后端返回的文档信息\n */\nexport async function uploadProjectFile(projectId, fileInfo) {\n\tif (!fileInfo) throw new Error('未选择文件')\n\n\tconst isMp = () => process.env.UNI_PLATFORM === 'mp-weixin'\n\tconst isH5 = () => process.env.UNI_PLATFORM === 'h5'\n\n\t// 小程序走 uploadFile\n\tif (isMp()) {\n\t\treturn request.upload(\n\t\t\t`/api/v1/project/projects/${projectId}/documents/upload`,\n\t\t\tfileInfo.path, {\n\t\t\t\tname: 'file',\n\t\t\t\tformData: {\n\t\t\t\t\tfilename: fileInfo.name\n\t\t\t\t},\n\t\t\t\thideLoading: true\n\t\t\t}\n\t\t)\n\t}\n\n\t// H5 使用原生 fetch 上传\n\tif (isH5()) {\n\t\tconst fd = new FormData()\n\t\tfd.append('file', fileInfo.file)\n\t\t\n\t\tconst token = uni.getStorageSync('token')\n\t\t\n\t\tconst response = await fetch(`${BASE_URL}/api/v1/project/projects/${projectId}/documents/upload`, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t'Authorization': token ? `Bearer ${token}` : ''\n\t\t\t},\n\t\t\tbody: fd\n\t\t})\n\t\t\n\t\tif (!response.ok) {\n\t\t\tconst error = await response.json()\n\t\t\tthrow new Error(error.detail || '上传失败')\n\t\t}\n\t\t\n\t\treturn await response.json()\n\t}\n\n\t// App 走 FormData（如果需要）\n\tconst fd = new FormData()\n\tfd.append('file', fileInfo.file)\n\treturn request.post(\n\t\t`/api/v1/project/projects/${projectId}/documents/upload`,\n\t\tfd, {\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'multipart/form-data'\n\t\t\t}\n\t\t}\n\t)\n}\n\n/**\n * 获取项目文件列表\n * @param {number} projectId 项目ID\n * @param {Object} params 查询参数（可选）\n * @param {number} params.page 页码\n * @param {number} params.size 每页数量\n * @returns {Promise<Object>} 返回文件列表和总数\n */\nexport function getProjectDocuments(projectId, params = {}) {\n\treturn request.get(`/api/v1/project/projects/${projectId}/documents`, {\n\t\tparams\n\t})\n}\n\n/**\n * 下载项目文件\n * @param {number} projectId 项目ID\n * @param {string} documentId 文件ID\n * @returns {Promise<Blob|String>} H5 返回 Blob，小程序返回临时文件路径\n */\nexport async function downloadProjectFile(projectId, documentId) {\n\tconst isH5 = () => process.env.UNI_PLATFORM === 'h5'\n\tconst isMp = () => process.env.UNI_PLATFORM === 'mp-weixin'\n\t\n\t// H5 使用原生 fetch 下载\n\tif (isH5()) {\n\t\tconst token = uni.getStorageSync('token')\n\t\t\n\t\tconst response = await fetch(`${BASE_URL}/api/v1/project/projects/${projectId}/documents/${documentId}/download`, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: {\n\t\t\t\t'Authorization': token ? `Bearer ${token}` : ''\n\t\t\t}\n\t\t})\n\t\t\n\t\tif (!response.ok) {\n\t\t\tthrow new Error('下载失败')\n\t\t}\n\t\t\n\t\treturn await response.blob()\n\t}\n\t\n\t// 小程序使用 uni.downloadFile\n\tif (isMp()) {\n\t\tconst token = uni.getStorageSync('token')\n\t\t\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tuni.downloadFile({\n\t\t\t\turl: `${BASE_URL}/api/v1/project/projects/${projectId}/documents/${documentId}/download`,\n\t\t\t\theader: {\n\t\t\t\t\t'Authorization': token ? `Bearer ${token}` : ''\n\t\t\t\t},\n\t\t\t\tsuccess: (res) => {\n\t\t\t\t\tif (res.statusCode === 200) {\n\t\t\t\t\t\tresolve(res.tempFilePath)\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(new Error('下载失败'))\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tfail: (err) => {\n\t\t\t\t\treject(err)\n\t\t\t\t}\n\t\t\t})\n\t\t})\n\t}\n\t\n\t// App 平台（如果需要）\n\treturn request.get(\n\t\t`/api/v1/project/projects/${projectId}/documents/${documentId}/download`, {\n\t\t\tresponseType: 'blob'\n\t\t}\n\t)\n}\n\n/**\n * 删除项目文件\n * @param {number} projectId 项目ID\n * @param {string} documentId 文件ID\n * @returns {Promise<Object>} 返回删除结果\n */\nexport async function removeProjectFile(projectId, documentId) {\n\treturn request.delete(\n\t\t`/api/v1/project/projects/${projectId}/documents/${documentId}`\n\t)\n}\n\n\n/**\n * 批量上传项目文件\n * @param {number} projectId 项目ID\n * @param {Array} fileList 文件列表 [{file: File, name: string, size: number}, ...]\n * @returns {Promise<Object>} 返回 task_id 和任务信息\n */\nexport async function batchUploadProjectFiles(projectId, fileList) {\n\tconst isH5 = () => process.env.UNI_PLATFORM === 'h5'\n\t\n\t// H5 使用原生 fetch 上传\n\tif (isH5()) {\n\t\tconst fd = new FormData()\n\t\t\n\t\t// 添加所有文件\n\t\tfileList.forEach(fileInfo => {\n\t\t\tfd.append('files', fileInfo.file)\n\t\t})\n\t\t\n\t\tconst token = uni.getStorageSync('token')\n\t\t\n\t\tconst response = await fetch(`${BASE_URL}/api/v1/project/projects/${projectId}/documents/batch-upload`, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t'Authorization': token ? `Bearer ${token}` : ''\n\t\t\t},\n\t\t\tbody: fd\n\t\t})\n\t\t\n\t\tif (!response.ok) {\n\t\t\tconst error = await response.json()\n\t\t\tthrow new Error(error.detail || '批量上传失败')\n\t\t}\n\t\t\n\t\treturn await response.json()\n\t}\n\t\n\t// 小程序：逐个上传（因为小程序不支持批量上传接口）\n\t// 或者可以调用批量接口，但需要特殊处理\n\tthrow new Error('小程序暂不支持批量上传，请使用单文件上传')\n}\n\n/**\n * 查询批量上传任务状态\n * @param {string} taskId 任务ID\n * @returns {Promise<Object>} 返回任务状态信息\n */\nexport async function getTaskStatus(taskId) {\n\treturn request.get(`/api/v1/tasks/${taskId}/status`)\n}\n"],"names":["request","uni","BASE_URL"],"mappings":";;;;;AAqBO,SAAS,eAAe,MAAM;AAC7B,SAAAA,sBAAQ,KAAK,4BAA4B,IAAI;AACrD;AAMO,SAAS,cAAc;AACtB,SAAAA,cAAA,QAAQ,IAAI,0BAA0B;AAC9C;AAOO,SAAS,iBAAiB,WAAW;AAC3C,SAAOA,cAAAA,QAAQ,IAAI,4BAA4B,SAAS,EAAE;AAC3D;AAYgB,SAAA,cAAc,WAAW,MAAM;AAC9C,SAAOA,cAAAA,QAAQ,MAAM,4BAA4B,SAAS,IAAI,IAAI;AACnE;AAOO,SAAS,cAAc,WAAW;AACxC,SAAOA,cAAAA,QAAQ,OAAO,4BAA4B,SAAS,EAAE;AAC9D;AAiNsB,eAAA,kBAAkB,WAAW,UAAU;AAC5D,MAAI,CAAC;AAAgB,UAAA,IAAI,MAAM,OAAO;AAM1B;AACX,WAAOA,cAAQ,QAAA;AAAA,MACd,4BAA4B,SAAS;AAAA,MACrC,SAAS;AAAA,MAAM;AAAA,QACd,MAAM;AAAA,QACN,UAAU;AAAA,UACT,UAAU,SAAS;AAAA,QACpB;AAAA,QACA,aAAa;AAAA,MACd;AAAA,IAAA;AAAA,EAEF;AAoCD;AAUO,SAAS,oBAAoB,WAAW,SAAS,IAAI;AAC3D,SAAOA,cAAAA,QAAQ,IAAI,4BAA4B,SAAS,cAAc;AAAA,IACrE;AAAA,EAAA,CACA;AACF;AAQsB,eAAA,oBAAoB,WAAW,YAAY;AAuBpD;AACL,UAAA,QAAQC,cAAAA,MAAI,eAAe,OAAO;AAExC,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACvCA,oBAAAA,MAAI,aAAa;AAAA,QAChB,KAAK,GAAGC,qBAAQ,4BAA4B,SAAS,cAAc,UAAU;AAAA,QAC7E,QAAQ;AAAA,UACP,iBAAiB,QAAQ,UAAU,KAAK,KAAK;AAAA,QAC9C;AAAA,QACA,SAAS,CAAC,QAAQ;AACb,cAAA,IAAI,eAAe,KAAK;AAC3B,oBAAQ,IAAI,YAAY;AAAA,UAAA,OAClB;AACC,mBAAA,IAAI,MAAM,MAAM,CAAC;AAAA,UACzB;AAAA,QACD;AAAA,QACA,MAAM,CAAC,QAAQ;AACd,iBAAO,GAAG;AAAA,QACX;AAAA,MAAA,CACA;AAAA,IAAA,CACD;AAAA,EACF;AAQD;AAQsB,eAAA,kBAAkB,WAAW,YAAY;AAC9D,SAAOF,cAAQ,QAAA;AAAA,IACd,4BAA4B,SAAS,cAAc,UAAU;AAAA,EAAA;AAE/D;AASsB,eAAA,wBAAwB,WAAW,UAAU;AAgC5D,QAAA,IAAI,MAAM,sBAAsB;AACvC;AAOA,eAAsB,cAAc,QAAQ;AAC3C,SAAOA,cAAAA,QAAQ,IAAI,iBAAiB,MAAM,SAAS;AACpD;;;;;;;;;;;;"}