{"version":3,"file":"useChat.js","sources":["composables/useChat.js"],"sourcesContent":["import { ref, computed, nextTick } from 'vue'\nimport { sendMsg, likeMsg } from '@/api/chat.js'\n\nexport function useChat() {\n  /* ---------- 数据 ---------- */\n  const sessionList = ref([\n    { id: 's1', title: '入门介绍' },\n    { id: 's2', title: '行业报告' }\n  ])\n  const activeSessionId = ref('s1')\n  const messagesMap = ref({\n    s1: [\n      { id: 'm1', role: 'user', preview: '请介绍一下我们的平台' },\n      { id: 'm2', role: 'assistant', preview: '当然，这里是简介占位内容。', liked: 0 }\n    ]\n  })\n  const draft = ref('')\n  const knowledgeOptions = ref(['默认知识库', '产品资料库'])\n  const knowledgeIndex = ref(0)\n  const fileInfo = ref(null)          // {name, id}\n  const sendingId = ref('')           // 正在发送的临时 id\n\n  /* ---------- 计算 ---------- */\n  const currentMessages = computed(() => messagesMap.value[activeSessionId.value] || [])\n  const activeKnowledgeLabel = computed(() => knowledgeOptions.value[knowledgeIndex.value])\n\n  /* ---------- 方法 ---------- */\n  async function sendMessage() {\n    const content = draft.value.trim()\n    if (!content) return uni.showToast({ title: '请输入内容', icon: 'none' })\n    const tmpId = `send-${Date.now()}`\n    sendingId.value = tmpId\n    currentMessages.value.push({ id: tmpId, role: 'user', preview: content, status: 'sending' })\n    draft.value = ''\n    await nextTick(); scrollToBottom()\n    try {\n      const { data } = await sendMsg({ content, sessionId: activeSessionId.value, fileId: fileInfo.value?.id, knowledge: knowledgeIndex.value })\n      currentMessages.value.push({ id: data.msgId, role: 'assistant', preview: data.reply, liked: 0 })\n      fileInfo.value = null\n    } catch {\n      uni.showToast({ title: '发送失败，请重试', icon: 'none' })\n    } finally {\n      const idx = currentMessages.value.findIndex(m => m.id === tmpId)\n      if (idx > -1) currentMessages.value.splice(idx, 1)\n      scrollToBottom()\n    }\n  }\n  function scrollToBottom() {\n    nextTick(() => {\n      const query = uni.createSelectorQuery().in(this)\n      query.select('.chat-page__message-area').boundingClientRect()\n      query.exec(rect => {\n        if (rect[0]) uni.pageScrollTo({ scrollTop: rect[0].height + 999, duration: 0 })\n      })\n    })\n  }\n  async function likeMessage(msgId, type) {\n    const msg = currentMessages.value.find(m => m.id === msgId)\n    if (!msg || msg.liked !== 0) return\n    msg.liked = type === 'like' ? 1 : -1\n    await likeMsg(msgId, type)\n  }\n  function createSession() {\n    const id = `s-${Date.now()}`\n    sessionList.value.unshift({ id, title: '新建对话' })\n    messagesMap.value[id] = []\n    activeSessionId.value = id\n  }\n  function chooseFile() {\n    uni.chooseMessageFile({ count: 1, type: 'file' }).then(res => {\n      fileInfo.value = { name: res.tempFiles[0].name, id: `file-${Date.now()}` }\n    })\n  }\n  function removeFile() { fileInfo.value = null }\n\n  return {\n    sessionList, activeSessionId, currentMessages,\n    draft, knowledgeOptions, knowledgeIndex, activeKnowledgeLabel, fileInfo,\n    sendMessage, likeMessage, createSession, chooseFile, removeFile\n  }\n}"],"names":["ref","computed","uni","nextTick","sendMsg","likeMsg"],"mappings":";;;AAGO,SAAS,UAAU;AAExB,QAAM,cAAcA,cAAAA,IAAI;AAAA,IACtB,EAAE,IAAI,MAAM,OAAO,OAAQ;AAAA,IAC3B,EAAE,IAAI,MAAM,OAAO,OAAQ;AAAA,EAC/B,CAAG;AACD,QAAM,kBAAkBA,cAAG,IAAC,IAAI;AAChC,QAAM,cAAcA,cAAAA,IAAI;AAAA,IACtB,IAAI;AAAA,MACF,EAAE,IAAI,MAAM,MAAM,QAAQ,SAAS,aAAc;AAAA,MACjD,EAAE,IAAI,MAAM,MAAM,aAAa,SAAS,iBAAiB,OAAO,EAAG;AAAA,IACpE;AAAA,EACL,CAAG;AACD,QAAM,QAAQA,cAAG,IAAC,EAAE;AACpB,QAAM,mBAAmBA,cAAG,IAAC,CAAC,SAAS,OAAO,CAAC;AAC/C,QAAM,iBAAiBA,cAAG,IAAC,CAAC;AAC5B,QAAM,WAAWA,cAAG,IAAC,IAAI;AACzB,QAAM,YAAYA,cAAG,IAAC,EAAE;AAGxB,QAAM,kBAAkBC,cAAQ,SAAC,MAAM,YAAY,MAAM,gBAAgB,KAAK,KAAK,EAAE;AACrF,QAAM,uBAAuBA,cAAAA,SAAS,MAAM,iBAAiB,MAAM,eAAe,KAAK,CAAC;AAGxF,iBAAe,cAAc;;AAC3B,UAAM,UAAU,MAAM,MAAM,KAAM;AAClC,QAAI,CAAC;AAAS,aAAOC,cAAAA,MAAI,UAAU,EAAE,OAAO,SAAS,MAAM,QAAQ;AACnE,UAAM,QAAQ,QAAQ,KAAK,IAAK,CAAA;AAChC,cAAU,QAAQ;AAClB,oBAAgB,MAAM,KAAK,EAAE,IAAI,OAAO,MAAM,QAAQ,SAAS,SAAS,QAAQ,UAAS,CAAE;AAC3F,UAAM,QAAQ;AACd,UAAMC,cAAQ,WAAA;AAAI,mBAAgB;AAClC,QAAI;AACF,YAAM,EAAE,KAAI,IAAK,MAAMC,SAAO,QAAC,EAAE,SAAS,WAAW,gBAAgB,OAAO,SAAQ,cAAS,UAAT,mBAAgB,IAAI,WAAW,eAAe,OAAO;AACzI,sBAAgB,MAAM,KAAK,EAAE,IAAI,KAAK,OAAO,MAAM,aAAa,SAAS,KAAK,OAAO,OAAO,EAAC,CAAE;AAC/F,eAAS,QAAQ;AAAA,IACvB,QAAY;AACNF,oBAAG,MAAC,UAAU,EAAE,OAAO,YAAY,MAAM,QAAQ;AAAA,IACvD,UAAc;AACR,YAAM,MAAM,gBAAgB,MAAM,UAAU,OAAK,EAAE,OAAO,KAAK;AAC/D,UAAI,MAAM;AAAI,wBAAgB,MAAM,OAAO,KAAK,CAAC;AACjD,qBAAgB;AAAA,IACjB;AAAA,EACF;AACD,WAAS,iBAAiB;AACxBC,kBAAAA,WAAS,MAAM;AACb,YAAM,QAAQD,cAAG,MAAC,oBAAmB,EAAG,GAAG,IAAI;AAC/C,YAAM,OAAO,0BAA0B,EAAE,mBAAoB;AAC7D,YAAM,KAAK,UAAQ;AACjB,YAAI,KAAK,CAAC;AAAGA,wBAAAA,MAAI,aAAa,EAAE,WAAW,KAAK,CAAC,EAAE,SAAS,KAAK,UAAU,EAAC,CAAE;AAAA,MACtF,CAAO;AAAA,IACP,CAAK;AAAA,EACF;AACD,iBAAe,YAAY,OAAO,MAAM;AACtC,UAAM,MAAM,gBAAgB,MAAM,KAAK,OAAK,EAAE,OAAO,KAAK;AAC1D,QAAI,CAAC,OAAO,IAAI,UAAU;AAAG;AAC7B,QAAI,QAAQ,SAAS,SAAS,IAAI;AAClC,UAAMG,SAAO,QAAY;AAAA,EAC1B;AACD,WAAS,gBAAgB;AACvB,UAAM,KAAK,KAAK,KAAK,IAAK,CAAA;AAC1B,gBAAY,MAAM,QAAQ,EAAE,IAAI,OAAO,QAAQ;AAC/C,gBAAY,MAAM,EAAE,IAAI,CAAE;AAC1B,oBAAgB,QAAQ;AAAA,EACzB;AACD,WAAS,aAAa;AACpBH,wBAAI,kBAAkB,EAAE,OAAO,GAAG,MAAM,OAAQ,CAAA,EAAE,KAAK,SAAO;AAC5D,eAAS,QAAQ,EAAE,MAAM,IAAI,UAAU,CAAC,EAAE,MAAM,IAAI,QAAQ,KAAK,IAAG,CAAE,GAAI;AAAA,IAChF,CAAK;AAAA,EACF;AACD,WAAS,aAAa;AAAE,aAAS,QAAQ;AAAA,EAAM;AAE/C,SAAO;AAAA,IACL;AAAA,IAAa;AAAA,IAAiB;AAAA,IAC9B;AAAA,IAAO;AAAA,IAAkB;AAAA,IAAgB;AAAA,IAAsB;AAAA,IAC/D;AAAA,IAAa;AAAA,IAAa;AAAA,IAAe;AAAA,IAAY;AAAA,EACtD;AACH;;"}